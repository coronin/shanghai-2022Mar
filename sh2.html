<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>0606 sh listed address, since March 6th 2022</title><!-- @@ -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <!-- script src="full.json"></script -->
  <script src="shanghaifabu/map-location.json"></script><!-- ?v=0605 @@ -->
  <script src="shanghaifabu/d3.min.v3.js"></script>
  <script src="shanghaifabu/topojson.min.180.js"></script><!-- http://geojson.io -->
  <script src="shanghaifabu/sh.json"></script><!-- http://datav.aliyun.com/portal/school/atlas/area_generator -->
  <script src="shanghaifabu/sh-awesome-cn-cafe.json"></script>
  <script src="shanghaifabu/sh-river.json"></script>
  <script src="shanghaifabu/sh-lines.json"></script>
  <script>
let i; let j; const _J = {};
let As; let Ds;
const today = new Date();
const j_data_init = parseInt( document.title.split(' ')[0] );
let _today; // j.tag
let Ml; let Ms; let map;
let d3scale; let d3center; let svgWidth; let svgHeight;
let dotNotDraw = 0;
let hash; let hash2; let autoSavePNG;
let scaleChange = true;
let lastSearch;
let fontSize;
let pngBase64 = {};
let nextSpecial = '';
let lastAddrFirstTag;
let _still_in = 5;
let _mapOp = '已' + '标盒马门店';
let explode_cutoff = 5;
let explode_cutoff_max; // 每日会变化
const baseURL = window.location.toString().split('#')[0].split('?')[0];
const ms = { 3: 'march', 4: 'april', 5: 'may', 6: 'june' };
const check_choices = {
  5:'released_today', 4:'released',
  3:'districts', 2:'inB', 1:'latest_added', 0:'today',
  released_today:'当日下榜', released:'累计下榜',
  districts:'累计阳', inB:'两周阳', latest_added:'比昨日多', today:'当日阳',
  latest_added2:'三阴阳', 6:'latest_added2',
  latest_added7:'七阴阳', 7:'latest_added7',
  still_in:'计算阳', 8:'still_in',
  first_in:'首次上榜', cache14days:'两周内超7次上榜', list30times:'3月6日以来超30次上榜' };
let _check = check_choices['0'];
const centers = {
  黄浦区: [121.480694,31.219042,415000],
  徐汇区: [121.437778,31.160901,196000],
  长宁区: [121.378590,31.215582,300000],
  静安区: [121.448927,31.268736,219500],
  普陀区: [121.381162,31.264039,250000],
  虹口区: [121.486229,31.275661,280000],
  杨浦区: [121.523566,31.294815,220000],
  闵行区: [121.427945,31.107098,77000],
  宝山区: [121.381889,31.372927,90000],
  嘉定区: [121.248203,31.355204,87200],
  浦东新区: [121.612666, 31.12, 42000], // 浦东新区 121.61266647653576 31.08079112113293
  金山区: [121.24, 30.81, 70000], // 金山区 121.17171114485453 30.857028553162657
  松江区: [121.203370,31.013900,80000],
  青浦区: [121.096709,31.120809,66500],
  奉贤区: [121.529829,30.926042,82400],
  崇明区: [121.548589, 31.62, 32000] }; // 崇明区 121.54858925095525 31.669887634215034
const sh_district7 = ['黄浦区', '徐汇区', '长宁区', '静安区', '普陀区', '虹口区', '杨浦区'];
const feng0328 = ['浦东新区', '金山区', '奉贤区', '崇明区'];
// 闵行区浦锦街道、浦江镇，松江区新浜镇、石湖荡镇、泖港镇、叶榭镇
const h0603 = '{"type":"Topology","objects":{"collection":{"type":"GeometryCollection","geometries":[{"type":"Polygon","id":5683,"properties":{"_draw_type":"fill"},"bbox":[121.4573492,31.22018662,121.46030676,31.2216919],"arcs":[[0]]}]}},"arcs":[[[0,5863],[508,-2882],[632,-2981],[1885,999],[1939,842],[1062,570],[1552,444],[1553,701],[516,163],[177,1938],[41,1702],[134,2640],[-3392,-1237],[-3858,-1628],[-2749,-1271]]],"transform":{"scale":[2.957855785577251e-7,1.5054305430542477e-7],"translate":[121.4573492,31.22018662]},"bbox":[121.4573492,31.22018662,121.46030676,31.2216919]}';
const hot_addr = { // 2022-6-7 17:19
  '宝山区逸仙路1588弄': '0607',
  '静安区谈家桥路163弄': '0607',
  '静安区余姚路327号': '0607',
  '浦东新区樱花路801弄': '0607',
  '静安区广延路1188弄': '0606',
  '徐汇区永嘉路172弄': '0606',
  '徐汇区田林十一村': '0606',
  '宝山区蕰川路1498弄': '0605',
  '虹口区池沟路60弄': '0605',
  '虹口区昆明路56号': '0605',
  '宝山区乾溪一村': '0603',
  '黄浦区瑞金二路街道13街坊': 'h0603',
  '徐汇区新乐路58弄': '0603',
  '浦东新区惠南镇梅花新邨': '0602',
  '浦东新区银霄路39弄': '0602',
  '静安区武定西路1189号': '0602',
  '静安区芷江西路593弄': '0602',
  '闵行区剑川路165号': '0530',
  '浦东新区丁香路910弄': '0529',
  '松江区滨湖路585弄': '0528',
  '嘉定区永靖路898弄（北区）': '0525' };
// https://mp.weixin.qq.com/s/6Wpa0b-l7uvVjnCWPoOOng
const hema = [[121.5748153,31.2589135],[121.5103883,31.22925004],[121.5182729,31.18205297],[121.5976451,31.20785575],[121.5563448,31.12224601],[121.5225136,31.14458504],[121.5016211,31.12791167],[121.498999,31.2440261],[121.5611089,31.15809511],[121.5462189,31.22735438],[121.6472522,31.21343329],[121.4393667,31.2827739],[121.4530306,31.25844896],[121.42217,31.2301929],[121.3879519,31.20257343],[121.3684941,31.21907152],[121.4102775,31.21793785],[121.4360411,31.2439262],[121.4182474,31.24023431],[121.3923476,31.25102608],[121.4287261,31.17617742],[121.4292187,31.18754608],[121.3693221,31.18381458],[121.3737104,31.15871318],[121.4061894,31.10162039],[121.5074889,31.26336809],[121.5033633,31.33156079],[121.4869712,31.28902482],[121.5017662,31.25282014],[121.4932635,31.25072464],[121.4997707,31.2628089],[121.226673,31.01844685],[121.2235835,31.03321959],[121.3590507,31.25587509],[121.2490409,31.37539705],[121.233687,31.39227851],[121.4942541,31.21158453],[121.4631458,31.20889912],[121.4775108,31.19965454],[121.4805197,31.32139787],[121.4093889,31.27168926],[121.4884332,31.18490486],[121.4773024,31.40681001],[121.5511121,31.24615933],[121.4873646,31.17560291],[121.6927061,31.2002467],[121.5010624,31.08565963],[121.4195113,31.41647298],[121.4073256,31.15329276],[121.5039216,31.29858181],[121.5869616,31.31427115],[121.4904132,31.3744577],[121.5314232,31.29106565],[121.4788982,31.21925303],[121.344792,31.15781547],[121.4154315,31.25693609],[121.6064421,31.28429899],[121.587199,31.29797721],[121.4390228,31.3240311],[121.3166346,31.24386362],[121.4511815,31.18394335],[121.2262593,31.10654376],[121.4579633,30.93219902],[121.5076966,31.21344094],[121.3124985,31.14811368],[121.5594808,31.16218561],[121.1595643,30.88819776],[121.5386392,31.27994061],[121.3562918,31.13529932],[121.4176729,31.30485082],[121.4708876,31.28574973],[121.5202505,31.16292065],[121.6036408,31.26893049]];
  // https://www.freshhema.com
const schs = [[121.4980327,31.29365392],[121.506069,31.30437979],[121.5009624,31.29430965],[121.5128523,31.29274108],[121.5030674,31.30945563],[121.5355357,31.29388783],[121.5339969,31.2889038],[121.5372746,31.30245978],[121.5282801,31.292412],[121.5388575,31.28644295],[121.5246958,31.32313589],[121.5363434,31.30776819],[121.5211138,31.26079038],[121.5400567,31.28484455],[121.5335195,31.32466161],[121.5027768,31.27664047],[121.5115732,31.27880803],[121.6666562,31.29184849],[121.5048251,31.2867386],[121.504682,31.29807999],[121.5083771,31.28277785],[121.5207642,31.27837524],[121.5161327,31.27395533],[121.5370616,31.32698572],[121.5237225,31.28918181],[121.5132081,31.28526733],[121.5230511,31.28499753],[121.5319504,31.2758112],[121.5331332,31.30927798],[121.5171275,31.30735543],[121.5306463,31.303492],[121.5317256,31.31981846],[121.48869,31.31065755],[121.5140474,31.31595772],[121.5470468,31.27676528],[121.5399477,31.26774199],[121.529707,31.26242723],[121.5521513,31.28058756],[121.5211049,31.30275602],[121.4949516,31.27892258],[121.5247859,31.27017413],[121.532247,31.26920216],[121.5443799,31.28027835],[121.4479714,31.19078849],[121.5346246,31.3227767],[121.5305578,31.32976066],[121.5192625,31.33443879],[121.4678618,31.23712564],[121.485615,31.22016104],[121.4921431,31.22588515],[121.4673675,31.21946888],[121.4917821,31.22478539],[121.4642755,31.22195543],[121.4884775,31.20684787],[121.4918776,31.2154896],[121.4884523,31.20995389],[121.4884775,31.20684787],[121.4982615,31.21994126],[121.4793916,31.21517881],[121.485615,31.22016104],[121.469064,30.95532024],[121.7126847,31.21588555],[121.4675671,31.23770812],[121.4779051,31.24007513],[121.4678618,31.23712564],[121.4979568,31.22198994],[121.4746817,31.24129553],[121.4608457,31.24198095],[121.4855741,31.23260483],[121.4633662,31.20432746],[121.4692151,31.20094504],[121.4581569,31.21632461],[121.4930286,31.21905747],[121.4695771,31.21381984],[121.4846405,31.21746353],[121.4785175,31.23704321],[121.0917803,31.13901918],[121.4823177,31.22316305],[121.4775851,31.20400292],[121.482483,31.20531794],[121.4892726,31.22545804],[121.4617042,31.22197729],[121.3588757,31.11242843],[121.4890811,31.20224623],[121.4556025,31.21748387],[121.488088,31.21335028],[121.4682451,31.21761203],[121.4647267,31.22784446],[121.4961089,31.07605648],[121.4535033,31.22469442],[121.4574614,31.21619812],[121.4581569,31.21632461],[121.4642755,31.22195543],[121.4320726,31.30323816],[121.4568761,31.26924737],[121.4333027,31.28605858],[121.4565664,31.25457409],[121.6189866,31.53611521],[121.5359685,31.67518272],[121.6945653,31.1156275],[121.4363421,30.91513301],[121.5138815,30.92697783],[121.4560612,31.28513424],[121.4560612,31.28513424],[121.4502251,31.27177023],[121.4514133,31.27603336],[121.4248632,31.22589174],[121.4424019,31.22937993],[121.4552615,31.31079603],[121.4421505,31.30886866],[121.4474176,31.31399429],[121.4389659,31.31122528],[121.434304,31.30571069],[121.449671,31.3174035],[121.4559232,31.31062297],[121.455988,31.31424883],[121.455988,31.31424883],[121.4350543,31.31691037],[121.4534437,31.32112599],[121.42964,31.31766534],[121.4334158,31.30852768],[121.4457432,31.31814963],[121.4552615,31.31079603],[121.455988,31.31424883],[121.455988,31.31424883],[121.4559232,31.31062297],[121.4338781,31.22802947],[121.4284334,31.62944145],[121.4340042,31.2771877],[121.4430495,31.2720733],[121.4464772,31.26644524],[121.4739464,31.28351896],[121.4724997,31.27643678],[121.464626,31.27369642],[121.4626336,31.27878795],[121.4727993,31.2695765],[121.4804431,31.24811325],[121.4839546,31.25105448],[121.477888,31.25427157],[103.0554908,30.02622019],[121.4882211,31.27802891],[121.497587,31.25567718],[121.5080749,31.25672024],[121.4936039,31.26145633],[121.4985557,31.25372967],[121.4781635,31.26753504],[121.4701818,31.29080709],[121.4796936,31.26225314],[121.4814475,31.27496015],[121.4812841,31.26761269],[121.4841472,31.27276805],[121.479991,31.26161716],[121.4796271,31.25801451],[121.4801014,31.28529344],[121.4951889,31.29137803],[121.4907831,31.28225041],[121.477467,31.25447001],[121.3955618,31.21253395],[121.4826922,31.26612487],[121.4892428,31.28073122],[121.5901763,31.26930742],[121.4679582,31.29630241],[121.477321,31.30094201],[121.4746854,31.30745028],[121.4706192,31.29853076],[121.4636325,31.29857624],[121.4650019,31.30444283],[121.4965245,31.40491141],[121.4136277,31.28735853],[121.3674256,31.32464849],[121.4090477,31.28392749],[121.4002111,31.28397669],[121.4056224,31.31944623],[121.3366254,31.46441379],[121.3432346,31.42829465],[121.3306632,31.48508241],[121.3592322,31.38995216],[121.3332769,31.4127768],[121.340437,31.42727434],[121.3561731,31.38526113],[121.3295795,31.48683584],[121.3370552,31.41738244],[121.3396367,31.38665102],[121.3891637,31.3171223],[121.3862298,31.31145152],[121.3680669,31.31384057],[121.3812636,31.31352882],[121.4379547,31.33787412],[121.4517607,31.33631511],[121.4834626,31.3479953],[121.4444161,31.33945644],[121.4484014,31.33505049],[121.4441098,31.33367679],[121.4405355,31.34310644],[121.4478093,31.34433727],[121.4478727,31.34075072],[121.4919388,31.39721415],[121.4961895,31.37563414],[121.4905807,31.38107102],[121.4894294,31.3853217],[121.4886441,31.37694147],[121.4920922,31.3891572],[121.4904943,31.37503196],[121.4815089,31.3695063],[121.4948359,31.38510603],[121.4804616,31.40886674],[121.4834774,31.39299151],[121.4873688,31.40860351],[121.4174051,31.41764627],[121.4219201,31.41591724],[121.4297507,31.41108567],[121.4205961,31.40972168],[121.3966546,31.45266918],[121.4519669,31.34165854],[121.4445317,31.34524314],[121.4272532,31.33029347],[121.4795829,31.34721014],[121.4480431,31.32623338],[121.4503097,31.33171005],[121.4514607,31.6652333],[121.2838328,31.76157473],[121.3923147,31.62454032],[121.4115379,31.69428104],[121.4038103,31.63692999],[121.4842948,31.62952851],[121.5267354,31.5851412],[121.5359685,31.67518272],[121.4055587,31.6259778],[121.4590256,31.61993874],[121.4065119,31.62774734],[121.4557282,31.61605422],[121.8436067,31.34491619],[121.8419484,31.34376912],[121.8405584,31.34344715],[121.3552851,31.68423854],[121.3552851,31.68423854],[121.3857213,31.62914527],[121.3857213,31.62914527],[121.4100599,31.68004003],[121.4100599,31.68004003],[121.2909224,31.82292099],[121.2949042,31.81973026],[121.4008708,31.63204016],[121.4157586,31.65236814],[121.4582262,31.62047274],[121.7028117,31.38778967],[121.6854221,31.38961376],[121.7177562,31.38730275],[121.7177562,31.38730275],[121.4338781,31.22802947],[121.4284334,31.62944145],[121.4495963,30.94024769],[121.6815376,30.92853377],[121.5213709,30.83922957],[121.6370507,30.91604641],[121.7235669,30.94089682],[121.4766795,30.91168787],[121.7281415,30.90184337],[121.7575097,30.90706054],[121.7330222,30.86467627],[121.4710447,30.83108521],[121.4675218,30.92154344],[121.2824301,31.469596],[121.5037935,30.95621361],[121.5631246,30.8635804],[121.4570039,30.86813284],[121.4629731,30.92525094],[121.4622479,30.91623303],[121.4338325,30.96340794],[121.6394686,30.96112874],[121.4868426,30.95989058],[121.5798991,30.92351873],[121.4545472,30.94450239],[121.450477,30.90342272],[121.4458301,30.90220758],[121.395762,30.96441122],[121.6082969,30.900232],[121.5017427,30.97420146],[121.4402562,30.99272603],[121.4253744,30.83492629],[121.7292165,30.89889855],[121.4409062,30.99043952],[121.4494157,30.91358858],[121.4494157,30.91358858],[121.6377643,30.95043095],[121.434541,30.9616506],[121.4777022,30.92311763],[121.4606751,30.94223483],[121.3925746,30.91015427],[121.5163963,30.92460245],[121.680743,30.92799793],[121.4247505,30.99396403],[121.538263,30.87283053],[121.4828619,30.93179564],[121.4649339,30.93174427],[121.4644401,30.92506628],[121.725832,30.94095584],[121.5129769,30.94231841],[121.6533442,30.91177641],[121.6392976,30.95059612],[121.5133295,30.96693536],[121.4516426,30.93998118],[121.4565172,30.92050856],[121.4543262,30.9144486],[121.6448578,30.92012517],[121.5154085,30.95482632],[121.4443972,30.9177798],[121.4687667,30.90859453],[121.6394007,30.90665808],[121.4572872,30.86703365],[121.5625666,30.98799184],[121.4965211,30.98975689],[121.5058119,30.82609298],[121.4422075,30.91052324],[121.4585823,30.92956642],[121.4765736,30.91291113],[121.4945454,30.91873325],[121.4524295,30.93440829],[121.5623372,30.86737314],[121.4416768,30.91509938],[121.5124291,30.95973789],[121.4578735,30.91677712],[121.4625867,30.91799704],[121.5138815,30.92697783],[121.5157768,30.92696989],[121.7176188,30.94321316],[121.6152145,30.90449883],[121.5129765,30.95449028],[121.6146555,30.9022169],[121.4366049,30.91285013],[121.4375034,30.92363612],[121.4588034,30.91511173],[121.4504586,30.90884079],[121.4868912,30.95855226],[121.4185096,30.98494675],[121.5778816,30.93036774],[121.4355673,30.91554009],[121.4387356,30.9102393],[121.4572086,30.90358341],[121.4334689,30.92231825],[121.4339495,30.96428194],[121.4904594,30.95672485],[121.5061094,30.90593029],[121.4707806,30.92330348],[121.4815422,30.92909636],[121.4413622,30.91123203],[121.6355632,30.91559235],[121.6796521,30.92790032],[121.3942048,30.9626482],[121.495754,30.99017227],[121.655452,30.9247933],[121.655452,30.9247933],[121.6409929,30.9114993],[121.7226231,30.95202131],[121.4695046,30.91991617],[121.4695046,30.91991617],[121.426569,30.83501399],[121.3948569,30.91002914],[121.5607048,30.98765992],[121.4568216,30.9078046],[121.4572975,30.90468565],[121.5389159,30.87442065],[121.5031906,30.90789166],[121.4375982,30.99159098],[121.6499077,30.91392435],[121.4695046,30.91991617],[121.454669,30.91001561],[121.454669,30.91001561],[121.4142312,31.1636352],[121.4517656,30.93743456],[121.4926566,30.92443026],[121.655452,30.9247933],[121.454669,30.91001561],[121.697474,31.19565828],[121.1506186,31.30476509],[121.2036484,31.31971099],[121.2061603,31.31906769],[121.149222,31.30389017],[121.2097665,31.28758492],[121.2097665,31.28758492],[121.2343845,31.27511503],[121.2048093,31.27652388],[121.163043,31.29415878],[121.169986,31.26427307],[121.2770125,31.39545391],[121.2623127,31.38044698],[121.2598796,31.38722341],[121.2695866,31.38596157],[121.3171825,31.25791989],[121.2889092,31.27327734],[121.3123039,31.24923074],[121.3329342,31.25890647],[121.2941775,31.27143195],[121.3079544,31.2411102],[121.3351916,31.26639919],[121.324083,31.27077808],[121.2392653,31.38117321],[121.2486927,31.39054477],[121.2508469,31.38680708],[121.2374854,31.38743069],[121.3064376,31.29753999],[121.3024374,31.30153363],[121.3069441,31.30059665],[121.3015311,31.29500807],[121.3168755,31.31579902],[121.3044471,31.30117496],[121.3201957,31.30301705],[121.237897,31.36453329],[121.1881117,31.41028334],[121.2096724,31.43422763],[121.2378943,31.36457718],[121.2428805,31.37008525],[121.4669342,31.21445172],[121.2751026,31.32621551],[121.2472369,31.34330806],[121.2476462,31.35645867],[121.2884043,31.38193449],[121.2468331,31.35768241],[121.2761692,31.32554578],[121.2482857,31.40067748],[121.228653,31.38347808],[121.2664854,31.41447511],[121.1532411,31.36605664],[121.2615543,31.3764608],[121.2278572,31.38161957],[121.2467578,31.40534501],[121.23155,31.40015962],[121.2649702,31.41514447],[121.243203,31.39327609],[121.3359742,30.73207094],[121.3300325,30.85029591],[121.3487896,30.74209233],[121.2431184,30.77787101],[121.3378297,30.75486259],[121.3917708,30.79946453],[121.3371484,30.75661814],[121.155174,30.89401298],[110.5165842,24.20628353],[121.3284418,30.84673688],[121.0139121,30.89325298],[121.0740224,30.87462707],[121.1650504,30.90057493],[121.155174,30.89401298],[121.2023524,30.89753045],[121.1711769,30.89057011],[121.1577311,30.89971274],[121.1530044,30.89047809],[121.2023524,30.89753045],[101.2644526,26.63255511],[121.4186307,31.00324462],[121.4111494,31.01251715],[121.3953982,31.01656436],[121.3656246,31.00148286],[121.3995284,31.00682411],[121.4669342,31.21445172],[121.3955618,31.21253395],[121.4149526,31.03860574],[121.5269698,31.0686985],[121.4947594,31.03189033],[121.4150686,31.00819592],[121.4057235,31.13324783],[121.4082261,31.10944549],[121.3776243,31.09125159],[121.3925447,31.06082316],[121.3595211,31.11812941],[121.3909831,31.03043244],[121.3905464,31.09772876],[121.3882605,31.09296844],[121.3939115,31.09514843],[121.399624,31.01535241],[121.3613857,31.03248073],[121.4288543,31.09333879],[121.4491042,31.04054536],[121.3848235,31.10180887],[121.4082302,31.12342267],[121.3986951,31.07237752],[121.5296311,31.05970204],[121.4616329,31.04780408],[121.4054764,31.08509764],[121.4212404,31.0089427],[121.4195201,31.00850212],[121.5296311,31.05970204],[121.3775398,31.1387312],[121.3986951,31.07237752],[121.4616329,31.04780408],[121.4037702,31.01038904],[121.4118791,31.1029518],[121.414747,31.00237458],[121.3564536,31.15557659],[121.3564536,31.15557659],[121.3468385,31.14378829],[121.3634909,31.1515586],[121.3456854,31.16779194],[121.3581595,31.15647926],[121.3776633,31.16493754],[121.3608934,31.15158654],[121.3608934,31.15158654],[121.3035713,31.20582946],[121.3481813,31.17495924],[121.3485119,31.17477412],[121.4049066,31.09577742],[121.4970345,30.99133377],[121.365748,31.13941713],[121.370438,31.16224042],[121.3786529,31.02725355],[121.4085214,31.00758861],[121.4085214,31.00758861],[121.3773688,31.11510315],[121.3613487,31.11258137],[121.3479659,31.17052971],[121.3776243,31.09125159],[121.4092802,31.09344278],[121.4670034,31.04416336],[121.4838097,31.10581975],[121.4545805,31.04586982],[121.4386492,31.10842025],[121.4045847,31.00456743],[121.4285854,31.11665438],[116.4611672,39.98793735],[121.3724232,31.12406212],[115.0405472,32.14699677],[121.3721722,31.10595968],[116.3084505,39.93846024],[121.3955618,31.21253395],[121.3955618,31.21253395],[121.5530571,31.1757161],[121.5445017,31.1837643],[121.5459276,31.17070235],[121.5629231,31.17562626],[121.5536503,31.18056054],[121.5354471,31.17314448],[121.549192,31.18561972],[121.6804067,31.26926778],[121.6627129,31.29723961],[121.6666562,31.29184849],[121.7000156,31.25583888],[121.6744349,31.2671246],[121.6550394,31.29021924],[121.6660842,31.29283041],[121.6841247,31.18507973],[121.7052399,31.18212186],[121.702278,31.20049733],[121.6860772,31.19599364],[121.6926237,31.17634798],[121.6964274,31.18856754],[121.6683444,31.19511507],[121.6913853,31.19850748],[121.6863155,31.19952748],[121.6965707,31.20518122],[121.717874,31.15619449],[121.7243287,31.15281547],[121.6654135,31.16795485],[121.539716,31.22324453],[121.6945653,31.1156275],[121.6888714,31.11830245],[121.67678,31.19267874],[121.6964857,31.1965802],[121.6841247,31.18507973],[121.6965707,31.20518122],[121.6860772,31.19599364],[121.7052399,31.18212186],[121.702278,31.20049733],[121.6283003,31.17526774],[121.615263,31.33135178],[121.6269128,31.31021458],[121.6274083,31.32022549],[121.6184816,31.32849932],[121.6136566,31.29500219],[121.6274412,31.30927252],[121.5979688,31.07982085],[121.5844229,31.05100573],[121.5909791,31.07122468],[121.5855174,31.08120649],[121.5910464,31.05205928],[121.5905434,31.07280733],[121.7143462,31.24192563],[121.7113786,31.23839327],[121.7247454,31.21647056],[121.7255325,31.21431516],[121.722131,31.23804367],[121.5763139,31.27506058],[121.5778526,31.26379222],[121.5791346,31.2787884],[121.5744299,31.2825076],[121.5776797,31.2851994],[121.5770421,31.27988808],[121.5778746,31.2875973],[121.5805033,31.2700803],[121.5741132,31.26729688],[121.5483711,31.20778848],[121.5373864,31.20526784],[121.5330475,31.21050998],[121.5585921,31.19553308],[121.5588091,31.19422276],[121.5253492,31.19223281],[121.539716,31.22324453],[121.5588091,31.19422276],[121.5269739,31.20400417],[121.5261301,31.23318459],[121.5337796,31.19738237],[121.7711977,31.06198177],[121.7544326,31.04660736],[121.7548282,31.05437157],[121.7573996,31.04652791],[121.736116,31.06938895],[121.7568756,31.08186817],[121.7434954,31.04933738],[121.7759442,31.02552214],[121.6928273,31.18906989],[121.7385167,31.06997069],[121.739242,31.04688896],[121.7624611,31.04565675],[121.7704186,31.06352284],[121.7626826,31.04905758],[121.7626412,31.04813033],[121.7759486,31.05491696],[121.5888484,31.25434351],[121.539716,31.22324453],[121.5579174,31.25039638],[121.5668971,31.24136014],[121.5643338,31.26979145],[121.5749221,31.25410691],[121.5751061,31.24838545],[121.5541425,31.24957384],[121.5664015,31.26167752],[121.5722844,31.25055294],[121.5809827,31.25092247],[121.5713202,31.24526761],[121.562734,31.24168619],[121.5139417,31.2279966],[121.5873698,31.29514936],[121.9101871,30.91793175],[121.6184816,31.32849932],[121.7520755,31.11349857],[121.5503985,31.12336996],[121.5681699,31.12531785],[121.7544326,31.04660736],[121.7548282,31.05437157],[121.7573996,31.04652791],[121.7759442,31.02552214],[121.6402096,31.07442924],[121.7384721,30.96917716],[121.8605937,30.93001154],[121.8656736,30.98605149],[121.6981977,31.01800976],[121.7089054,31.07342378],[121.9155031,30.88620703],[121.7568756,31.08186817],[121.5880983,31.26681015],[121.5948683,31.2664515],[121.6180826,30.92176108],[121.5896572,31.27382712],[121.5903296,31.28048755],[121.5969221,31.26799608],[121.5841916,31.26103357],[121.4901283,31.1759089],[121.4801021,31.17133263],[121.4855968,31.17016571],[114.3482001,30.5338579],[121.4859773,31.17492254],[121.480358,31.17435041],[121.4033212,31.16297755],[121.6703283,31.24290653],[121.6605374,31.20612058],[121.6506712,31.20907776],[121.6702823,31.23601824],[121.648609,31.22161486],[121.5163667,31.21506006],[121.5075978,31.12631107],[121.5101986,31.20964906],[121.5183733,31.21176605],[121.8187879,30.96932936],[121.7384721,30.96917716],[121.7367096,30.9751296],[121.7497815,30.99454698],[121.7374985,30.9713789],[121.511023,31.2368156],[121.5220012,31.22597809],[121.5565875,31.2561218],[121.5177117,31.22043843],[121.5261301,31.23318459],[121.5269739,31.20400417],[121.5205752,31.22582852],[121.6400579,31.01991879],[121.6402096,31.07442924],[121.6444793,31.02755111],[121.6410501,31.02465593],[121.6450288,31.07642123],[121.6070285,31.19982424],[121.6283003,31.17526774],[121.3955618,31.21253395],[121.583391,31.19615298],[121.5899458,31.20416818],[121.6240178,31.20084366],[121.6153845,31.22199179],[121.539716,31.22324453],[121.6177124,31.20785531],[121.5897307,31.20326228],[121.6309937,31.20196322],[121.5741378,31.11212611],[121.5859142,31.12413949],[121.6551625,31.11215562],[121.5782472,31.12018104],[121.5722775,31.12515524],[121.5805494,31.11250103],[121.5749959,31.11110104],[121.5925055,31.09412414],[121.5876675,31.12388063],[121.752751,31.10406028],[121.7422266,31.14618106],[121.7496291,31.17698286],[121.7495143,31.12686789],[121.8082968,31.09280899],[121.745741,31.14604583],[121.7393073,31.17610575],[121.7489594,31.15308246],[121.7436932,31.18062201],[121.7520755,31.11349857],[121.7614889,31.08378283],[121.5518085,31.2465329],[121.5523916,31.2086869],[121.5163667,31.21506006],[121.5664015,31.26167752],[121.4046398,31.2149363],[121.5888484,31.25434351],[121.5330475,31.21050998],[121.5109828,31.18955753],[121.6154034,31.28400547],[121.589954,31.27269198],[121.5588772,31.24239405],[121.5604712,31.24394974],[121.5431662,31.23156009],[121.5645891,31.2651836],[121.6453194,31.0241581],[121.615263,31.33135178],[121.5418209,31.236352],[121.5525414,31.22771747],[121.5909791,31.07122468],[121.6180826,30.92176108],[121.5541425,31.24957384],[121.5530571,31.1757161],[121.5253492,31.19223281],[121.5483711,31.20778848],[121.6309937,31.20196322],[121.5373864,31.20526784],[121.7495143,31.12686789],[121.5228516,31.22158889],[121.5075019,31.22982579],[121.5220012,31.22597809],[121.4949956,31.12586246],[121.5457942,31.24502746],[121.5177117,31.22043843],[121.4845742,31.32114369],[121.5269739,31.20400417],[121.4011018,31.2450781],[121.3958194,31.24215111],[121.4011747,31.23768753],[121.4157912,31.24648839],[121.4050566,31.13417713],[121.4057009,31.23920934],[121.4022471,31.24318765],[121.4075662,31.23997445],[121.4033629,31.23779068],[121.4011018,31.2450781],[121.3958194,31.24215111],[121.4011747,31.23768753],[121.4057009,31.23920934],[121.4075662,31.23997445],[121.4022471,31.24318765],[121.4033629,31.23779068],[113.2655186,23.20365632],[109.3455569,36.27662718],[121.4313843,31.26520725],[121.4270399,31.26127858],[121.4232415,31.26314072],[121.4325093,31.26937055],[121.4278853,31.26506343],[121.425795,31.2727707],[121.4349291,31.26805224],[121.4305676,31.26903129],[121.4245578,31.26115956],[105.1610757,33.4414563],[121.4086833,31.22665273],[117.6859641,49.46331207],[121.3974521,31.23706799],[121.4086833,31.22665273],[121.3937772,31.23032557],[108.2434444,33.04025464],[121.4220777,31.25919674],[121.4209368,31.25360333],[121.4190469,31.25866681],[121.4235072,31.25099888],[121.4179951,31.24831422],[121.4204644,31.2510474],[121.4157912,31.24648839],[121.418992,31.25097206],[104.8959465,35.55989725],[121.3583599,31.28089509],[121.3476384,31.28437229],[121.3500141,31.28899406],[121.3825179,31.29383267],[121.3749689,31.25994004],[121.3809852,31.25950868],[121.3420676,31.28756995],[121.3465743,31.286624],[121.3396278,31.2912933],[121.3583599,31.28089509],[121.6489645,25.17622746],[121.3931647,31.27387866],[121.3945539,31.27874897],[121.4145126,31.26612916],[121.4039873,31.26596776],[121.400345,31.27388641],[110.1635035,36.05010105],[121.4403141,31.26365983],[121.4415389,31.26016996],[121.4313155,31.26133586],[121.431346,31.25364813],[121.4253669,31.2543381],[121.436793,31.26518211],[121.4429986,31.25665051],[113.2655186,23.20365632],[117.226563,30.5729233],[117.6859641,49.46331207],[121.4115634,31.23168394],[121.3974521,31.23706799],[121.4086833,31.22665273],[121.3937772,31.23032557],[117.226563,30.5729233],[107.076535,29.86016962],[121.4309798,31.24146984],[121.4479714,31.19078849],[121.4319527,31.24916039],[121.4191105,31.24410408],[121.4189505,31.24210009],[121.4261758,31.23892911],[114.6730091,38.34542466],[123.2043685,41.19762668],[121.3628841,31.24660539],[121.4050566,31.13417713],[121.3721355,31.24036967],[121.354634,31.23932682],[121.3734755,31.25021776],[121.3895906,31.24356566],[121.3666215,31.24106463],[121.3782766,31.24348755],[121.3903819,31.25721101],[113.4217283,32.3810879],[121.3588757,31.11242843],[121.3840217,31.25698512],[121.3871661,31.25208447],[121.3913817,31.25907139],[121.3997643,31.25033034],[121.3945804,31.25921751],[121.3830328,31.25999868],[121.374956,31.25416414],[121.3815417,31.25209562],[121.4694778,31.23194382],[121.390701,31.26719976],[121.3964662,31.25872234],[121.2285509,31.24475314],[121.2232406,31.21016564],[121.2312481,31.18818187],[120.9182093,31.03825619],[120.9213072,31.0358813],[120.9201028,31.03471502],[120.9199343,31.11957786],[120.9859551,31.05468992],[120.9209695,31.03485069],[120.9228882,31.12218832],[120.9611847,31.07098882],[120.9182093,31.03825619],[121.0917803,31.13901918],[121.1194014,31.15159389],[121.0932768,31.14333472],[121.0907115,31.15267418],[121.1194014,31.15159389],[121.0889185,31.16938594],[121.0896857,31.16841272],[121.1194014,31.15159389],[121.087653,31.16898221],[121.087653,31.16898221],[121.049688,31.10739271],[121.2772372,31.19288951],[121.1044238,31.16157583],[121.2300057,31.03368472],[121.3087571,31.14037226],[121.2263215,31.01078281],[121.312378,31.0613785],[121.1973307,31.04271282],[121.3102764,31.14682218],[121.3389082,31.11715863],[121.218642,31.00962562],[121.2400856,31.03478894],[121.2331158,31.03737208],[121.2413753,31.01185578],[121.2250726,31.0134632],[121.2090266,31.00628973],[121.1758091,30.9683728],[121.212577,30.93307432],[121.1123496,30.98677119],[121.1331526,30.9401466],[121.054025,30.93928604],[121.220261,31.02110059],[121.1768932,31.09982869],[121.3111469,30.9392988],[121.1398823,31.06969983],[121.1996717,31.00968088],[121.3536205,31.22433492],[121.1804768,31.01488253],[121.2369489,31.0076088],[121.2108433,31.00862937],[121.2445388,31.00727353],[121.229924,31.11253169],[121.339317,31.08846711],[121.2519693,31.06164094],[121.4260934,31.22487616],[121.4184204,31.22670159],[121.3762365,31.19329805],[121.3588685,31.21293521],[121.3883061,31.21020407],[121.4289998,31.20628722],[121.4289998,31.20628722],[121.4268855,31.20429136],[121.36513,31.21539727],[121.3614596,31.21917956],[121.3564983,31.21370256],[121.4268855,31.20429136],[121.4118331,31.20203753],[121.3920878,31.21092364],[121.391181,31.21149886],[121.4213877,31.219345],[121.4303682,31.22327735],[121.4224179,31.22817452],[121.4118331,31.20203753],[121.4026297,31.220622],[121.3834408,31.21143677],[121.3835464,31.20503571],[121.3800714,31.21048648],[121.4323517,31.20279927],[121.4894509,31.1269627],[121.4495633,31.15967845],[121.4373214,31.17390553],[121.4596751,31.20321405],[121.4601466,31.19725258],[121.3273564,31.83114495],[121.449106,31.157932],[121.446231,31.17316494],[121.4490323,31.17799649],[121.4199391,31.13372464],[121.4135567,31.13925162],[121.4191622,31.13980433],[121.4149755,31.13241371],[121.4247951,31.13371666],[121.4471554,31.19213191],[121.4323517,31.20279927],[121.4407636,31.17863897],[121.4298751,31.14898559],[121.4242496,31.16227352],[121.4104106,31.1520265],[121.4760653,31.2075563],[121.4133173,31.15291649],[117.721127,49.45245424],[121.409072,31.15628906],[121.422022,31.15777585],[121.4088664,31.14888234],[121.4335371,31.16489291],[121.4237689,31.16693094],[121.4063677,31.15255783],[121.452136,31.21329741],[121.4514467,31.20999847],[121.4488974,31.21972712],[121.44443,31.21257452],[121.4524798,31.20961496],[121.4556323,31.21022123],[121.4389865,31.20744542],[121.4549973,31.214683],[121.4351288,31.20961908],[121.4378734,31.21500218],[121.4559624,31.19444666],[121.4148477,31.17639455],[121.4188185,31.17201562],[121.4248517,31.17505012],[121.4161168,31.17267368],[121.4149684,31.18055556],[121.4227783,31.17285271],[121.422083,31.17869817],[121.4178265,31.19384553],[121.3966872,31.15870356],[121.431357,31.19404754],[121.442635,31.1968904],[121.4517811,31.19110972],[121.4384588,31.19329438],[121.4283422,31.18998197],[121.4464335,31.18527816],[121.4411827,31.18781336],[121.4339235,31.18543583],[121.4229833,31.19402177],[121.4244452,31.19785918],[121.4404909,31.14420441],[121.4318296,31.15222696],[121.4280691,31.13959091],[121.4342863,31.13240731],[121.4505114,31.11466564],[121.4393444,31.11997994],[121.4493471,31.11871638],[121.4315656,31.1402796],[121.4365008,31.14353093],[121.4333464,31.13555527],[121.4392739,31.136663],[121.4424838,31.13382951],[121.4336783,31.15085566],[121.4473504,31.12821786],[121.4564168,31.12456566],[121.4485852,31.1396836],[121.4385476,31.13554425]];
  // https://www.eol.cn/html/zhongxue/shzxx/
const collg = [[121.4980327,31.29365392],[121.4669342,31.21445172],[121.2097665,31.28758492],[121.3955618,31.21253395],[121.3536205,31.22433492],[116.336372,39.95821592],[121.4191598,31.14518747],[121.697474,31.19565828],[121.3891637,31.3171223],[121.4775586,31.30602486],[121.8955605,30.88200681],[121.5214511,31.31519517],[121.4479714,31.19078849],[121.3588757,31.11242843],[121.5532685,31.29409767],[121.5645891,31.2651836],[121.4120275,31.22858093],[121.4510644,31.20437838],[121.887516,30.90442839],[121.5296537,31.22796856],[121.5106801,31.24165876],[121.4405862,31.18543208],[121.483371,31.29705292],[121.213037,31.04843006],[121.5062065,30.844978],[121.2861052,31.179648],[121.5738531,31.17095894],[121.1684133,31.11301562],[121.5341456,31.23764383],[121.8813196,30.89068267],[121.6080245,31.09989095],[121.4334972,31.25881448],[121.5149397,31.38227245],[121.6548265,31.2709029],[121.888027,30.89397721],[121.2015439,31.04832498],[121.316597,30.93800002],[121.7825439,31.04498407],[121.300261,30.80006784],[121.8282345,31.48678605],[116.1308115,30.47229056],[121.4514863,31.17330051],[121.5078771,30.83551088],[121.2535952,31.38873315],[121.5385129,31.28530209],[121.4765645,31.24925466],[121.4245764,31.26751606],[121.5630245,31.26499076],[121.483989,31.3940218],[121.4270048,31.28204238],[121.1672833,30.89752549],[121.2476616,31.41012928],[121.4908091,31.28819526],[121.2166382,31.25061012],[121.4527207,31.0318786],[121.6928686,30.87528404],[121.7769925,31.04977046],[121.3548876,31.41422404],[121.3973049,31.32490107],[121.495467,31.30314043],[121.6558259,31.20057716],[121.7763444,31.03970671],[121.5808951,31.19396683],[121.4229772,31.20227089],[121.5040607,31.26686799],[121.449038,31.31035463],[121.4741035,31.27628252],[121.456861,31.19772799],[121.4958256,31.25638074],[121.4864986,31.23266674],[121.3873347,31.2050608],[121.5217639,31.32657023],[121.4588896,31.20935485],[121.4187722,31.2145573],[121.2482756,31.37951797],[121.408187,31.24257444],[121.4849181,31.25059643],[121.4834897,31.39400685]];
  // https://zh.wikipedia.org/

function trim (s) { return (s || '').replace(/^\s+|\s+$/g, ''); }

function bubble2 (arr, b2 = 1) {
  let done = false; let tmp;
  while (!done) {
    done = true;
    for (i = 1; i < arr.length; i += 1) {
      if (arr[i - 1][b2] < arr[i][b2]) {
        done = false;
        tmp = arr[i - 1];
        arr[i - 1] = arr[i];
        arr[i] = tmp;
      }
    }
  }
}

function jtagOffset (dd) {
  let d = parseInt(j.tag) - dd;
  if ((d > 331 && d <= 400) ||
      (d > 531 && d <= 600) ) {
    // 401-14=387(318), 414-14=400(331)
    // 331+1=332(401), 531+1=532(601)
    if (dd > 0) {
      d -= 69;
    } else {
      d += 69; }
  } else if ((d > 430 && d <= 500) ||
             (d > 630 && d <= 700) ) {
    // 514-14=500(430), 501-14=487(417)
    if (dd > 0) {
      d -= 70;
    } else {
      d += 70; }
  }
  return d;
}

async function asyncPopulateStill () {
  const v = await cacheList().catch(e => {
    return console.log(e);
  });
  if (v) {
    const v2 = await populateStill(_still_in).catch(e => {
      return console.log(e);
    });
    if (!v2) {
      window.alert('无法计算最近' + _still.value + '阳');
      _still_in = 5;
      _still.value = 5;
    }
  } else {
    window.alert('数据有错 请刷新页面\n' + window.location.toString() );
    return false;
  }
}

function populateStill (days) {
  return new Promise(resolve => {
    if (!days || days > 14) {
      resolve(0);
      return;
    }
    if (j['still_in' + days]) {
      j.still_in = j['still_in' + days];
      _still.value = days;
      resolve(1);
      return;
    }
    j['still_in' + days] = {};
    const s0 = jtagOffset(days);
    let s1;
    for (const p in j.inB) {
      j['still_in' + days][p] = [];
      j.inB[p].forEach((d) => { //Array.from(
        if (j.address[d]) {
          s1 = j.address[d].join(',');
          if (s1.indexOf(p) > 3) {
            if (parseInt(s1.substr(s1.lastIndexOf(p) - 4, 4)) > s0) {
              j['still_in' + days][p].push([d,
                parseInt(s1.substr(s1.lastIndexOf(p) - 4, 4)) ]);
            }
          } else if (parseInt(j.address[d].slice(-1)[0].substr(0,4)) > s0) {
            s1 = -1;
            while (j.address[d].slice(s1)[0] &&
                   j.address[d].slice(s1)[0].length > 4) {
              s1 -= 1;
            }
            if (j.address[d].slice(s1)[0] &&
                parseInt(j.address[d].slice(s1)[0]) > s0) {
              j['still_in' + days][p].push([d,
                parseInt(j.address[d].slice(s1)[0]) ]);
            }
          }
        }
      });
      bubble2( j['still_in' + days][p] );
    }
    j.still_in = null;
    _J[j.tag] = j;
    j.still_in = j['still_in' + days];
    _still.value = days;
    resolve(1);
  });
}

async function async7in14 (k) {
  if (!j.cache14days) {
    await cacheList().catch(e => {
      return console.log(e);
    });
  }
  let ki = 0;
  const kk = document.createElement('p');
  const tt = '两周内超7次上榜';
  if (j.cache14days && k && j.cache14days[k]) {
    kk.innerHTML = '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);' +
                   'draw_sh_addr(j.cached_14days,\'' +
                   k + tt + '\');">展示' + k + tt + '地址</button> ' +
                   '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);draw_sh_addr(null,\''+k+'两周阳\');' +
                   '">两周内曾上榜至少1次</button> ' +
                   '<button onclick="h2dist.scrollIntoView();">各区统计</button>';
    onList.appendChild(kk);
    j.cache14days[k].forEach((d) => { //Array.from(
      ki += 1;
      onListAppend(ki, k, d[0],
                 '两周内' + d[1] + '次上榜');
    });
  } else if (j.cached_14days && !k) {
    kk.innerHTML = '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);' +
                   'draw_sh_addr(j.cached_14days,\'' +
                   '上海市' + tt + '\');">展示' + tt + '地址</button> ' +
                   '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);draw_sh_addr();' +
                   '">两周内曾上榜至少1次</button> ' +
                   '<button onclick="h2dist.scrollIntoView();">各区统计</button>';
    onList.appendChild(kk);
    ki = _check;
    _check = 'cache14days';
    generalAppend();
    _check = ki;
  } else {
    onListAppend(' ', (k || '上海市'), null, '无超7次的');
  }
}

// function firstSince0306 () {
//   return new Promise(resolve => {
//     const adds = [];
//     let kii;
//     for (const p in j.address) {
//       if (j.address[p].length === 1 && j.address[p][0].substr(0,4) === j.tag) {
//         if (addr.value === '上海市') {
//           if (j.address[p][0].length > 4) {
//             adds.push([j.address[p][0].substr(4), p,
//                        99-Ds.indexOf(j.address[p][0].substr(4))]);
//           } else {
//             for (kii = 0; kii < Ds.length; kii += 1) {
//               if (j.districts[ Ds[kii] ].indexOf(p) > -1) {
//                 break;
//               }
//             }
//             adds.push([Ds[kii], p, 99-kii]);
//           }
//         } else { //各区
//           if (j.address[p][0].length > 4 && j.address[p][0].substr(4) === addr.value) {
//             adds.push([addr.value, p]);
//           } else if (j.address[p][0].length === 4 &&
//                      j.districts[ addr.value ] && j.districts[ addr.value ].indexOf(p) > -1) {
//             adds.push([addr.value, p]);
//           }
//         }
//     } }
//     bubble2(adds, 2);
//     resolve(adds);
//   });
// }

async function asyncFirstSince0306 (k) {
  if (!j.first_in) {
    await cacheList().catch(e => {
      return console.log(e);
    });
  }
  let ki = 0;
  if (k) {
    if (j.first_in[k]) {
      j.first_in[k].forEach((d) => { //Array.from(
        ki += 1;
        onListAppend(ki, k, d,
                     '3月6日以来 首次上榜');
      });
    } else {
      onListAppend(' ', k, null, '无');
    }
  } else {
    Ds.forEach((k) => {
      if (j.first_in[k]) {
        ki += j.first_in[k].length;
      }
    });
    if (ki < 100) {
      ki = 0;
      Ds.forEach((k) => {
        if (j.first_in[k]) {
          j.first_in[k].forEach((d) => { //Array.from(
            ki += 1;
            onListAppend(ki, k, d,
                         '3月6日以来 首次上榜');
          });
        } else {
          onListAppend(' ', k, null, '无');
        }
      });
    } else {
      ki = _check;
      _check = 'first_in';
      generalAppend();
      _check = ki;
    }
  }
}

async function fetch2 () {
  const response = await fetch("shanghaifabu/early0306.json");
  return await response.json();
}
const _m0f0 = {};
fetch2().then(e36 => {
  console.log('fetch2, async early', e36.version);
  // for (const [key, value] of Object.entries(e36.by_day)) {
  //   console.log(key, value.length);
  // }
  let m9 = 0; let f9 = 0; // total count
  let d9 = 0; let d0 = 999;
  for (const [k, v] of Object.entries(e36.by_address)) {
    // if (!Ml.locations.get(k)) {
    //   console.log(k, v.length);
    // } else {
      const m0f0 = {};
      m0f0.count = 0;
      m0f0.d = k.substr(k.indexOf('区')+1);
      m0f0.k = k.substr(0, k.indexOf('区')+1);
      m0f0.male = [];
      m0f0.female = [];
      v.forEach((d) => {
        if (parseInt(d[0]) > d9) {
          d9 = d[0];
        }
        if (parseInt(d[0]) < d0) {
          d0 = d[0];
        }
        if (d[1] === '男') {
          m0f0.male.push([d[0], d[2]]); // date, age
          m9 += 1;
        } else if (d[1] === '女') {
          m0f0.female.push([d[0], d[2]]);
          f9 += 1;
        } else {
          console.log(k, v);
        }
        m0f0.count += 1;
      });
      m0f0.dates = [...new Set(m0f0.male.map((d) => d[0]).concat(
                   m0f0.female.map((d) => d[0]) ))];
      m0f0.ages = m0f0.male.map((d) => d[1]).sort((u,v) => u - v).concat(
                  m0f0.female.map((d) => d[1]).sort((u,v) => u-v) );
      m0f0.sex = '男' + m0f0.male.length + '女' + m0f0.female.length;
      _m0f0[m0f0.d] = m0f0;
      //if (m0f0.count > explode_cutoff) console.log('早期多人', k, m0f0);
    // }
  }
  sets_label.textContent = d0+'~'+d9 + ' 男'+m9+' 女'+f9;
}).catch(err => console.log('fetch2', err));

async function fetch1 () {
  const response = await fetch("shanghaifabu/inAB-close.json");
  return await response.json();
}
let W; let _ww;
fetch1().then(jsondata => {
  W = jsondata;
  _ww = Object.keys(W.pairs);
  console.log('fetch1, async pairs', _ww.length);
}).catch(err => console.log('fetch1', err));

function init_ks (k, d, num, dl, t) {
  if (!dl) dl = dldl(k, d);
  let ks;
  if (j.listed_30times_long && k && d && j.listed_30times_long.indexOf(k + d) > -1 &&
      dl.length >= 30 && (!t || t.indexOf('上榜') === -1) ) {
    ks = '<span style="color:red;">' + num + '.<sup>上榜' +
         dl.length + '次</sup>';
  } else {
    ks = '<span class="em">' + num + '.';
  }
  if (_m0f0[j.tag + 'cut' + explode_cutoff] &&
      _m0f0[j.tag + 'cut' + explode_cutoff].indexOf(k + d) > -1) {
    ks += '<sup style="background-color:red;color:white;">上榜早</sup>';
  }
  ks += '</span> ';
  return ks;
}

function kd_related_ww (k, d) {
  let ks = '';
  const wdl = W.pairs[k + d];
  let dl0; let dl1; let dlt = true;
  //if (dl.length > 4) {
  //  console.log(_ww.length, '超过4个临近地址', Ds[ii] + As[i]);
  //  console.log(dl.join('\n'));
  //}
  wdl.forEach((dd) => {
    if (dd.substr(0,4) === '浦东新区') {
      dl0 = dd.substr(0, 4);
      dl1 = dd.substr(4);
    } else {
      dl0 = dd.substr(0, 3);
      dl1 = dd.substr(3);
    }
    if (dl1 !== d) {
      if (dlt) {
        dlt = false;
        if (d3scale > 1000000) {
          ks += '<br/><span class="inAB_close_click" onclick="draw_grey(\'' +
                k + d + '\',this);">临近地址 '; // W.within
        } else {
          ks += '<br/><span class="inAB_close" style="padding-left:1.6em">临近地址 ';
        }
      } else {
        ks += '<br/><span class="inAB_close">';
      }
      if (dl0 !== k) {
        ks += '<span class="click" onclick="search(this.textContent);">' +
            dl0 + '</span> ';
      }
      if (tagsHTML(dldl(dl0, dl1), 1) !== '') {
        ks += '<span class="click" onclick="search(this.textContent);">' +
            dl1 + '</span> 上榜于' +
            tagsHTML(dldl(dl0, dl1), 1) +
            '</span>';
      } else {
        ks += '<span class="click" onclick="updateLocation(j_data_init, this.textContent);">' +
            dl1 + '</span><!-- 上榜 --></span>';
      }
    }
  });
  return ks;
}

function onListAppend (ki, k, d, t) {
  let ks;
  if (!ki) { ks = '<br/>';
  } else {   ks = init_ks(k, d, ki, null, t); }
  if (k) {
    ks += '<span class="click" onclick="scaleChange=true;search(this.textContent);">' +
        k + '</span>';
  }
  if (d) {
    ks += '<span class="click _L" onclick="scaleChange=true;search(\'' + d +
        '\');">' + d + '</span> ';
  }
  if (t && t.indexOf('上榜后') > 1) { // _m0f0
    const dl = dldl(k, d);
    ks += ' ' + tagsHTML([ dl[0] ]) + '<span class="em"';
    if (t.indexOf('|') > 1) {
      let ti0 = parseInt( t.substr(1,2) );
      const ti1 = t.indexOf(',');
      let ti2 = ti1;
      while (ti0 > 1) {
        ti2 = t.indexOf(',', ti2+1);
        ti0 -= 1;
      }
      if (ti2 > 0) {
        ks += '>' + t.substr(0, ti2) + ';' + t.substr(ti2 + 1);
      } else {
      ks += '>' + t; }
    } else {
      ks += '>' + t;
    }
    ks += '</span>' + tagsHTML(dl.slice(1) );
    if (_ww && _ww.indexOf(k + d) > -1) {
      ks += kd_related_ww(k, d);
    }
  } else {
    ks += ' <em>' + (t || '') + '</em>';
    if (k && d && (!t || (t.indexOf('首次') === -1 &&
                          t.indexOf('最近') === -1 &&
                          t.indexOf('不在') === -1 ))) {
      ks += ' ' + tagsHTML(dldl(k, d));
    }
  }
  const kk = document.createElement('p');
  kk.innerHTML = ks;
  onList.appendChild(kk);
  // if (['inB', 'districts'
  //     ].indexOf(_check) > -1 && Ms.indexOf(k + d) > -1) {
  //   console.log(k,d);
  //   map.fillStyle = 'rgb(0,0,0)';
  //   map.beginPath();
  //   map.arc(mapX( Ml.locations[k + d][0] ),
  //           mapY( Ml.locations[k + d][1] ),
  //           3, 0 * Math.PI, 2 * Math.PI);
  //   map.stroke();
  // }
  // map.fillText(ki,
  //   mapX( Ml.locations[k + d][0] ),
  //   mapY( Ml.locations[k + d][1] ) );
  // console.log(ki, k+d);
}

function cacheList () {
  return new Promise(resolve => {
    if (!j.list30times) {
      console.time('>> cache lists ' + j.tag);
      j.list30times = {};
      j.listed_30times_long = [];
      j.first_in = {};
      j.cache14days = {};
      j.cached_14days = [];
      ////if (parseInt(j.tag) > 405) { // 清明假
      j.today = {};
      j.inB = {};
      j.released = {};
      j.released_today = {};
      j.latest_added = {};
      j.latest_added2 = {};
      j.latest_added7 = {};
      ////}
      let j30; let _j30;
      let j0; let jFirst; let j7neg; let j3neg; let j1neg;
      let jA; let jA0; let jB;
      let j14; let _j14;
      Ds.forEach((k, ind) => {
        loading_pr.textContent =  (84 + ind) + '%';
        loading_pr2.textContent = (84 + ind) + '%';
        let kj; let kjj;
        j30 = []; _j30 = [];
        j0 = []; jFirst = []; j7neg = []; j3neg = []; j1neg = [];
        jA = []; jA0 = []; jB = [];
        j14 = []; _j14 = [];
        j.districts[k].forEach((d) => { //Array.from(
          kj = dldl(k, d);
          // .inB   (j.tag + 13)
          // .released
          // .released_today
          if (kj.length >= 30) {
            _j30.push(k + d);
            j30.push( [d, kj.length] );
          }
          if (kj.slice(-1)[0] === j.tag) {
            j0.push(d); // .today
            if (kj.length === 1) {
              jFirst.push(d);
            } else {
              kjj = parseInt(kj.slice(-2)[0]);
              if (kjj < jtagOffset(1)) {
                j1neg.push(d); }
              if (kjj < jtagOffset(3)) {
                j3neg.push(d); }
              if (kjj < jtagOffset(7)) {
                j7neg.push(d);
              }
          } }
          kjj = parseInt(kj.slice(-1)[0]);
          if (kjj <= jtagOffset(14)) {
            jA.push(d);
            if (kjj === jtagOffset(14)) { jA0.push(d); }
          } else {
            jB.push(d);
            kjj = 0;
            kj.forEach((dd) => { //Array.from(
              if (parseInt(dd) > jtagOffset(14)) {
                kjj += 1; }
            });
            if (kjj >= 7) {
              _j14.push(k + d);
              j14.push( [d, kjj] ); }
          }
        });
        j1neg.push(...jFirst);
        j3neg.push(...jFirst);
        j7neg.push(...jFirst);
        // console.log(k, j.districts[k].length, jB.length, j0.length, jA.length, jA0.length,
        //   '七阴'+j7neg.length, '三阴'+j7neg.length, '昨阴'+j1neg.length,
        //   '月内'+j30.length, '首次'+jFirst.length, '两周内'+j14.length )
        if (_j30 !== []) {
          bubble2(j30);
          j.list30times[k] = j30;
          j.listed_30times_long.push(..._j30);
        }
        if (_j14 !== []) {
          bubble2(j14);
          j.cache14days[k] = j14;
          j.cached_14days.push(..._j14);
        }
        if (jFirst !== []) j.first_in[k] = jFirst;
        ////if (parseInt(j.tag) > 500) {
        if (j.today[k]) {
          kj = [...j.today[k]].filter(x => j0.indexOf(x) === -1);
          kj.length && j.today[k].length === j0.length && console.log(
          k, '当日阳 py多了', kj);
        }
        if (j0 !== []) j.today[k] = j0;
        if (j.inB[k]) {
          kj = [...j.inB[k]].filter(x => !jB.indexOf(x) === -1);
          kj.length && j.inB[k].length === jB.length && console.log(
          k, '两周阳 py多了', kj);
        }
        if (jB !== []) j.inB[k] = jB;
        if (j.released[k]) {
          kj = [...j.released[k]].filter(x => !jA.indexOf(x) === -1);
          kj.length && j.released[k].length === jA.length && console.log(
          k, '累计下榜 py多了', kj);
        }
        if (jA !== []) j.released[k] = jA;
        if (j.released_today[k]) {
          kj = [...j.released_today[k]].filter(x => !jA0.indexOf(x) === -1);
          kj.length && j.released_today[k].length === jA0.length && console.log(
          k, '当日下榜 py多了', kj);
        }
        if (jA0 !== []) j.released_today[k] = jA0;
        if (j.latest_added[k]) {
          kj = [...j.latest_added[k]].filter(x => !j1neg.indexOf(x) === -1);
          kj.length && j.latest_added[k].length === j1neg.length && console.log(
          k, '比昨日多 py多了', kj);
        }
        if (j1neg !== []) j.latest_added[k] = j1neg;
        if (j.latest_added2[k]) {
          kj = [...j.latest_added2[k]].filter(x => !j3neg.indexOf(x) === -1);
          kj.length && j.latest_added2[k].length === j3neg.length && console.log(
          k, '三阴阳 py多了', kj);
        }
        if (j3neg !== []) j.latest_added2[k] = j3neg;
        if (j.latest_added7[k]) {
          kj = [...j.latest_added7[k]].filter(x => !j7neg.indexOf(x) === -1);
          kj.length && j.latest_added7[k].length === j7neg.length && console.log(
          k, '七阴阳 py多了', kj);
        }
        if (j7neg !== []) j.latest_added7[k] = j7neg;
        ////}
      });
      console.timeEnd('>> cache lists ' + j.tag);
      _J[j.tag] = j;
      if (!_m0f0[j.tag + 'cut' + explode_cutoff]) cache_m0f0(explode_cutoff);
      Array.from( document.getElementsByName('sets') ).forEach((d) => {
        d.style.visibility = 'visible';
      });
    }
    resolve(1);
  });
}

const _m0f0_sets = {};
function cache_m0f0 (cutoff) {
  _m0f0[j.tag + 'cut' + cutoff] = [];
  const arr0 = [];
  explode_cutoff_max = 0;
  const arr1 = []; const arr2 = []; const arr3 = []; const arr4 = [];
  Object.keys(_m0f0).forEach((d) => {
    const m0f0 = _m0f0[d];
    if (!m0f0.dates) {
      console.log('_m0f0["'+d+'"]', m0f0.length);
    } else {
      if (j.address[m0f0.d] && j.address[m0f0.d].length > cutoff) { // explode_cutoff
        // console.log('早发后爆', m0f0.k, m0f0.d, j.address[m0f0.d] );
        if (j.address[m0f0.d].length > explode_cutoff_max) {
          explode_cutoff_max = j.address[m0f0.d].length; }
        _m0f0[j.tag + 'cut' + cutoff].push(m0f0.k + m0f0.d);
      }
      if (j.address[m0f0.d]) {
        //console.log('地址未收录', m0f0.k, m0f0.d);
        arr0.push([m0f0.k, m0f0.d, m0f0.sex +
                  '|' + m0f0.ages, j.address[m0f0.d].length-1 ]);
      }
      if (m0f0.count > 1) {
        if (j.address[m0f0.d] &&
            Math.min.apply(null, m0f0.ages) < 6 ) {
          // console.log('早期'+m0f0.count+'人 含幼儿未上学', m0f0.ages,
          //             m0f0.k, m0f0.d, m0f0.sex, '后期上榜', j.address[m0f0.d].length-1, '次');
          arr1.push([m0f0.k, m0f0.d, m0f0.sex +
                    '|' + m0f0.ages, j.address[m0f0.d].length-1 ]); }
        if (j.address[m0f0.d] &&
            Math.max.apply(null, m0f0.ages) > 70 ) {
          // console.log('早期'+m0f0.count+'人 含高寿老人', m0f0.ages,
          //             m0f0.k, m0f0.d, m0f0.sex, '后期上榜', j.address[m0f0.d].length-1, '次');
          arr2.push([m0f0.k, m0f0.d, m0f0.sex +
                    '|' + m0f0.ages, j.address[m0f0.d].length-1 ]); }
        if (j.address[m0f0.d] &&
            Math.min.apply(null, m0f0.ages) >= 6 &&
            Math.min.apply(null, m0f0.ages) < 18 ) {
          // console.log('早期'+m0f0.count+'人 含中小学生', m0f0.ages,
          //             m0f0.k, m0f0.d, m0f0.sex, '后期上榜', j.address[m0f0.d].length-1, '次');
          arr3.push([m0f0.k, m0f0.d, m0f0.sex +
                    '|' + m0f0.ages, j.address[m0f0.d].length-1 ]); }
        if (j.address[m0f0.d] &&
            Math.min.apply(null, m0f0.ages) >= 18 &&
            Math.min.apply(null, m0f0.ages) < 50 && m0f0.sex &&
            parseInt(m0f0.sex.substr(1, m0f0.sex.indexOf('女'))) > 0 &&
            parseInt(m0f0.sex.substr(m0f0.sex.indexOf('女') + 1)) > 0) {
          // console.log('成人'+m0f0.count+'人 含男女',
          //             m0f0.k, m0f0.d, m0f0.sex, '后期上榜', j.address[m0f0.d].length-1, '次');
          arr4.push([m0f0.k, m0f0.d, m0f0.sex +
                    '|' + m0f0.ages, j.address[m0f0.d].length-1 ]); }
      }
    }
  });
  [...Array(5).keys()].forEach((d) => {
    bubble2(eval('arr' + d), 3);
    _m0f0_sets['arr' + d] = eval('arr' + d);
  });
  _setEx.value = cutoff;
}

async function asyncList30times (k) {
  if (!j.list30times) {
    await cacheList().catch(e => {
      return console.log(e);
    });
  }
  let ki = 0;
  const kk = document.createElement('p');
  const tt = '超30次上榜';
  if (j.list30times && k && j.list30times[k]) {
    kk.innerHTML = '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);' +
                   'draw_sh_addr(j.listed_30times_long,\'' +
                   k + tt + '\');">展示' + k + tt + '地址</button> ' +
                   '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);draw_sh_addr(null,\''+k+'累计阳\');' +
                   '">3月6日以来曾上榜至少1次</button> ' +
                   '<button onclick="h2dist.scrollIntoView();">各区统计</button>';
    onList.appendChild(kk);
    j.list30times[k].forEach((d) => { //Array.from(
        ki += 1;
        onListAppend(ki, k, d[0],
                     '3月6日以来 上榜' + d[1] + '次');
    });
  } else if (j.list30times && !k) { // j.listed_30times_long.length
    kk.innerHTML = '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);' +
                   'draw_sh_addr(j.listed_30times_long,\'' +
                   '上海市' + tt + '\');">展示' + tt + '地址</button> ' +
                   '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);draw_sh_addr();' +
                   '">3月6日以来曾上榜至少1次</button> ' +
                   '<button onclick="h2dist.scrollIntoView();">各区统计</button>';
    onList.appendChild(kk);
    ki = _check;
    _check = 'list30times';
    generalAppend();
    _check = ki;
  } else {
    onListAppend(' ', (k || '上海市'), null, '无超30次的');
  }
}

function generalAppend () {
  let kj; let ki = 1;
  Ds.forEach((k) => {
    if (!j[_check] || !j[_check][k] || !j[_check][k].length) {
      onListAppend(' ', k, null, '无');
    } else {
      kj = j[_check][k].length;
      if (_check === 'still_in') {
        onListAppend(ki, k, null, kj +
                     '处 最近' + _still_in + '日上榜' );
      } else {
        onListAppend(ki, k, null, kj +
                     '处 ' + check_choices[_check] );
      }
      ki += kj;
    }
  });
}

function mapX (z) { // 57变大==>区域变窄  .004修正区域平移
  const zz = Math.round((z - d3center[0] + 0.004) * d3scale/57 + svgWidth/2);
  return zz;
}
function mapX0 (z) { // 区边界 河流 地铁 咖啡店
  const zz = Math.round((z - d3center[0]) * d3scale/57 + svgWidth/2);
  return zz;
}

function mapY (z) { // 49变大==>区域压扁  .003修正区域平移
  const zz = Math.round((d3center[1] - z + 0.003) * d3scale/49 + svgHeight/2);
  return zz;
}
function mapY0 (z) {
  const zz = Math.round((d3center[1] - z) * d3scale/49 + svgHeight/2);
  return zz;
}

function inChina (lng, lat) {
  if (lng && lng > 73.66 && lng < 135.05) {
    if (lat && lat > 3.86 && lat < 53.55) {
      return true;
  } }
  return false;
}

function withinSVG (pxX, pxY) {
  if (pxX && pxX > 0 && pxX < svgWidth) {
    if (pxY && pxY > 0 && pxY < svgHeight) {
      return true;
  } }
  return false;
}

// https://stackoverflow.com/questions/10359907
var average = arr => arr.reduce((prev, curr) => prev + curr) / arr.length;

function pngMulti () {
  if (!pngBase64) {
    window.alert('启动图片缓存，请点击左右箭头间的日期');
  }
  const imgL = Object.keys(pngBase64);
  const zip = new JSZip();
  let img0;
  let img1 = '# ' + today.toLocaleString('zh-CN') + '\r\n\r\n';
  for (i = 0; i < imgL.length; i += 1) {
    img0 = pngBase64[ imgL[i] ].indexOf(',');
    zip.file(imgL[i] + '.png',
             pngBase64[ imgL[i] ].slice(img0 + 1), {base64: true });
    img1 += (i+1) + '. ' + imgL[i] + '.png\r\n';
  }
  zip.file('list.txt', img1);
  zip.generateAsync({type: "blob" }).then(function (blob) {
    saveAs(blob, 'download.zip');
    pngBase64 = {};
    pngGif.innerHTML = '<p class="click" onclick="auto_save_status.click()">停</p>';
  });
  // https://stuk.github.io/jszip/
}

function pngDown (fileH, canvasElement, fo) {
  pngBase64[fileH + j.tag] = canvasElement.toDataURL('image/png');
  if (autoSavePNG && !fo) {
    pngGif.innerHTML = '<p class="click" onclick="pngMulti()">点击下载 ' +
                       Object.keys(pngBase64).length + ' 张图片<br/>' +
                       '<span style="font-size:75%">（不支持自动缓存表格）</span></p>';
    return;
  }
  canvasElement.toBlob(function (blob) {
    saveAs(blob, fileH + '2022' + j.tag + (Math.random() + '').substr(1,5) + '.png');
  });
}

function exportCanvasAsPNG (fo) {
  // https://stackoverflow.com/questions/923885/
  // https://stackoverflow.com/questions/53757970/
  let fileH = addr.value || '表格';
  if (app.style.display !== 'none') {
    fileH += check_choices[_check];
    const canvasElement = document.getElementById('app');
    pngDown(fileH, canvasElement, fo);
  } else {
    html2canvas(document.getElementById('districtTbody').parentNode).then(canvasElement => {
      pngDown(fileH, canvasElement, fo);
    });
  }
}

function updateLocation (hash_, q) {
  let url = baseURL + '#0' + hash_;
  if (q) {
    url += '?' + q;
  }
  if (d3scale) {
    url += '$' + d3scale;
    if (d3center && d3center.length === 2) {
      url += '_' + d3center[0] + '_' + d3center[1];
    }
  }
  if (autoSavePNG) {
    url += '=' + _check;
  }
  window.location.replace(url);
  //window.location.reload();
  load_js();
}

function preReload (q, oldest) {
  let hash_;
  // if (j && j.address.shanghaifabu.length > 2) {
  //   if (j.tag === j.address.shanghaifabu.slice(-1)[0]) {
  //     hash_ = parseInt(j.address.shanghaifabu.slice(-2)[0] );
  //   } else {
  //     hash_ = parseInt(j.address.shanghaifabu.slice(-1)[0] );
  //   }
  // }
  try {
    hash_ = jtagOffset(1);
  } catch (err) {
    window.alert('没有前一日的数据 恢复默认值');
    hash_ = 307;
  }
  if (oldest || hash_ < 307) {
    hash_ = 307;
  }
  if (oldest && lastAddrFirstTag &&
      lastAddrFirstTag !== j.tag &&
      [...Ds, '上海市'].indexOf(addr.value) === -1 ) {
    updateLocation(parseInt(lastAddrFirstTag), q);
    lastAddrFirstTag = null;
  } else {
    updateLocation(hash_, q);
  }
}

function nextReload (q, lastest) {
  let hash_;
  try {
    hash_ = jtagOffset(-1); // hash
  } catch (err) {
    window.alert('没有后一日的数据 恢复默认值');
    hash_ = j_data_init;
  }
  if (lastest) {
    hash_ = j_data_init;
  }
  if (next_button.getAttribute('data-value') !== '') {
    nextSpecial = next_button.getAttribute('data-value');
    next_button.setAttribute('data-value', '');
    next_button.style.border = '';
    next_button2.style.border = '';
  }
  updateLocation(hash_, q);
}

function jumpApr (q, month) {
  if (!month) {
    month = 4;
  }
  const inputS = document.getElementById(ms[month]).value;
  let i_ = parseInt(inputS);
  if (!inputS || !i_ || i_ > 31 || i_ < 1) {
    document.getElementById(ms[month]).value = '';
    return;
  } else if (month === 3 && i_ < 7) {
    i_ = 7;
  } else if (i_ === 31 && (month === 4 || month === 6)) {
    i_ = 30;
  }
  const hash_ = i_ + 100 * month;
  if (lastAddrFirstTag &&
      parseInt(lastAddrFirstTag) > hash_ &&
      [...Ds, '上海市'].indexOf(addr.value) === -1 ) {
    updateLocation(parseInt(lastAddrFirstTag), q);
    lastAddrFirstTag = null;
  } else {
    updateLocation(hash_, q);
  }
}

function setsEnter () {
  const keyCode = ('which' in event) ? event.which : event.keyCode;
  if (keyCode === 13) {
    if (!parseInt(_setEx.value) ||
        parseInt(_setEx.value) < 2 ||
        parseInt(_setEx.value) > explode_cutoff_max ) {
      window.alert('数据组 无法展示' + _setEx.value + '次上榜的，最大值' + explode_cutoff_max);
    } else {
      explode_cutoff = parseInt(_setEx.value);
      if (!_m0f0[j.tag + 'cut' + explode_cutoff]) cache_m0f0(explode_cutoff);
    }
  }
}

function stillEnter () {
  const keyCode = ('which' in event) ? event.which : event.keyCode;
  if (keyCode === 13) {
    window.alert('点击选择框 展示' + _still.value + '日阳');
    Array.from( document.getElementsByName('check') ).forEach((d) => {
      d.checked = false;
    });
  }
}

function aprilEnter (ky) {
  const keyCode = ('which' in event) ? event.which : event.keyCode;
  if (keyCode === 13) {
    jumpApr(addr.value, ky);
  }
}

function addrEnter () {
  const keyCode = ('which' in event) ? event.which : event.keyCode;
  if (keyCode === 13) {
    //scaleChange = true;
    search(addr.value);
  }
}

const loading = ['.', '..', '...', '']; // ['\\', '/', '-']
let loading_i = -1;
(function f () {
  loading_i = (loading_i + 1) % loading.length;
  if (document.getElementById('loading_span')) {
    loading_span.textContent = loading[ loading_i ];
  }
  setTimeout(f, 250);
})();

function next_pre_vis (hash_) {
  if (hash_ < j_data_init) {
    next_button.style.visibility = 'visible';
  } else {
    next_button.style.visibility = 'hidden';
  }
  if (hash_ < 308) {
    pre_button.style.visibility = 'hidden';
  } else {
    pre_button.style.visibility = 'visible';
  }
  save_button.style.visibility = 'visible';
  addr.style.visibility = 'visible';
  search_button.style.visibility = 'visible';
  districtTbody.style.visibility = 'visible';
}

function hard_off () {
  addr.style.visibility = 'hidden';
  search_button.style.visibility = 'hidden';
  districtTbody.style.visibility = 'hidden';
  next_button.style.visibility = 'hidden';
  pre_button.style.visibility = 'hidden';
  save_button.style.visibility = 'hidden';
  fetching.style.visibility = 'hidden';
  fetching2.style.visibility = 'hidden';
  auto_save_.style.visibility = 'hidden';
  const h2 = document.getElementsByTagName('h2');
  Array.from(h2).forEach((d) => {
    d.style.visibility = 'hidden';
  });
}

function load_js () {
  const hash_orig = window.location.hash.slice(1).split('?')[0];
  const hash2_orig = decodeURIComponent(window.location.toString()).split('?')[1]; // undefined
  hash = hash_orig;
  hash2 = hash2_orig;
  if (window.location.toString().indexOf('$') > -1) {
    hash = hash.split('$')[0];
  }
  autoSavePNG = (window.location.toString().indexOf('=') > -1);
  if (autoSavePNG) {
    hash = hash.split('=')[0];
    _check = window.location.toString().split('=')[1];
  }
  let hash_ = parseInt(hash);
  if (hash.length !== 4 || hash_ > j_data_init) {
    hash = '0' + j_data_init;
    hash_ = j_data_init;
  } else if (hash_ < 307) {
    hash = '0307';
    hash_ = 307;
  }
  if (hash2) {
    window.location.replace(baseURL + '#' + hash + '?' + hash2);
  } else {
    window.location.replace(baseURL + '#' + hash);
  }
  const k_src = "shanghaifabu/full" + hash + '.json';
  if (_J && _J[hash] && _J[hash].tag === hash) {
    j = _J[hash];
    next_pre_vis(hash_);
    load();
  } else {
    //datestr.textContent = '';
    fetching.style.visibility = 'visible';
    fetching2.style.visibility = 'visible';
    console.log('Downloading', hash + '.json');
    // let k = document.createElement('script');
    // k.src = k_src;
    // document.head.append(k);
    // k.onload = function () {
    // };
    // k.onerror = function () {
    // };
    const req = new XMLHttpRequest();
    let ldint;
    req.addEventListener("loadstart", event => {
      loading_pr.textContent = '0%';
      loading_pr2.textContent ='0%';
    }, false);
    req.addEventListener("progress", event => {
      if (event.lengthComputable) {
        ldint = parseInt(100 * event.loaded/event.total);
      } else {
        ldint = parseInt(100 * event.loaded/3600000);
      }
      if (ldint > 83) { ldint = 99 - 16; } // 解析 full.json 需要约2秒
      loading_pr.textContent = ldint + '%';
      loading_pr2.textContent =ldint + '%';
    }, false);
    req.addEventListener("load", event => {
      const e = event.target;
      const k = document.createElement('script');
      try {
        k.textContent = e.responseText;
        document.body.appendChild(k);
        j = JSON.parse(data);
      } catch (err) {
        hard_off();
        window.alert('数据无法下载\nhttps://sh.teach.bio/');
        window.location.replace(baseURL);
        return false;
      }
      data = '';
      _J[hash] = j;
      if (parseInt(j.tag) > j_data_init) {
        hard_off();
        window.alert('数据日期有错 请刷新页面\n' + window.location.toString() );
        return false;
      }
      if (j.address.shanghaifabu &&
          hash !== j.address.shanghaifabu.slice(-1)[0] &&
          parseInt(j.tag) > 317 ) {
        console.log('Last four shanghaifabu in data', j.tag, j.address.shanghaifabu.slice(-4) );
      }
      next_pre_vis(hash_);
      load();
    }, false);
    req.addEventListener("error", event => {
      if (baseURL.substr(0,4) !== 'http' || JSON.stringify(_J) === '{}') {
        hard_off();
        window.alert('数据无法下载 请访问 https://sh.teach.bio/');
      } else {
        loading_pr.textContent = '可用数据: ' + Object.keys(_J).join(', ');
        loading_pr2.textContent ='可用数据: ' + Object.keys(_J).join(', ');
        window.alert('数据无法下载 请稍后刷新页面\n当前可使用以下数据\n' +
                     Object.keys(_J)); // window.location.toString()
      }
    }, false);
    req.addEventListener("abort", event => {
      console.log(event);
      if (hash2_orig) {
        window.location.replace(baseURL + '#' + hash_orig + '?' + hash2_orig);
      } else {
        window.location.replace(baseURL + '#' + hash_orig);
      }
    }, false);
    req.open('GET', k_src );
    req.send();
    // https://stackoverflow.com/questions/18126406/
  }
  // SukkaW/DisqusJS
}

function digi2date (_int) {
  return Math.floor(_int/100) + '/' + (_int % 100);
}

function hash2date (_s) {
  try {
    const _m = parseInt(_s.substr(0,2) );
    const _d = parseInt(_s.substr(2,2) );
    if (_s.length === 4 && [3,4,5].indexOf(_m) > -1 && _d > 0 && _d < 32) {
      return _m + '/' + _d;
    } else {
      return tag_m.textContent + '/' + tag_d.textContent;
    }
  } catch (err) {
      return 'm/d';
  }
}

function resetDay (dldi) {
  search_button.textContent = '搜索';
  addr.value = '';
  app.style.display = 'none';
  window.location.replace('#' + dldi);
  load_js();
}

function tagsHTML (dl_, noClick) {
  if (!dl_ || dl_.length === 0) { return ''; }
  const dl = [];
  let di;
  for (di = 0; di < dl_.length; di += 1) {
    if (dl_[di].length === 4) {
      dl.push( dl_[di] );
    }
  }
  if (!dl || dl.length === 0) { return ''; }
  let ds = '<span'; let inwhile;
  if (dl[0] === '0306') {
    ds += ' style="background-color:yellow;"';
  }
  if (noClick) {
    ds += '>' + hash2date(dl[0]) + '</span>';
  } else {
    ds += ' class="click" onclick="resetDay(\'' +
          dl[0] + '\');">' + hash2date(dl[0]) + '</span>';
    lastAddrFirstTag = dl[0];
  }
  for (di = 1; di < dl.length; di += 1) {
    inwhile = false;
    while (dl[di] &&
           (parseInt(dl[di]) - parseInt(dl[di-1])) === 1 ) {
      ds += '.';
      di += 1;
      inwhile = true;
    }
    if (inwhile) {
      di -= 1;
      if ((di+1) === dl.length && dl[di] === j.tag) {
        ds += '<span style="background-color:yellow;"';
      } else {
        ds += '<span';
      }
      if (noClick) {
        ds += '>' + parseInt(dl[di].substr(2,2)) + '</span>';
      } else {
        ds += ' class="click" onclick="resetDay(\'' +
              dl[di] + '\');">' + parseInt(dl[di].substr(2,2)) + '</span>';
      }
    } else {
      if (di < dl.length) { //  && ds.slice(-1)[0] !== '.'
        ds += ', ';
      }
      if ((di+1) === dl.length && dl[di] === j.tag) {
        ds += '<span style="background-color:yellow;"';
      } else {
        ds += '<span';
      }
      if (noClick) {
        ds += '>' + hash2date(dl[di]) + '</span>';
      } else {
        ds += ' class="click" onclick="resetDay(\'' +
              dl[di] + '\');">' + hash2date(dl[di]) + '</span>';
      }
    }
  }
  return ds;
}

async function load () {
  Ml = JSON.parse(csv);
  Ms = Object.keys(Ml.locations);
  //datestr.textContent = j.date;
  end_pre.textContent = '\n\n数据更新时间 ' + j.date +
                        '\n源代码 github.com/coronin/shanghai-2022Mar' +
                        '\n作者 @the_paper_link';
  tag_m.textContent = parseInt(j.tag.substr(0,2) );
  tag_m2.textContent = tag_m.textContent;
  tag_d.textContent = parseInt(j.tag.substr(2,2) );
  tag_d2.textContent = tag_d.textContent;
  for (i = 3; i < 6; i += 1) {
    document.getElementById(ms[i]).value = '';
  }
  th_hot.textContent = '';
  _today = hash2date(j.tag);
  const tags = document.getElementsByClassName('_tag');
  // for (k = 0; k < tags.length; k += 1) {
  //   tags[k].textContent = _today;
  // }
  Array.from(tags).forEach((d) => {
    d.textContent = _today;
  });
  auto_save_status.onclick = function () {
    if (autoSavePNG) {
      auto_save_off();
    } else {
      autoSavePNG = true;
      auto_save_status.style.boxShadow = 'inset 0 -.5em cyan';
      pre_button.style.border = '.25em solid cyan';
      next_button.style.border = '.25em solid cyan';
      auto_save_.style.visibility = 'visible';
      pngGif.style.visibility = 'visible';
      exportCanvasAsPNG();
    }
  };
  check_row.onclick = function () {
    auto_save_off();
  };
  if (autoSavePNG) {
    auto_save_status.style.boxShadow = 'inset 0 -.5em cyan';
    pre_button.style.border = '.25em solid cyan';
    next_button.style.border = '.25em solid cyan';
    auto_save_.style.visibility = 'visible';
    pngGif.style.visibility = 'visible';
  }
  Ds = Object.keys(j.districts);
  await asyncPopulateStill().catch(e => {
    window.alert('代码有错 请邮件告知\ndev@teach.bio');
    return console.log(e);
  });
  _still.onchange = function () {
    _still_in = parseInt(_still.value);
    asyncPopulateStill();
  };
  As = Object.keys(j.address);
  th_k.textContent = '';
  districtTbody.textContent = '';
  divToday.textContent = '';
  divLatestReleased.textContent = '';
  divReleased.textContent = '';
  let k;
  for (i = 0; i < Ds.length; i += 1) {
    k = document.createElement('tr');
    // if (Ds[i] === '普陀区') {
    //   console.log( j.inB[ Ds[i] ] );
    //   console.log( j.today[ Ds[i] ] );
    // }
    k.innerHTML = '<td class="click" onclick="_check=\'today\';search(this.textContent);"' +
        ' title="当日阳">' +
        Ds[i] + '</td><td class="click" onclick="_check=\'districts\';search(\''+Ds[i]+'\');"' +
        ' title="' + Ds[i] + '累计阳">' +
        j.districts[ Ds[i] ].length + '</td><td id="' +
        Ds[i] + 'line" style="text-align:left;"></td>' +
        '<td class="click" onclick="_check=\'inB\';search(\''+Ds[i]+'\');"' +
        ' title="' + Ds[i] + '两周阳">' +
        (j.inB[ Ds[i] ] || []).length +
        '</td><td class="click" onclick="_check=\'latest_added\';search(\''+Ds[i]+'\');"' +
        ' title="' + Ds[i] + '比昨日多" style="color:red;">' +
        (j.today[ Ds[i] ] || []).length +
        '</td><td class="click" onclick="_check=\'released\';search(\''+Ds[i]+'\');"' +
        ' title="' + Ds[i] + '累计下榜" style="color:green;">' +
        (j.released[ Ds[i] ] || []).length + '</td>';
    if (j.released_today[ Ds[i] ]) {
      k.innerHTML += '<td class="click" onclick="_check=\'released_today\';search(\''+Ds[i]+'\');"' +
        ' title="' + Ds[i] + '当日下榜" style="color:green;">' +
        (j.released_today[ Ds[i] ] || []).length + '</td>';
    } else {
      k.innerHTML += '<td style="color:green;">&ndash;</td>';
    }
    const hot_addresses = '' + Object.keys(hot_addr);
    if (j_data_init === parseInt(j.tag) && hot_addresses.indexOf(Ds[i]) > -1) {
      th_hot.textContent = '中风险';
      k.innerHTML += '<td style="color:purple;">' +
                     (hot_addresses.split(Ds[i]).length - 1) +
                     '处</td>';
    } else {
      k.innerHTML += '<td></td>';
    }
    k.id = Ds[i];
    districtTbody.appendChild(k);
    k = document.createElement('p');
    if (j.latest_added && j.latest_added[ Ds[i] ]) {
      k.innerHTML = '<span style="color:black;"><strong onclick="_check=\'latest_added\';search(this.textContent);"' +
                    ' class="click _L">' + Ds[i] + '</strong> 2022/' + _today + '涉及' +
                    j.today[Ds[i]].length + '个地址' +
                    ((j.today[Ds[i]].length > 0) ? '（如下）</span> ' : '</span>') +
                    ((j.latest_added[ Ds[i] ].length > 0) ? (j.latest_added[ Ds[i] ].length + '个地址不同于前一日') : '') +
                    '<br/>' + j.latest_added[ Ds[i] ] +
                    '<span style="color:grey;">' +
                    ((j.latest_added[ Ds[i] ].length > 0 && j.today[Ds[i]].length > j.latest_added[ Ds[i] ].length) ? ',' : '') +
                    [...j.today[Ds[i]]].filter(x => j.latest_added[ Ds[i] ].indexOf(x) === -1) +
                    '</span>';
    } else {
      k.innerHTML = '<span style="color:black;"><strong onclick="_check=\'today\';search(this.textContent);"' +
                    ' class="click _L">' + Ds[i] + '</strong> 2022/' + _today + '涉及' +
                    (j.today[Ds[i]] || []).length +
                    '个地址</span><br/><span style="color:grey;">' + j.today[Ds[i]] +
                    '</span>';
    }
    divToday.appendChild(k); // j.latest_added
    k = document.createElement('p');
    if (j.released_today && j.released_today[ Ds[i] ] && j.released_today[ Ds[i] ].length > 0) {
      k.innerHTML = '<span style="color:black;" onclick="_check=\'released_today\';search(this.textContent);"' +
                    ' class="click _L">' + Ds[i] + '</span>: ' + j.released_today[ Ds[i] ];
    } else {
      k.innerHTML = '<span style="color:black;">' + Ds[i] + ': 无</span>';
    }
    divLatestReleased.appendChild(k);
    k = document.createElement('p');
    if (j.released && j.released[ Ds[i] ] && j.released[ Ds[i] ].length > 0) {
      k.innerHTML = '<span style="color:black;" onclick="_check=\'released\';search(this.textContent);"' +
                    ' class="click _L">' + Ds[i] + '</span>: ' + j.released[ Ds[i] ];
    } else {
      k.innerHTML = '<span style="color:black;">' + Ds[i] + ': 无</span>';
    }
    divReleased.appendChild(k);
  }
  map = document.getElementById('app').getContext('2d');
  if (window.location.toString().indexOf('=') === -1 && !autoSavePNG) {
    auto_save_.style.visibility = 'hidden';
    pngGif.style.visibility = 'hidden';
  }
  if (parseInt(j.tag) > 308) { // 三阴阳
    check6.style.display = 'inline-block';
  } else {
    check6.style.display = 'none';
  }
  if (parseInt(j.tag) > 312) { // 七阴阳
    check7.style.display = 'inline-block';
  } else {
    check7.style.display = 'none';
  }
  if (parseInt(j.tag) > 319) { // 累计下榜 当日下榜
    check4.style.display = 'inline-block';
    check5.style.display = 'inline-block';
  } else {
    check4.style.display = 'none';
    check5.style.display = 'none';
  }
  onList.textContent = '';
  fetching.style.visibility = 'hidden';
  fetching2.style.visibility = 'hidden';
  if (window.location.toString().indexOf('?') > -1) {
    if (hash2.indexOf('$') > -1) {
      scaleChange = false;
      const scc = hash2.split('$')[1].split('=')[0].split('_');
      d3scale = parseInt(scc[0]);
      d3center = [parseFloat(scc[1]), parseFloat(scc[2])];
      k = hash2.split('$')[0];
    } else {
      k = hash2;
    }
    search(k);
  }
}

function draw_sh () { // map-address.html
  app.width = svgWidth;
  app.height = svgHeight;
  app.style.display = 'block';
  app.style.padding = '5px 0 2px 0';
  Array.from( document.getElementsByName('map') ).forEach((d) => {
    d.style.visibility = 'visible';
  });
  const jj = JSON.parse(sh);
  const dt = topojson.feature(jj, jj.objects.collection);
  //const dn = topojson.neighbors(jj.objects.collection.geometries);
  const pj = d3.geo.mercator(
              ).scale(d3scale).center(d3center
              ).translate([svgWidth/2, svgHeight/2]);
  const pg = d3.geo.path().projection(pj).context(map);
  if (parseInt(j.tag) > 400 ||
      (parseInt(j.tag) > 327 && feng0328.indexOf(addr.value) > -1) ) {
    map.strokeStyle = 'grey';
  } else {
    map.strokeStyle = 'rgba(255,0,0,0.3)';
  }
  map.font = fontSize + 'px Microsoft YaHei';
  dt.features.forEach((d) => {
    // let xx = new Array(), yy = new Array();
    // let xx_raw = new Array(), yy_raw = new Array();
    // let xx_max, yy_max, xxx, yyy;
    // if (d.properties.name === addr.value) {
    //   //console.log(d);
    //   console.log(d.properties.name, svgWidth, 'x', svgHeight,
    //              'current scale', d3scale );
    //   let dd
    //   if (d.geometry.type === 'MultiPolygon') {
    //     dd = d.geometry.coordinates[0][0];
    //     for (i = 1; i < d.geometry.coordinates[0].length; i++) {
    //       dd = [...dd, ...d.geometry.coordinates[0][i] ];
    //     }
    //   } else {
    //     dd = d.geometry.coordinates[0];
    //   }
    //   //console.log(dd);
    //   for (i = 0; i < dd.length; i++) {
    //     xxx = parseFloat(dd[i][0]);
    //     yyy = parseFloat(dd[i][1]);
    //     //console.log(xxx, yyy);
    //     if (inChina(xxx, yyy)) {
    //       xx_raw.push(xxx);
    //       yy_raw.push(yyy);
    //       xx.push(mapX(xxx ));
    //       yy.push(mapY(yyy ));
    //     }
    //   }
    //   // 黄浦区 0.05311649064906021 ~ 72000 ~ 67
    //   xx_max = Math.max.apply(null, xx) - Math.min.apply(null, xx);
    //   // 黄浦区 0.05627040804080252 ~ 72000 ~ 82
    //   yy_max = Math.max.apply(null, yy) - Math.min.apply(null, yy);
    //   console.log('    suggested centers', mapX(average(xx_raw)), mapY(average(yy_raw)),
    //     average(xx_raw), average(yy_raw),
    //     Math.min.apply(null, [
    //       Math.floor(d3scale * svgWidth/xx_max),
    //       Math.floor(d3scale * svgHeight/yy_max) ]) );
    // }
    map.beginPath();
    pg(d);
    if (sh_district7.indexOf(d.properties.name) > -1) {
      map.fillStyle = 'rgba(200,200,200,0.2)'; // d.properties.subFeatureIndex
      map.fill(); // 'nonzero', 'evenodd'
    }
    map.stroke();
    map.textBaseline = 'top';
    map.textAlign = 'start';
    map.fillStyle = 'grey';
    map.fillText(d.properties.name,
                 mapX0(d.properties.center[0]),
                 mapY0(d.properties.center[1]));
  });
  if (j_data_init === parseInt(j.tag)) {
    map.fillStyle = 'purple';
    Object.keys(hot_addr).forEach((d) => { // 2022-6-2
      if (Ml.locations[d]) {
        map.beginPath();
        map.fillRect(mapX( Ml.locations[d][0] ),
                     mapY( Ml.locations[d][1] ),
                     3, 3 );
        map.fillText(hot_addr[d] + ' ' + d.substr(d.indexOf('区')+1),
                 1.5+mapX( Ml.locations[d][0] ),
                 1.5+mapY( Ml.locations[d][1] ) - fontSize);
      } else if (hot_addr[d].length === 5) {
        const jj0 = JSON.parse( eval(hot_addr[d]) );
        const dt0 = topojson.feature(jj0, jj0.objects.collection);
        let d0xy;
        dt0.features.forEach((d0) => {
          map.beginPath();
          d0xy = d0.geometry.coordinates[0].slice(-1)[0];
          map.moveTo(mapX(d0xy[0]), mapY(d0xy[1]));
          d0xy = [0, svgHeight];
          d0.geometry.coordinates[0].forEach((d1) => {
            map.lineTo(mapX(d1[0]), mapY(d1[1]));
            if (d0xy[0] < mapX(d1[0])) d0xy[0] = mapX(d1[0]);
            if (d0xy[1] > mapY(d1[1])) d0xy[1] = mapY(d1[1]);
            //d0xy[1] += mapY0(d1[1]);
          });
          //d0xy[1] = d0xy[1] / d0.geometry.coordinates[0].length;
          map.fill();
        });
        map.fillText(hot_addr[d].substr(1) + ' ' + d.substr(d.indexOf('区')+1),
                     1.5+d0xy[0], d0xy[1] );
      }
    });
  }
  map.fillStyle = 'blue';
  let dots_count = 0; let dotX; let dotY;
  if (_mapOp.indexOf('咖啡店') > -1) {
    const cafe0 = JSON.parse(cafe);
    const cafe1 = topojson.feature(cafe0, cafe0.objects.collection);
    cafe1.features.forEach((d) => {
      dotX = mapX0( d.geometry.coordinates[0] );
      dotY = mapY0( d.geometry.coordinates[1] );
      if (withinSVG(dotX, dotY)) {
        dots_count += 1;
        map.beginPath();
        map.fillRect(dotX, dotY, 3, 3 ); }
    });
  } else if (_mapOp.indexOf('中小学') > -1) {
    Array.from(schs).forEach((d) => {
      dotX = mapX(d[0] );
      dotY = mapY(d[1] );
      if (withinSVG(dotX, dotY)) {
        dots_count += 1;
        map.beginPath();
        map.fillRect(dotX, dotY, 2, 2 ); }
    });
  } else if (_mapOp.indexOf('大学') > -1) {
    Array.from(collg).forEach((d) => {
      dotX = mapX(d[0] );
      dotY = mapY(d[1] );
      if (withinSVG(dotX, dotY)) {
        dots_count += 1;
        map.beginPath();
        map.fillRect(dotX, dotY, 3, 3 ); }
    });
  } else { // 盒马
    Array.from(hema).forEach((d) => {
      dotX = mapX(d[0] );
      dotY = mapY(d[1] );
      if (withinSVG(dotX, dotY)) {
        dots_count += 1;
        map.beginPath();
        map.fillRect(dotX, dotY, 3, 3 ); }
    });
  }
  map.fillText(_mapOp + dots_count + '处', 0,2); // 盒马
  map.fillStyle = 'silver';
  map.fillText('制图 https://teach.bio @the_paper_link', svgWidth - fontSize * 18.6,2);
  let dots;
  const river0 = JSON.parse(river);
  const river1 = topojson.feature(river0, river0.objects.collection);
  map.strokeStyle = 'rgba(0,0,255,0.2)';
  map.lineWidth = 6;
  river1.features.forEach((d) => {
    map.beginPath();
    // dots = d.geometry.coordinates;
    // map.moveTo(mapX0(dots[0][0]), mapY0(dots[0][1]));
    // for (i = 1; i < dots.length; i += 1) {
    //   map.lineTo(mapX0(dots[i][0]), mapY0(dots[i][1]));
    // }
    pg(d);
    map.stroke();
  });
  let line_dot_must_shown1 = false;
  const line0 = JSON.parse(lines);
  const line1 = topojson.feature(line0, line0.objects.collection);
  map.strokeStyle = 'rgba(0,0,255,0.3)';
  map.lineWidth = 1.0;
  line1.features.forEach((d) => {
    map.beginPath();
    dots = d.geometry.coordinates;
    // map.moveTo(mapX0(dots[0][0]), mapY0(dots[0][1]));
    // if (!line_dot_must_shown1 &&
    //     withinSVG(mapX0(dots[0][0]), mapY0(dots[0][1])) ) {
    //   line_dot_must_shown1 = true;
    // }
    for (i = 0; i < dots.length; i += 1) {
      // map.lineTo(mapX0(dots[i][0]), mapY0(dots[i][1]));
      if (!line_dot_must_shown1 &&
          withinSVG(mapX0(dots[i][0]), mapY0(dots[i][1])) ) {
        line_dot_must_shown1 = true;
      }
    }
    pg(d);
    map.stroke();
  });
  if (!line_dot_must_shown1) {
    d3scale = Math.floor(d3scale/2);
    draw_sh();
  }
}

// let _addr_manual = 0;
function draw_addr (s, mustRed) {
  let _R = 'rgba(255,0,0,';
  if (!mustRed && _check && _check.substr(0,8) === 'released') {
    _R = 'rgba(17,131,1,';
  }
  //if (typeof s !== 'string') {
  //} else
  if (s.indexOf(',') > 0) {
    s = s.substr(0, s.indexOf(','));
  }
  if (Ms.indexOf(s) > -1) {
    map.beginPath();
    map.arc(mapX( Ml.locations[s][0] ),
            mapY( Ml.locations[s][1] ),
            3, 0 * Math.PI, 2 * Math.PI);
    if (Ml.locations[s][2]) {
      map.strokeStyle = _R + '1)';
    } else {
      map.strokeStyle = _R + '.75)';
    }
    map.stroke();
  } else if (s !== 'undefinedshanghaifabu') {
    console.log('市 区 未显示', s);
    dotNotDraw += 1; // 市 区
  }
  // save to _addr_manual.txt
  // if (!(_addr_manual%3)) {
  //   map.fillStyle = 'black';
  //   map.fillText(_addr_manual,
  //     mapX( Ml.locations[s][0] ),
  //     mapY( Ml.locations[s][1] ) );
  //   console.log(_addr_manual, s);
  // }
  // _addr_manual += 1;
}

function draw_grey (kd, item) {
  const wdl = W.pairs[kd];
  item.onclick = null;
  item.style.cursor = 'default';
  map.fillStyle = 'grey';
  //console.log(d3scale, kd);
  wdl.forEach((d) => {
    map.beginPath();
    map.fillRect(mapX( Ml.locations[d][0] )-1.5,
                 mapY( Ml.locations[d][1] )-1.5,
                 3, 3 );
  });
}

function draw_addr_withLabel (s, t) {
  map.fillStyle = 'black';
  map.beginPath();
  map.fillRect(mapX( Ml.locations[s][0] )-1.5,
               mapY( Ml.locations[s][1] )-1.5,
               3, 3 );
  if (t) {
    map.fillText(s+t, 1.5+mapX( Ml.locations[s][0] ),
                      1.5+mapY( Ml.locations[s][1] ));
  } else {
    map.fillText(s, 1.5+mapX( Ml.locations[s][0] ),
                    1.5+mapY( Ml.locations[s][1] ));
  }
}

function draw_sh_addr (jcDi, tt) {
  let ii;
  let map_i = 0;
  draw_sh();
  let ttf;
  if (tt && tt.substr(0,3) !== '上海市') {
    ttf = tt.substr(0,3);
  }
  if (jcDi) {
    for (ii = 0; ii < jcDi.length; ii += 1) {
      if (!ttf || jcDi[ii].substr(0,3) === ttf) {
        draw_addr(jcDi[ii]);
        map_i += 1;
      }
    }
  } else {
    for (i = 0; i < Ds.length; i += 1) {
      if (!j[_check] || !j[_check][Ds[i] ]) {
        continue;
      }
      if (ttf && Ds[i].substr(0,3) !== ttf) {
        continue;
      }
      for (ii = 0; ii < j[_check][ Ds[i] ].length; ii += 1) {
        draw_addr(Ds[i] + j[_check][ Ds[i] ][ii]);
        map_i += 1;
      }
    }
  }
  map.fillStyle = 'black';
  let _c = check_choices[_check];
  if (_check === 'still_in') {
    _c = '最近' + _still_in + '日上榜';
  }
  if (map_i && dotNotDraw) {
    map.fillText((tt || '上海市' + _c) + map_i +
                 '个地址 未显示其中' + dotNotDraw + '个 2022/' + _today,
                 0,svgHeight-1-fontSize);
    dotNotDraw = 0;
  } else if (map_i) {
    map.fillText((tt || '上海市' + _c) + ' ' + map_i +
                 '个地址 2022/' + _today,
                 0,svgHeight-1-fontSize);
  } else if (!map_i && tt) {
    onListAppend(0, null, null, '无' + tt);
  } else {
    onListAppend(0, null, null, '上海市无' + _c);
  }
}

function dldl (k_, d_) {
  const dl = j.address[d_];
  const s1 = (dl || []).join(',').split(k_);
  let kii; let il = 0;
  for (kii = 0; kii < Ds.length; kii += 1) {
    if (j.districts[ Ds[kii] ].indexOf(d_) > -1) {
      il += 1;
    }
    if (Ds[kii] === k_) { break; }
  }
  let s2; const dldl = [];
  //console.log(k_, d_, il, s1);
  if (il !== 1) { // 地址同名, 团结村 国权北路555 邯郸路20 星火村 五四村
    while (s1.length > 1) {
      s2 = s1.shift();
      if (s2) {
        dldl.push( s2.substr(s2.lastIndexOf(',') + 1) );
      }
    }
  } else {
    for (s2 = 0; s2 < dl.length; s2 += 1) {
      if (dl[s2].length === 4) {
        dldl.push( dl[s2] );
      }
    }
  }
  return dldl;
}

function init_map () {
  map.clearRect(0, 0, svgWidth, svgHeight);
  scale2x_button.style.visibility = 'hidden';
  scale2x_button1.style.visibility = 'hidden';
  svgWidth = 640;
  svgHeight = 480;
  fontSize = 10; // 10px Microsoft YaHei
}
let map_mustLabel;

function search (kt, pngNot) {
  let k = trim(kt);
  if (!k) {
    addr.value = '';
    addr.focus();
    app.style.display = 'none';
    check_row.style.display = 'none';
    clear_button.style.visibility = 'hidden';
    window.location.replace(baseURL + '#' + j.tag); // #hash
    return;
  }
  if (addr.value !== k) {
    addr.value = k;
  }
  window.location.replace(baseURL + '#' + j.tag + '?' + k);
  //document.title = 'sh.teach.bio/2 ? ' + k + '  2022/' + _today;
  lastAddrFirstTag = null;
  onList.textContent = '';
  init_map();
  if (scaleChange) { d3scale = 72000; }
  let ii;
  if (nextSpecial && nextSpecial.endsWith(addr.value)) {
    k = nextSpecial.substr(0, nextSpecial.indexOf('区')+1);
    //_check = 'today';
    // released_today, released,
    // districts, inB, today, latest_added, latest_added2, latest_added7
  } else {
    nextSpecial = '';
  }
  if (Ds.indexOf(k) > -1) { //各区
    // if (!j.today[k]) { // .latest_added [_check]
    //   addr.value = '';
    //   addr.focus();
    //   app.style.display = 'none';
    //   check_row.style.display = 'none';
    //   return;
    // }
    // if (k === '崇明区') {
    //   if (scaleChange && d3scale < 32000) {
    //     d3scale = 32000; }
    // } else if (k === '黄浦区') {
    //   if (scaleChange && d3scale < 192000) {
    //     d3scale = 192000; }
    // } else if (sh_district7.indexOf(k) > -1) {
    //   if (scaleChange && d3scale < 128000) {
    //     d3scale = 128000; }
    // }
    if (!nextSpecial &&
        (scaleChange || (hash2 && hash2.indexOf(k) !== 0))) {
      d3scale = centers[k][2];
    }
    if (!nextSpecial) {
      d3center = [centers[k][0], centers[k][1] ];
    }
    draw_sh();
    if (nextSpecial) {
      draw_addr_withLabel(nextSpecial);
    }
    if (j[_check] && j[_check][k]) {
      for (ii = 0; ii < j[_check][k].length; ii += 1) { // .today
        draw_addr(k + j[_check][k][ii]);
        if (['latest_added2', 'latest_added7', 'latest_added', 'still_in'
            ].indexOf(_check) > -1) {
          if (_check === 'latest_added' && j.latest_added2 &&
                     j.latest_added2[k] &&
                     j.latest_added2[k].indexOf( j[_check][k][ii] ) === -1) {
            onListAppend(ii+1, k, j[_check][k][ii],
                         '在“一阴阳”<span>不在“三阴阳”</span>');
          } else if (_check === 'latest_added2' && j.latest_added7 &&
                     j.latest_added7[k] &&
                     j.latest_added7[k].indexOf( j[_check][k][ii] ) === -1) {
            onListAppend(ii+1, k, j[_check][k][ii],
                         '在“三阴阳”<span>不在“七阴阳”</span>');
          } else if (_check === 'still_in')  {
            onListAppend(ii+1, k, j[_check][k][ii][0], (
j.tag === '0'+j[_check][k][ii][1] ) ? '' : '截至' + hash2date(j.tag) +
                                           ' 最近上榜于' + digi2date(j[_check][k][ii][1])
                         );
          } else {
            onListAppend(ii+1, k, j[_check][k][ii]);
          }
        }
      }
    } else {
      onListAppend(0, null, null, k + '无' + check_choices[_check] );
    }
    if (_check === 'today') {
      asyncFirstSince0306(k);
    } else if (_check === 'inB' && parseInt(j.tag) > 312) {
      async7in14(k);
    } else if (_check === 'districts' && parseInt(j.tag) > 405) {
      asyncList30times(k);
    }
    map.fillStyle = 'black';
    let _c = check_choices[_check];
    if (_check === 'still_in') {
      _c = '最近' + _still_in + '日上榜';
    }
    if (dotNotDraw) {
      map.fillText(k + _c + j[_check][k].length +
                   '个地址 其中' + dotNotDraw + '个无法显示 2022/' + _today,
                   0,svgHeight-1-fontSize);
      dotNotDraw = 0;
    } else if (j[_check] && j[_check][k]) {
      map.fillText(k + _c + ' ' + j[_check][k].length +
                   '个地址 2022/' + _today,
                   0,svgHeight-1-fontSize);
    }
    check_row.style.display = 'block';
    updateCheckStatus();
    addr.scrollIntoView(); //save_button
    clear_button.style.visibility = 'visible';
    if (autoSavePNG && !pngNot) {
      exportCanvasAsPNG();
    }
    return;
  } else if (k === '上海市') {
    svgWidth = 1250;
    svgHeight = 1000;
    fontSize = 14;
    d3center = [centers['徐汇区'][0], centers['徐汇区'][1] ]; // 黄浦
    if (d3scale < 48000) {
      d3scale = 48000; }
    if (!scaleChange && (hash2 && hash2.indexOf(k) !== 0) ) {
      ester_egg.textContent = '保留了原关注地址；可__重置__查看全市';
      reload_button.textContent = '重置可以查看全市';
      reload_button.style.fontWeight = 'bold';
      setTimeout(
        function () {
          reload_button.textContent = '重置';
          reload_button.style.fontWeight = 'normal';
        },
        1000 * 5
      );
    }
    draw_sh_addr();
    if (_check === 'today') {
      asyncFirstSince0306();
    } else if (_check === 'inB' && parseInt(j.tag) > 312) {
      async7in14();
    } else if (_check === 'districts' && parseInt(j.tag) > 405) {
      asyncList30times();
    } else if (['latest_added2', 'latest_added7', 'latest_added', 'still_in'
               ].indexOf(_check) > -1) {
      generalAppend();
    }
    check_row.style.display = 'block';
    updateCheckStatus();
    save_button.scrollIntoView(); //addr
    clear_button.style.visibility = 'visible';
    if (autoSavePNG && !pngNot) {
      exportCanvasAsPNG();
    }
    return;
  }
  // 搜索地址
  //auto_save_off();
  if (!lastSearch || lastSearch !== k) {
    console.log('Input', k);
  }
  if (k.substr(0,4) === '浦东新区') {
    k = k.substr(4);
    addr.value = k;
  } else if (['上海市', '黄浦区', '静安区', '徐汇区', '长宁区',
              '普陀区', '虹口区', '杨浦区', '宝山区', '闵行区',
              '嘉定区', '金山区', '松江区', '青浦区', '奉贤区', '崇明区'].indexOf(
             k.substr(0,3) ) > -1) {
    k = k.substr(3);
    addr.value = k;
  }
  if (k.indexOf('=') > -1) {
    k = k.split('=')[0];
    addr.value = k;
    _check = check_choices['0'];
  }
  scale2x_button.style.visibility = 'visible';
  scale2x_button1.style.visibility = 'visible';
  check_row.style.display = 'none';
  // for (ii = 0; ii < Ds.length; ii += 1) {
  //   document.getElementById(Ds[ii]).style.background = 'white';
  //   document.getElementById(Ds[ii] + 'line').textContent = '';
  //   th_k.textContent = '';
  // }
  th_k.textContent = '';
  Ds.forEach((d) => {
    document.getElementById(d).style.background = 'white';
    document.getElementById(d + 'line').textContent = '';
  });
  let kk; let ks; let sb = 0;
  let map_i = 0;
  map_mustLabel = '';
  const map_x = [];
  const map_y = [];
  const map_addr = [];
  let release;
  for (i = 0; i < As.length; i += 1) {
    if (As[i].indexOf(k) > -1) {
      for (ii = 0; ii < Ds.length; ii += 1) {
        release = 0;
        if (j.districts[ Ds[ii] ].indexOf(As[i]) > -1) {
          //console.log(Ds[ii]);
          document.getElementById(Ds[ii]).style.background = 'yellow';
          document.getElementById(Ds[ii] + 'line').textContent += '|';
          sb += 1;

//onList.textContent += Ds[ii] + ',' + As[i] + ': ' + dl;
const dl = dldl(Ds[ii], As[i]);
ks = init_ks(Ds[ii], As[i], sb, dl);
if (map_i > 1 || lastSearch) {
  ks += '<span class="click" onclick="search(this.textContent);">' + Ds[ii] + '</span>';
  ks += '<span class="click _L" onclick="lastSearch=\''+k+'\';search(\'';
} else {
  ks += '<span class="click _L" onclick="search(this.textContent);">' + Ds[ii] + '</span>';
  ks += '<span data-click="lastSearch=\''+k+'\';search(\'';
}
// scaleChange=true;
if (lastSearch && lastSearch !== As[i] &&
    As[i].indexOf(lastSearch) > -1 ) { // 非精确地址 启用
  ks += lastSearch + '\');" title="点击返回 ' + lastSearch + '">';
} else {
  ks += As[i] + '\');">';
}
ks += As[i] + '</span> ';
if (Ms.indexOf(Ds[ii] + As[i]) > -1) {
  map_i += 1;
} else {
  console.log('搜索地址 未显示', Ds[ii] + As[i]);
  dotNotDraw += 1; // 搜索地址
}
if (dl.length > 0) {
  if (dl.join(',').indexOf(j.tag) > -1) {
    map_mustLabel += ',' + Ds[ii] + As[i];
    ks += '<span style="color:red">' + tagsHTML(dl) + '</span>';
  } else {
    ks += tagsHTML(dl);
  }
  release = parseInt( dl.slice(-1)[0] );
}
if (release) {
  release += (14 - 300);
  if (release < 32) {
    //onList.textContent += ' --> 4/' + release + '\n';
    ks += ' &rarr; 3/' + release +
          ' <span style="color:green">已满14天</span>';
  } else if (release < 131) { // release 4月30+1
    if (release > 100) {
      release -= 100;
    } else {
      release -= 31;
    }
    ks += ' &rarr; 4/' + release +
          ' <span style="color:green">已满14天</span>';
  } else if (release < 232) { // release 5月31+1
    if (release > 200) {
      release -= 200;
    } else {
      release -= 130;
    }
    ks += ' &rarr; 5/' + release +
          ' <span style="color:green">已满14天</span>';
  } else {
    if (release > 300) { // 类似4月
      release -= 300;
    } else {
      release -= 231;
    }
    ks += ' &rarr; 6/' + release;
    if (release < today.getDate() ) {
      ks += ' <span style="color:green">已满14天</span>';
    } else if (release === today.getDate() ) {
      ks += '<span style="color:green">是第14天</span>';
    }
  }
}
if (_ww && _ww.indexOf(Ds[ii] + As[i]) > -1) {
  ks += kd_related_ww(Ds[ii], As[i]);
}
kk = document.createElement('p');
//kk.id = As[i];
kk.innerHTML = ks;
onList.appendChild(kk);
map_x.push(parseFloat( Ml.locations[Ds[ii] + As[i]][0] ));
map_y.push(parseFloat( Ml.locations[Ds[ii] + As[i]][1] ));
map_addr.push( Ds[ii] + As[i] );

        //if
        }
      }
    }
  }
  if (map_i === 0) {
    app.style.display = 'none';
    next_button.setAttribute('data-value', '');
    next_button.style.border = '';
    next_button2.style.border = '';
    onListAppend(0, k.substr(0, k.length - 1), null, '&larr;可尝试');
  } else {
    if (map_i === 1 && map_addr[0].endsWith(k)) {
      ester_egg.textContent = '同区数据比较 建议先缩放 再点右箭头';
      next_button.setAttribute('data-value', map_addr[0]);
      if (parseInt(j.tag) !== j_data_init) {
        next_button.style.border = '.25em solid red';
        next_button2.style.border = '.25em solid red';
      }
    } else if (map_i === 1) {
      ester_egg.textContent = '搜索 ' + map_addr[0].substr(
                                      map_addr[0].indexOf('区')+1 ) +
                              ' 可开启同区数据比较';
    } else {
      lastAddrFirstTag = null;
    }
    draw_sh_multi(k, map_i, map_x, map_y, map_addr);
  }
  if (sb === 0) {
    addr.focus();
    ester_egg.textContent = addr.value + ' 无结果';
    // search_button.textContent = '无结果，可输入再搜';
    // setTimeout(
    //   function () {
    //     search_button.textContent = '搜索';
    //   },
    //   1000 * 5
    // );
  } else {
    // search_button.textContent = '查到' + sb + '个地址，可输入再搜';
    // setTimeout(
    //   function () {
    //     search_button.textContent = '搜索';
    //   },
    //   1000 * 5
    // );
    clear_button.style.visibility = 'visible';
  }
  if (autoSavePNG && !pngNot) {
    exportCanvasAsPNG();
  }
}

function draw_sh_multi (k, map_i, map_x, map_y, map_addr) {
  let ii;
  addr.scrollIntoView();
  if (k.indexOf('数据组') === -1) th_k.textContent = k;
  if ((!d3center || scaleChange) &&
      k.substr(0,2) !== '各区' ) {
    d3center = [average(map_x), average(map_y) ];
  }
  let d3scale_;
  const map_XYlarge = Math.max.apply(null, [
    Math.max.apply(null, map_x) - Math.min.apply(null, map_x),
    Math.max.apply(null, map_y) - Math.min.apply(null, map_y) ]);
  // 黄浦区 0.0531 ~ 192000
  d3scale_ = parseInt(0.0531/map_XYlarge * 200000);
  //console.log('scale max', d3scale_);
  let map_XYtest = svgWidth;
  let map_XYzero;
  const localMinimal = [];
  if (withinSVG(mapX(map_x[0]), mapY(map_y[0])) &&
      j.address[map_addr[0].substr(map_addr[0].indexOf('区')+1)] ) {
    localMinimal.push([map_addr[0], map_y[0], map_x[0], 999-parseInt(
      j.address[map_addr[0].substr(map_addr[0].indexOf('区')+1)][0].substr(0,4) )]);
  }
  for (ii = 1; ii < map_i; ii += 1) {
    for (i = ii; i < map_i; i += 1) {
      map_XYzero = Math.sqrt(
        Math.pow((mapX(map_x[i])-mapX(map_x[i-ii])), 2) +
        Math.pow((mapY(map_y[i])-mapY(map_y[i-ii])), 2) );
      if (map_XYzero) {
        map_XYtest = Math.min.apply(null, [map_XYtest, map_XYzero]);
      }
    }
    if (withinSVG(mapX(map_x[ii]), mapY(map_y[ii])) &&
        j.address[map_addr[ii].substr(map_addr[ii].indexOf('区')+1)] ) {
      localMinimal.push([map_addr[ii], map_y[ii], map_x[ii], 999-parseInt(
        j.address[map_addr[ii].substr(map_addr[ii].indexOf('区')+1)][0].substr(0,4) )]);
    }
  }
  // .arc(3) 0.0004325 ~ 589319
  d3scale_ = Math.max.apply(null, [36000, d3scale_, Math.floor(d3scale_ * 3/map_XYtest )]);
  //console.log('scale min',
  //            Math.floor(d3scale_ * 3/map_XYtest ), ', used', d3scale_);
  //while (d3scale_ > 72000 * 16) { // line_dot_must_shown1
  //  d3scale_ = Math.floor(d3scale_/2);
  //}
  console.log('地址', k, _check, '更新前'+d3scale,
              scaleChange, d3scale_ ? '计算值'+d3scale_ : '无计算值' );
  if (d3scale_ && scaleChange && map_i < 100 && map_i > 1 &&
      k.substr(0,2) !== '各区' ) {
    d3scale = d3scale_;
  }
  if (!scaleChange && d3scale > d3scale_) {
    ester_egg.textContent = '可__重置__展示所有地址';
    // reload_button.textContent = '重置';
    // reload_button.style.fontWeight = 'bold';
    // setTimeout(
    //   function () {
    //     reload_button.textContent='重置';
    //     reload_button.style.fontWeight = 'normal';
    //   },
    //   1000*5
    // );
  }
  draw_sh();
  // for (i = 0; i < map_i; i += 1) {
  //   draw_addr(map_addr[i]);
  // }
  map_addr.forEach((d) => {
    draw_addr(d, true);
  });
  map.fillStyle = 'rgba(255,0,0,0.4)';
  if (map_mustLabel && map_mustLabel !== '') {
    console.log('当日阳', map_mustLabel.substr(1));
  }
  if (map_i > 1) {
    let labelNotDraw;
    let _Y; const gray_Y = [];
    for (i = 0; i < map_i; i += 1) {
      if (map_mustLabel && map_mustLabel.indexOf(map_addr[i]) > 0) {
        _Y = mapY(map_y[i]);
        gray_Y.push(_Y);
        map.fillText(map_addr[i],
                     mapX(map_x[i]) + 3, _Y);
      }
    }
    if (localMinimal.length > 1) {
      gray_Y.push(mapY( localMinimal[0][1] ));
      localMinimal.slice(1).forEach((d) => { //Array.from(
        if (!map_mustLabel || map_mustLabel.indexOf(d[0]) === -1) {
          labelNotDraw = false;
          _Y = mapY(d[1]);
          for (i = 0; i < gray_Y.length; i += 1) {
            if (Math.abs(_Y - gray_Y[i]) < fontSize+2) {
              labelNotDraw = true;
              break;
            }
          }
          if (!labelNotDraw) {
            gray_Y.push(_Y);
            map.fillText(d[0].substr(d[0].indexOf('区')+1),
                         mapX(d[2]) + 3, _Y);
          }
        }
      });
    }
  }
  if (localMinimal.length && k.indexOf('数据组') === -1) {
    bubble2(localMinimal, 3);
    draw_addr_withLabel(localMinimal[0][0],
                        '上榜于' + digi2date(999-localMinimal[0][3]) );
  }
  map.fillStyle = 'red';
  if (dotNotDraw) {
    map.fillText('【' + k + '】' + (map_i + dotNotDraw) +
                 '个地址 显示了其中' + map_i + '个 2022/' + _today,
                 0,svgHeight-1-fontSize);
    dotNotDraw = 0;
  } else {
    map.fillText('【' + k + '】' + map_i + '个地址 2022/' + _today,
                 0,svgHeight-1-fontSize);
  }
}

function show_full (item) {
  const t = document.getElementById(item).getAttribute('data-value');
  if (t === "1") {
    document.getElementById(item).style.display = 'block';
    if (document.getElementById(item + '_once')) {
      document.getElementById(item + '_once').style.visibility = 'hidden';
    }
    document.getElementById(item).setAttribute('data-value', '0');
  } else {
    document.getElementById(item).style.display = 'none';
    document.getElementById(item).setAttribute('data-value', '1');
  }
}

function auto_save_off () {
  autoSavePNG = false;
  auto_save_status.style.boxShadow = '';
  pre_button.style.border = '';
  next_button.style.border = '';
  auto_save_.style.visibility = 'hidden';
  pngGif.style.visibility = 'hidden';
  const url = window.location.toString().split('=')[0];
  window.location = url;
}

function updateCheckStatus () {
  const checkboxes = document.getElementsByName('check');
  Array.from(checkboxes).forEach((d) => {
    if (_check === check_choices[d.getAttribute('data-value')] ) {
      d.checked = true;
    } else {
      d.checked = false;
    }
  });
  Array.from( document.getElementsByName('sets') ).forEach((d) => {
    d.checked = false;
  });
}

function scale2x (r) {
  if (['市', '区'].indexOf(
      addr.value.slice(-1)[0] ) > -1 ) {
    window.alert('搜索地址时，可放大一倍。刷新页面，可重置');
    return false;
  }
  lastSearch = addr.value;
  if (r) {
    d3scale = d3scale / 2;
    scale2x_button1.style.visibility = 'hidden';
    setTimeout(
      function () {
        scale2x_button1.style.visibility = 'visible';
      },
      1000 * 5
    );
  } else {
    d3scale = d3scale * 2;
    scale2x_button.style.visibility = 'hidden';
    setTimeout(
      function () {
        scale2x_button.style.visibility = 'visible';
      },
      1000 * 5
    );
  }
  updateLocation(parseInt(j.tag), addr.value);
}

// https://stackoverflow.com/questions/9709209/
function onlyOne (I) {
  const checkboxes = document.getElementsByName('check');
  Array.from(checkboxes).forEach((d) => {
    if (d !== I) d.checked = false;
  });
  _check = check_choices[I.getAttribute('data-value')];
  //console.log('data-value >', _check, j[_check]);
  search(addr.value, true);
}

function mapOp (I) {
  const checkboxes = document.getElementsByName('map');
  Array.from(checkboxes).forEach((d) => {
    if (d !== I) d.checked = false;
  });
  _mapOp = '已' + I.parentNode.textContent;
  search();
}

function zero_people (s) {
  if (s && s.indexOf('0') > -1 &&
      s.indexOf('0') < 5 ) { // 不可能出现 男0女0
    s = s.substr(0, s.indexOf('0')-1) +
        s.substr(s.indexOf('0')+1);
  }
  return s;
}

function setsOp (I) {
  const checkboxes = document.getElementsByName('sets');
  Array.from(checkboxes).forEach((d) => {
    if (d !== I) d.checked = false;
  });
  Array.from( document.getElementsByName('check') ).forEach((d) => {
    d.checked = false;
  });
  const arr_ = I.getAttribute('data-value');
  if (arr_ === "0" &&
      Ds.indexOf(addr.value) === -1) {
    window.alert('无法展示' + (addr.value || '空') + '的早期数据');
    I.checked = false;
    return false;
  }
  onList.textContent = '';
  init_map();
  let ki = 0;
  const map_x = [];
  const map_y = [];
  const map_addr = [];
  _m0f0_sets['arr' + arr_].forEach((d) => {
    if (arr_ !== '0' || d[0] === addr.value) {
      ki += 1;
      map_x.push(parseFloat( Ml.locations[d[0] + d[1]][0] ));
      map_y.push(parseFloat( Ml.locations[d[0] + d[1]][1] ));
      map_addr.push(d[0] + d[1]);
      if (_m0f0[j.tag + 'cut' + explode_cutoff] &&
          _m0f0[j.tag + 'cut' + explode_cutoff].indexOf(d[0] + d[1]) > -1) {
        onListAppend(ki, d[0], d[1], zero_people(d[2])+'|上榜后超'+explode_cutoff+'次 ');
      } else if (j.address[ d[1] ].length > 1) {
        onListAppend(ki, d[0], d[1], zero_people(d[2])+'|上榜后 ');
      } else {
        onListAppend(ki, d[0], d[1], zero_people(d[2]) );
      }
    }
  });
  if (I.parentNode.textContent !== '各区') d3scale = 36000;
  if (arr_ !== '0' ||
      Ds.indexOf(addr.value) === -1) addr.value = '';
  if (map_addr.length > 0) {
    console.log('will draw sets with', map_addr.length, 'addresses');
    draw_sh_multi(I.parentNode.textContent + '数据组',
                  ki, map_x, map_y, map_addr );
  } else {
    window.alert(j.tag+ '无' + I.parentNode.textContent + '数据');
    I.checked = false;
  }
}
  </script>
  <!-- SukkaW/DisqusJS -->
  <script src="shanghaifabu/html2canvas.min.141.js"></script>
  <script src="shanghaifabu/FileSaver.min.205.js"></script><!-- https://cdnjs.com/ -->
  <script src="shanghaifabu/jszip.min.391.js"></script>
  <style>
    body { background-color: white; }
    p { line-height: 1.5em; }
    .click,
    button,
    label> input[type=checkbox],
    #auto_save_status {
      cursor: pointer;
    }
    button { padding-top: .2em; }
    table> thead,
    #districtTbody {
      color: blue;
      font-size: 75%;
      text-align: center;
    }
    table {
      border-top: 1px solid blue;
      border-bottom: 1px solid blue;
      border-collapse: collapse;
    }
    tbody> tr {
      border-top: 1px solid blue;
    }
    #divToday,
    #divLatestReleased,
    #divReleased {
      list-style-type: none;
      font-size: 75%;
    }
    ._L {
      padding: 0 .2em;
      box-shadow: inset 0 -.5em #d0d0d0;
      border: 0;}
    #th_k {
      text-align: left;
      color: blue;
      font-weight: normal;
    }
    #april, #may, #march, #june {
      border: 0;
      box-shadow: inset 0 -3px #d0d0d0;
    }
    #check_row, #map_options {
      font-size: 75%;
    }
    #map_options { float: right; }
    #check_row label,
    #map_options label {
      display: inline-block;
      padding-right: .5em;
      /* padding-left: 22px;
      text-indent: -22px; */
    }
    #map_options input,
    #map_options label>span,
    #check_row input,
    #check_row label>span,
    p> #addr,
    p> button,
    p> label> span {
      vertical-align: middle;
    }
    #addr { color: red; }
    #search_button {
      font-weight: bold;
    }
    #pngGif {
      border: .25em solid cyan;
      background-color: rgba(44,255,255, 0.5);
      opacity: 0.5;
      padding: 0 1em;
      position: fixed;
      top: 14px;
      right: 0px;
    }
    #auto_save_status {
      width: 36px;
      display: inline-block;
      text-align: center;
    }
    .inAB_close_click,
    .inAB_close {
      color: grey;
      padding-left: 6em;
      font-size: 75%;
    }
    .inAB_close_click {
      padding-left: 1.6em;
      cursor: pointer;
    }
    em,
    span.em,
    #end_pre {
      color: grey;
    }
    em> span {
      color: white;
      background-color: grey;
      font-size: 90%;
      margin-left: .5em;
    }
    #_still, #_setEx {
      border: 0;
      padding: 0;
      margin: 0;
      text-align: center;
      color: red;
    }
    #ester_egg,
    .tag_note {
      vertical-align: middle;
      color:grey;
      font-size: 75%;
    }
    #ester_egg { background-color: yellow; }
    #onList> p {
      margin: 0;
      padding: 0 0 0 4em;
      text-indent: -4em;
    }
    #_still, #_setEx,
    #april, #may, #march, #june {
      width: 1.5em;
    }
  </style>
</head>
<body onload="load_js();">
  <p>
    数据来源 <a href="https://wsjkw.sh.gov.cn/xwfb/index.html" target="_blank">shanghaifabu</a>
      <!-- span id="datestr" style="color:grey;"></span -->
      <span id="fetching" style="color:blue;"> <span id="loading_pr2">not ready,</span> loaded</span>
    <br/>展示<span style="background-color:yellow;">2022年<span id="tag_m"></span>月<span id="tag_d"></span>日</span>的数据
    <!-- br/>搜索<span onclick="search(this.textContent);" class="click _L">上海市</span> 可以在地图中定位相关地址 -->
  </p>
  <p>
    <label for="addr"><span style="color:red;font-weight:bold;">上榜地址</span>
      <input type="text" id="addr" name="addr" onkeydown="lastSearch=null;addrEnter();" /></label>
    <button id="search_button" onclick="scaleChange=true;lastSearch=null;search(addr.value);">搜索</button>
    &nbsp; <span class="tag_note">以下基于2022/<span class="_tag"></span>的数据</span>
    &nbsp; <span id="ester_egg"></span>
  </p>

  <div id="pngGif"></div>
  <button id="save_button" onclick="exportCanvasAsPNG(1);">存图</button>
  <button onclick="preReload(addr.value,1);">&lt;&lt;</button>
  <button id="pre_button" onclick="preReload(addr.value);">&lt;</button>
  <span id="auto_save_status" class="_tag">/</span>
  <button id="next_button" data-value="" style="visibility:hidden;" onclick="nextReload(addr.value);">&gt;</button>
  <button id="next_button2" onclick="nextReload(addr.value,1);">&gt;&gt;</button>
  <button id="clear_button" style="visibility:hidden;" onclick="search();">隐图</button>
  <button id="scale2x_button" style="visibility:hidden;" onclick="scale2x();">&plus;</button>
  <button id="scale2x_button1" style="visibility:hidden;" onclick="scale2x(1);">&minus;</button>
  <button id="reload_button" onclick="window.location.reload();">重置</button>
  <span id="fetching2" style="color:blue;">Loading<span id="loading_span"></span>
    <span id="loading_pr"></span></span>
  <span id="auto_save_" style="color:cyan;">自动缓存&rarr;</span><br/>

  <canvas id="app" style="display:none;"></canvas>
  <!-- 3.district 2.inB 0.today 4.released 5.released_today 1.latest_added -->
  <div id="check_row" style="display:none;">
    <label><span>3月6日 至 <span id="tag_m2"></span>月<span id="tag_d2"></span>日
           </span></label>
    <label id="check7" style="display:none;"><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="7" /><span style="color:red">七阴阳</span></label>
    <label id="check6" style="display:none;"><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="6" /><span style="color:red">三阴阳</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="1" /><span style="color:red">比昨日多</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="0" /><span style="color:red">当日阳</span></label>
    <label style="padding-right:0px"><input type="checkbox" name="check" onclick="onlyOne(this)"
      style="margin-right:0;" data-value="8" /></label><input type="text" id="_still" name="_still"
      onkeydown="stillEnter();" /><span style="color:red;vertical-align:middle;padding-right:.5em;">日阳</span>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="2" /><span style="color:red">两周阳</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="3" /><span style="color:red">累计阳</span></label>
    <label id="check4"><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="4" /><span style="color:green">累计下榜</span></label>
    <label id="check5"><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="5" /><span style="color:green">当日下榜</span></label>
  </div>

  <div style="width:100%;color:blue;" id="onList"></div>

  <div id="map_options">
    <br/>
    <label><span>地图</span></label>
    <label><input type="checkbox" name="map" onclick="mapOp(this)" checked
      /><span>标盒马门店</span></label>
    <label><input type="checkbox" name="map" onclick="mapOp(this)" style="visibility:hidden;"
      /><span>标中小学</span></label>
    <label><input type="checkbox" name="map" onclick="mapOp(this)" style="visibility:hidden;"
      /><span>标大学</span></label>
    <label><input type="checkbox" name="map" onclick="mapOp(this)" style="visibility:hidden;"
      /><span>标精致咖啡店</span></label>
    <br/>
    <label style="border-top:1px solid grey;width:100%;"><span>数据组</span>
      <span id="sets_label"></span>
      <span>&middot; 标记<span style="color:red;">上榜早</span>且累计上榜</span><input
        type="text" id="_setEx" name="_setEx" onkeydown="setsEnter();" /><span>次</span>
    </label>
    <br/>
    <label><input type="checkbox" name="sets" onclick="setsOp(this)" style="visibility:hidden;"
      data-value="1" /><span>幼儿</span></label>
    <label><input type="checkbox" name="sets" onclick="setsOp(this)" style="visibility:hidden;"
      data-value="2" /><span>高龄</span></label>
    <label><input type="checkbox" name="sets" onclick="setsOp(this)" style="visibility:hidden;"
      data-value="4" /><span>夫妻</span></label>
    <label><input type="checkbox" name="sets" onclick="setsOp(this)" style="visibility:hidden;"
      data-value="3" /><span>上学</span></label>
    <label><input type="checkbox" name="sets" onclick="setsOp(this)" style="visibility:hidden;"
      data-value="0" /><span>各区</span></label>
    <br/>
    <div style="border-top:1px solid grey;width:100%;padding-top:2px;margin-top:2px">日期跳至
      &nbsp; <span class="click april_button" onclick="jumpApr(addr.value,3);">3月</span><input type="text" id="march" name="march" onkeydown="aprilEnter(3);" />日
      &nbsp; <span class="click april_button" onclick="jumpApr(addr.value);">4月</span><input type="text" id="april" name="april" onkeydown="aprilEnter();" />日
      &nbsp; <span class="click april_button" onclick="jumpApr(addr.value,5);">5月</span><input type="text" id="may" name="may" onkeydown="aprilEnter(5);" />日
      <!-- &nbsp; <span class="click" class="april_button" onclick="jumpApr(addr.value,6);">6月</span><input type="text" id="may" name="may" onkeydown="aprilEnter(6);" />日 -->
      <br/>2022年2月7日零时，中风险清零；
      <br/>2月24日，首位本土感染者；3月6日开始公布感染者地址，目前仍在继续
    </div>
  </div>

  <h2 id="h2dist"><span onclick="search(this.textContent);" class="click">上海市</span>各区统计（地址数）</h2>
  <table>
    <thead><tr style="color:black;">
      <th>&nbsp;行政单位&nbsp;</th><th>&nbsp;累计上榜&nbsp;</th>
      <th id="th_k"></th><th>&nbsp;两周内&nbsp;</th><th>&nbsp;<span class="_tag"></span>涉及&nbsp;</th>
      <th>&nbsp;累计下榜&nbsp;</th><th>&nbsp;<span class="_tag"></span>下榜&nbsp;</th>
      <th id="th_hot" style="color:purple;"></th>
    </tr></thead>
    <tbody id="districtTbody"></tbody>
  </table>

  <h2 onclick="show_full('divToday');" style="color:red;" class="click">当日涉及的地址</h2>
  <div style="color:red;list-style-type:none;font-size:75%;" id="divToday"></div>

  <h2 onclick="show_full('divLatestReleased');" class="click _L"><span class="_tag"></span>下榜的地址<em id="divLatestReleased_once">点击显示</em></h2>
  <div style="color:green;display:none;" id="divLatestReleased" data-value="1"></div>

  <h2 onclick="show_full('divReleased');" class="click _L">累计下榜的地址<em id="divReleased_once">点击显示</em></h2>
  <div style="color:green;display:none;" id="divReleased" data-value="1"></div>

  <pre id="end_pre">EOF</pre>
  <p><a href="https://support.qq.com/products/410541" target="blank">我要留言</a></p>
</body>
</html>
