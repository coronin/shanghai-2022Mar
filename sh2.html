<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>sh listed address, since March 6th 2022</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <!-- script src="full.json"></script -->
  <script src="shanghaifabu/map-location.json?v=0518"></script><!-- @@ -->
  <script src="shanghaifabu/d3.min.v3.js"></script>
  <script src="shanghaifabu/topojson.min.180.js"></script><!-- http://geojson.io -->
  <script src="shanghaifabu/sh.json"></script><!-- http://datav.aliyun.com/portal/school/atlas/area_generator -->
  <script src="shanghaifabu/sh-awesome-cn-cafe.json"></script>
  <script src="shanghaifabu/sh-river.json"></script>
  <script src="shanghaifabu/sh-lines.json"></script>
  <script>
  let i; let j; const _J = {};
  let As; let Ds;
  const today = new Date();
  const j_data_init = 518; // @@
  let _today; // j.tag
  let Ml; let Ms; let map;
  let d3scale; let d3center; let svgWidth; let svgHeight;
  const centers = {
    黄浦区: [121.480694,31.219042,415000],
    徐汇区: [121.437778,31.160901,196000],
    长宁区: [121.378590,31.215582,300000],
    静安区: [121.448927,31.268736,219500],
    普陀区: [121.381162,31.264039,250000],
    虹口区: [121.486229,31.275661,280000],
    杨浦区: [121.523566,31.294815,220000],
    闵行区: [121.427945,31.107098,77000],
    宝山区: [121.381889,31.372927,90000],
    嘉定区: [121.248203,31.355204,87200],
    浦东新区: [121.612666, 31.12, 42000], // 浦东新区 121.61266647653576 31.08079112113293
    金山区: [121.24, 30.81, 70000], // 金山区 121.17171114485453 30.857028553162657
    松江区: [121.203370,31.013900,80000],
    青浦区: [121.096709,31.120809,66500],
    奉贤区: [121.529829,30.926042,82400],
    崇明区: [121.548589, 31.62, 32000] }; // 崇明区 121.54858925095525 31.669887634215034
  const sh_district7 = ['黄浦区', '徐汇区', '长宁区', '静安区', '普陀区', '虹口区', '杨浦区'];
  const ms = {3:'march', 4:'april', 5:'may'};
  const check_choices = {
    5:'released_today', 4:'released',
    3:'districts', 2:'inB', 1:'latest_added', 0:'today',
    released_today:'当日下榜', released:'累计下榜',
    districts:'累计阳', inB:'两周阳', latest_added:'比昨日多', today:'当日阳',
    latest_added2:'三阴阳', 6:'latest_added2',
    latest_added7:'七阴阳', 7:'latest_added7',
    still_in:'计算阳', 8:'still_in' };
  let _check = check_choices['0'];
  let dotNotDraw = 0;
  const baseURL = window.location.toString().split('#')[0].split('?')[0];
  let hash; let hash2; let autoSavePNG;
  let scaleChange = true;
  let lastSearch;
  let fontSize;
  let pngBase64 = {};
  let W; let _ww;
  let nextSpecial = '';
  let loadingBlock = false;

  function trim (s) { return (s || '').replace(/^\s+|\s+$/g, ''); }

  function bubble2 (arr, b2 = 1) {
    let done = false; let tmp;
    while (!done) {
      done = true;
      for (i = 1; i < arr.length; i += 1) {
        if (arr[i - 1][b2] < arr[i][b2]) {
          done = false;
          tmp = arr[i - 1];
          arr[i - 1] = arr[i];
          arr[i] = tmp;
        }
      }
    }
  }

  function cache14days () {
    return new Promise(resolve => {
      let afterD = parseInt(j.tag) - 14;
      if (331 < afterD && afterD <= 400) {
        afterD -= 69; // 401-14=387(318), 414-14=400(331)
      } else if (430 < afterD && afterD <= 500) {
        afterD -= 70; // 514-14=500(430), 501-14=487(417)
      }
      let dl; let ki; let kj; let kii;
      let kjd;
      for (const p in j.address) {
        for (kii = 0; kii < Ds.length; kii += 1) {
          if (j.districts[ Ds[kii] ].indexOf(p) > -1) {
            break;
        } }
        dl = j.address[p];
        kj = 0;
        kjd = '';
        for (ki = 0; ki < dl.length; ki += 1) {
          if (parseInt(dl[ki].substr(0,4) ) > afterD) {
            if (dl[ki].length > 4) { // 地址同名
              kjd += ',' + dl[ki];
            } else {
              kj += 1;
            }
          }
        }
        if (kj >= 7) {
          j.cached_14days.push(Ds[kii] + p);
          if (j.cache14days[Ds[kii]]) {
            j.cache14days[Ds[kii]].push( [p, kj] );
          } else {
            j.cache14days[Ds[kii]] = [ [p, kj] ];
          }
        }
        if (kjd && (kjd.match(/,/g) || []).length >= 7) {
          for (kii = 0; kii < Ds.length; kii += 1) {
            const re = new RegExp(Ds[kii], 'g');
            kj = (kjd.match(re) || []).length;
            if (kj >= 7) {
              j.cached_14days.push(Ds[kii] + p);
              if (j.cache14days[Ds[kii]]) {
                j.cache14days[Ds[kii]].push( [p, kj] );
              } else {
                j.cache14days[Ds[kii]] = [ [p, kj] ];
              }
            }
          }
        }
      }
      for (kii = 0; kii < Ds.length; kii += 1) {
        if (j.cache14days && j.cache14days[Ds[kii]]) {
          bubble2( j.cache14days[Ds[kii]] );
        }
      }
      resolve(1);
    });
  }

  async function async14days (k) {
    if (!j.cache14days) {
      j.cache14days = {};
      j.cached_14days = [];
      const v = await cache14days().catch(e => {
        return console.log(e);
      });
      if (v) {
        _J[j.tag] = j;
      }
    }
    let ki = 0;
    const kk = document.createElement('p');
    const tt = '两周内超7次上榜';
    if (j.cache14days && k && j.cache14days[k]) {
      kk.innerHTML = '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);' +
                     'draw_sh_addr(j.cached_14days,\'' +
                     k + tt + '\');">展示' + k + tt + '地址</button> ' +
                     '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);draw_sh_addr(null,\''+k+'两周阳\');' +
                     '">两周内曾上榜至少1次</button> ' +
                     '<button onclick="h2dist.scrollIntoView();">各区统计</button>';
      onList.appendChild(kk);
      Array.from(j.cache14days[k]).forEach((d) => {
          ki += 1;
          onListAppend(ki, k, d[0],
                       '两周内' + d[1] + '次上榜');
      });
    } else if (j.cached_14days.length && !k) {
      kk.innerHTML = '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);' +
                     'draw_sh_addr(j.cached_14days,\'' +
                     '上海市' + tt + '\');">展示' + tt + '地址</button> ' +
                     '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);draw_sh_addr();' +
                     '">两周内曾上榜至少1次</button> ' +
                     '<button onclick="h2dist.scrollIntoView();">各区统计</button>';
      onList.appendChild(kk);
      let kj; let kii;
      for (kii = 0; kii < Ds.length; kii += 1) {
        if (!j.cache14days[Ds[kii]]) {
          continue;
        }
        ki += 1;
        kj = j.cache14days[Ds[kii]].length;
        onListAppend(ki, Ds[kii], null,
                     '两周内 ' + kj + '处超7次上榜');
        ki += kj - 1;
      }
    }
  }

  function populateStill (days) {
    if (!days || days > 14) {
      window.alert('请先尝试两周阳（14天内曾上榜至少1次）');
      return new Promise(res => { res(0); });
    }
    if (j['still_in' + days]) {
      j.still_in = j['still_in' + days];
      return new Promise(res => { res(1); });
    }
    return new Promise(resolve => {
      j['still_in' + days] = {};
      let s0 = parseInt(j.tag) - days;
      if (331 < s0 && s0 <= 400) {
        s0 -= 69;
      } else if (430 < s0 && s0 <= 500) {
        s0 -= 70;
      }
      let s1;
      for (const p in j.inB) {
        j['still_in' + days][p] = [];
        Array.from(j.inB[p]).forEach((d) => {
          if (j.address[d]) {
            s1 = j.address[d].join(',');
            if (s1.indexOf(p) > 3) {
              if (parseInt(s1.substr(s1.lastIndexOf(p) - 4, 4)) >= s0) {
                j['still_in' + days][p].push([d,
                  parseInt(s1.substr(s1.lastIndexOf(p) - 4, 4)) ]);
              }
            } else if (parseInt(j.address[d].slice(-1)[0].substr(0,4)) >= s0) {
              s1 = -1;
              while (j.address[d].slice(s1)[0] &&
                     j.address[d].slice(s1)[0].length > 4) {
                s1 -= 1;
              }
              if (j.address[d].slice(s1)[0] &&
                  parseInt(j.address[d].slice(s1)[0]) >= s0) {
                j['still_in' + days][p].push([d,
                  parseInt(j.address[d].slice(s1)[0]) ]);
              }
            }
          }
        });
        bubble2( j['still_in' + days][p] );
      }
      j.still_in = null;
      _J[j.tag] = j;
      j.still_in = j['still_in' + days];

console.log(days, j.still_in);

      resolve(1);
    });
  }

  async function asyncStill () {
    const v = await populateStill(5).catch(e => {
      return console.log(e);
    });
    if (v) {
      listStill(addr.value);
      draw_sh_addr(j.still_in[addr.value]);
    }
  }

  function listStill (k) {
    let ki = 0;
    const kk = document.createElement('p');
    const tt = '最近5日上榜';
    if (j.still_in && k && j.still_in[k]) {
      kk.innerHTML = '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);' +
                     'j.still_in=j.still_in5;draw_sh_addr(null,\'' +
                     k + tt + '\');">展示' + k + tt + '地址</button> ' +
                     '<button onclick="h2dist.scrollIntoView();">各区统计</button> ' +
                     '<input type="text" id="_still" name="_still" size=2 ' +
                     'data-value=",5" onkeydown="stillEnter();" />';
      onList.appendChild(kk);
      // Array.from(j.still_in[k]).forEach((d) => {
      //     ki += 1;
      //     onListAppend(ki, k, d[0],
      //                  '最近上榜于' + digi2date(d[1]) );
      // });
    }
  }

  function onlyNewAddr () {
    return new Promise(resolve => {
      const adds = []; let kii;
      for (const p in j.address) {
        if (j.address[p].length === 1 && j.address[p][0].substr(0,4) === j.tag) {
          if (addr.value === '上海市') {
            if (j.address[p][0].length > 4) {
              adds.push([j.address[p][0].substr(4), p,
                         99-Ds.indexOf(j.address[p][0].substr(4))]);
            } else {
              for (kii = 0; kii < Ds.length; kii += 1) {
                if (j.districts[ Ds[kii] ].indexOf(p) > -1) {
                  break;
                }
              }
              adds.push([Ds[kii], p, 99-kii]);
            }
          } else { //各区
            if (j.address[p][0].length > 4 && j.address[p][0].substr(4) === addr.value) {
              adds.push([addr.value, p]);
            } else if (j.address[p][0].length === 4 &&
                       j.districts[ addr.value ] && j.districts[ addr.value ].indexOf(p) > -1) {
              adds.push([addr.value, p]);
            }
          }
      } }
      bubble2(adds, 2);
      resolve(adds);
    });
  }

  async function asyncNewAddr () {
    const v = await onlyNewAddr().catch(e => {
      return console.log(e);
    });
    if (v) {
      let ki = 0;
      Array.from(v).forEach((d) => {
        ki += 1;
        onListAppend(ki, d[0], d[1],
                     '3月6日以来 首次上榜');
      });
    }
  }

  async function fetchClose () {
    const response = await fetch("shanghaifabu/inAB-close.json");
    return await response.json();
  }
  fetchClose().then(jsondata => {
    W = jsondata;
    _ww = Object.keys(W.pairs);
    console.log('async inAB-close pairs', _ww.length);
  }).catch(err => console.log(err));

  function onListAppend (ki, k, d, t) {
    let ks;
    if (!ki) {
      ks = '<br/>';
    } else if (j.listed_30days && d && j.listed_30days.indexOf(d) > -1 &&
        (!t || t.indexOf('上榜') === -1) ) {
      ks = '<span style="color:red;">' + ki + '.<sup>上榜' +
           '多次</sup></span> '; // dldl
    } else {
      ks = '<span class="em">' + ki + '.</span> ';
    }
    if (k) {
      ks += '<span class="click" onclick="scaleChange=true;search(this.textContent);">' +
          k + '</span>';
    }
    if (d) {
      ks += '<span class="click _L" onclick="scaleChange=true;search(\'' + d +
          '\');">' + d + '</span> ';
    }
    ks += ' <em>' + (t || '') + '</em>';
    if (k && d && (!t || (
        t.indexOf('首次') === -1 && t.indexOf('最近') === -1 ))) {
      ks += ' ' + tagsHTML(dldl(k, d));
    }
    const kk = document.createElement('p');
    kk.style.padding = '0';
    kk.style.margin = '0';
    kk.innerHTML = ks;
    onList.appendChild(kk);
    // if (['inB', 'districts'
    //     ].indexOf(_check) > -1 && Ms.indexOf(k + d) > -1) {
    //   console.log(k,d);
    //   map.fillStyle = 'rgb(0,0,0)';
    //   map.beginPath();
    //   map.arc(mapX( Ml.locations[k + d][0] ),
    //           mapY( Ml.locations[k + d][1] ),
    //           3, 0 * Math.PI, 2 * Math.PI);
    //   map.stroke();
    // }
    // map.fillText(ki,
    //   mapX( Ml.locations[k + d][0] ),
    //   mapY( Ml.locations[k + d][1] ) );
    // console.log(ki, k+d);
  }

  function list30days (k) {
    let dl; let ki; let kj; let kii;
    let kjd;
    if (j.listed_30days && !j.list30days) {
      j.list30days = {};
      j.listed_30days_long = [];
      Array.from(j.listed_30days).forEach((d) => {
        for (kii = 0; kii < Ds.length; kii += 1) {
          if (j.districts[ Ds[kii] ].indexOf(d) > -1) {
            break;
        } }
        dl = j.address[d];
        kj = 0;
        kjd = '';
        for (ki = 0; ki < dl.length; ki += 1) {
          if (dl[ki].length > 4) { // 地址同名
            kjd += ',' + dl[ki];
          } else {
            kj += 1;
          }
        }
        if (kj >= 30) {
          j.listed_30days_long.push(Ds[kii] + d);
          if (j.list30days[Ds[kii]]) {
            j.list30days[Ds[kii]].push( [d, kj] );
          } else {
            j.list30days[Ds[kii]] = [ [d, kj] ];
          }
        } //else { // 五四村 星火村
        //   const ind = j.listed_30days.indexOf(d);
        //   if (ind > -1) {
        //     j.listed_30days.splice(ind, 1);
        //   }
        // }
        if (kjd && (kjd.match(/,/g) || []).length >= 30) {
          for (kii = 0; kii < Ds.length; kii += 1) {
            const re = new RegExp(Ds[kii], 'g');
            kj = (kjd.match(re) || []).length;
            if (kj >= 30) {
              j.listed_30days_long.push(Ds[kii] + d);
              if (j.list30days[Ds[kii]]) {
                j.list30days[Ds[kii]].push( [d, kj] );
              } else {
                j.list30days[Ds[kii]] = [ [d, kj] ];
              }
            }
          }
        }
      });
      for (kii = 0; kii < Ds.length; kii += 1) {
        if (j.list30days && j.list30days[Ds[kii]]) {
          bubble2( j.list30days[Ds[kii]] );
        }
      }
      _J[j.tag] = j;
    }
    ki = 0;
    const kk = document.createElement('p');
    const tt = '超30次上榜';
    if (j.list30days && k && j.list30days[k]) {
      kk.innerHTML = '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);' +
                     'draw_sh_addr(j.listed_30days_long,\'' +
                     k + tt + '\');">展示' + k + tt + '地址</button> ' +
                     '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);draw_sh_addr(null,\''+k+'累计阳\');' +
                     '">3月6日以来曾上榜至少1次</button> ' +
                     '<button onclick="h2dist.scrollIntoView();">各区统计</button>';
      onList.appendChild(kk);
      Array.from(j.list30days[k]).forEach((d) => {
          ki += 1;
          onListAppend(ki, k, d[0],
                       '3月6日以来 上榜' + d[1] + '次');
      });
    } else if (j.list30days && !k) { // j.listed_30days_long.length
      kk.innerHTML = '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);' +
                     'draw_sh_addr(j.listed_30days_long,\'' +
                     '上海市' + tt + '\');">展示' + tt + '地址</button> ' +
                     '<button onclick="map.clearRect(0,0,svgWidth,svgHeight);draw_sh_addr();' +
                     '">3月6日以来曾上榜至少1次</button> ' +
                     '<button onclick="h2dist.scrollIntoView();">各区统计</button>';
      onList.appendChild(kk);
      for (kii = 0; kii < Ds.length; kii += 1) {
        if (!j.list30days[Ds[kii]]) {
          continue;
        }
        ki += 1;
        kj = j.list30days[Ds[kii]].length;
        onListAppend(ki, Ds[kii], null,
                     '3月6日以来 ' + kj + '处超30次上榜');
        ki += kj - 1;
      }
    }
  }

  function generalAppend () {
    let kii; let kj; let ki = 0;
    for (kii = 0; kii < Ds.length; kii += 1) {
      if (!j[_check][Ds[kii]]) {
        continue;
      }
      ki += 1;
      kj = j[_check][Ds[kii]].length;
      onListAppend(ki, Ds[kii], null,
                   kj + '处 ' + check_choices[_check]);
      ki += kj - 1;
    }
  }

  function mapX (z) { // 57变大==>区域变窄  .004修正区域平移
    const zz = Math.round((z - d3center[0] + 0.004) * d3scale/57 + svgWidth/2);
    return zz;
  }
  function mapX0 (z) {
    const zz = Math.round((z - d3center[0]) * d3scale/57 + svgWidth/2);
    return zz;
  }

  function mapY (z) { // 49变大==>区域压扁  .003修正区域平移
    const zz = Math.round((d3center[1] - z + 0.003) * d3scale/49 + svgHeight/2);
    return zz;
  }
  function mapY0 (z) {
    const zz = Math.round((d3center[1] - z) * d3scale/49 + svgHeight/2);
    return zz;
  }

  function inChina (lng, lat) {
    if (lng && lng > 73.66 && lng < 135.05) {
      if (lat && lat > 3.86 && lat < 53.55) {
        return true;
    } }
    return false;
  }

  // https://stackoverflow.com/questions/10359907
  var average = arr => arr.reduce((prev, curr) => prev + curr) / arr.length;

  function pngMulti () {
    if (!pngBase64) {
      window.alert('启动图片缓存，请点击左右箭头间的日期');
    }
    const imgL = Object.keys(pngBase64);
    var zip = new JSZip();
    let img0;
    let img1 = '# ' + today.toLocaleString('zh-CN') + '\r\n\r\n';
    for (i = 0; i < imgL.length; i += 1) {
      img0 = pngBase64[ imgL[i] ].indexOf(',');
      zip.file(imgL[i] + '.png',
               pngBase64[ imgL[i] ].slice(img0 + 1), {base64: true });
      img1 += (i+1) + '. ' + imgL[i] + '.png\r\n';
    }
    zip.file('list.txt', img1);
    zip.generateAsync({type: "blob" }).then(function (blob) {
      saveAs(blob, 'download.zip');
      pngBase64 = {};
      pngGif.innerHTML = '<p class="click" onclick="auto_save_status.click()">停</p>';
    });
    // https://stuk.github.io/jszip/
  }

  function pngDown (fileH, canvasElement, fo) {
    pngBase64[fileH + j.tag] = canvasElement.toDataURL('image/png');
    if (autoSavePNG && !fo) {
      pngGif.innerHTML = '<p class="click" onclick="pngMulti()">点击下载 ' +
                         Object.keys(pngBase64).length + ' 张图片</p>';
      return;
    }
    canvasElement.toBlob(function (blob) {
      saveAs(blob, fileH + '2022' + j.tag + (Math.random() + '').substr(1,5) + '.png');
    });
  }

  function exportCanvasAsPNG (fo) {
    // https://stackoverflow.com/questions/923885/
    // https://stackoverflow.com/questions/53757970/
    let fileH = addr.value || '表格';
    if (app.style.display !== 'none') {
      fileH += check_choices[_check];
      const canvasElement = document.getElementById('app');
      pngDown(fileH, canvasElement, fo);
    } else {
      html2canvas(document.getElementById('districtTbody').parentNode).then(canvasElement => {
        pngDown(fileH, canvasElement, fo);
      });
    }
  }

  function updateLocation (hash_, q) {
    if (loadingBlock) {
      return;
    }
    let url = baseURL + '#0' + hash_;
    if (q) {
      url += '?' + q;
    }
    if (d3scale) {
      url += '$' + d3scale;
      if (d3center && d3center.length === 2) {
        url += '_' + d3center[0] + '_' + d3center[1];
      }
    }
    if (autoSavePNG) {
      url += '=' + _check;
    }
    window.location.replace(url);
    //window.location.reload();
    load_js();
  }

  function preReload (q, oldest) {
    let hash_;
    if (j && j.address.shanghaifabu.length > 2) {
      if (j.tag === j.address.shanghaifabu.slice(-1)[0]) {
        hash_ = parseInt(j.address.shanghaifabu.slice(-2)[0] );
      } else {
        hash_ = parseInt(j.address.shanghaifabu.slice(-1)[0] );
      }
    } else {
      //window.alert(j.tag); // before and include 0318
      hash_ = parseInt(j.tag) - 1;
    }
    if (oldest) {
      hash_ = 307;
    }
    updateLocation(hash_, q);
  }

  function nextReload (q, lastest) {
    let hash_;
    try {
      if (hash) {
        hash_ = parseInt(hash) + 1;
      } else {
        hash_ = parseInt(j.tag) + 1;
      }
    } catch (err) {
      window.alert('没有后一日的数据');
      return false;
    }
    if (hash_ > 430 && hash_ < 501) {
      hash_ += 70; // -30 +100
    } else if (hash_ > 331 && hash_ < 401) {
      hash_ += 69; // -31 +100
    }
    if (lastest) {
      hash_ = j_data_init;
    }
    if (next_button.getAttribute('data-value') !== '') {
      nextSpecial = next_button.getAttribute('data-value');
      next_button.setAttribute('data-value', '');
      next_button.style.border = '';
    }
    updateLocation(hash_, q);
  }

  function jumpApr (q, month) {
    if (!month) {
      month = 4;
    }
    const inputS = document.getElementById(ms[month]).value;
    let i_ = parseInt(inputS);
    if (!inputS || !i_ || i_ > 31 || i_ < 1) {
      document.getElementById(ms[month]).value = '';
      document.getElementById(ms[month]).focus();
      return;
    } else if (month === 3 && i_ < 7) {
      march.value = '';
      i_ = 7;
    } else {
      for (i = 3; i < 6; i += 1) {
        if (i !== month) {
          document.getElementById(ms[i]).value = ''; }
      }
    }
    const hash_ = i_ + 100 * month;
    updateLocation(hash_, q);
  }

  async function stillEnter (ky) {
    const keyCode = ('which' in event) ? event.which : event.keyCode;
    if (ky || keyCode === 13) {
      const days = ky || parseInt(_still.value || '4');
      if (document.getElementById('_still')) {
        _still.value = '';
      }
      const v = await populateStill(days).catch(e => {
        return console.log(e);
      });
      if (v && document.getElementById('_still') &&
          _still.getAttribute('data-value').indexOf(',' + days) === -1 ) {
        const c = document.createElement('span');
        const tt = '最近' + days + '日';
        c.innerHTML = ' <button onclick="map.clearRect(0,0,svgWidth,svgHeight);' +
                      'j.still_in=j.still_in' + days + ';draw_sh_addr(null,\'' +
                      addr.value + tt + '上榜\');">' + tt + '</button>';
        _still.parentNode.appendChild(c);
        _still.setAttribute(  'data-value', ',' + days +
          _still.getAttribute('data-value')  );
      }
    }
  }

  function aprilEnter (ky) {
    const keyCode = ('which' in event) ? event.which : event.keyCode;
    if (keyCode === 13) {
      jumpApr(addr.value, ky);
    }
  }

  function addrEnter () {
    const keyCode = ('which' in event) ? event.which : event.keyCode;
    if (keyCode === 13) {
      //scaleChange = true;
      search(addr.value);
    }
  }

  const loading = ['.', '..', '...', '']; // ['\\', '/', '-']
  let loading_i = -1;
  (function f () {
    loading_i = (loading_i + 1) % loading.length;
    if (document.getElementById('loading_span')) {
      loading_span.textContent = loading[ loading_i ];
    }
    setTimeout(f, 250);
  })();

  function next_pre_vis (hash_) {
    if (hash_ < j_data_init) {
      next_button.style.visibility = 'visible';
    } else {
      next_button.style.visibility = 'hidden';
    }
    if (hash_ < 308) {
      pre_button.style.visibility = 'hidden';
    } else {
      pre_button.style.visibility = 'visible';
    }
    save_button.style.visibility = 'visible';
    addr.style.visibility = 'visible';
    search_button.style.visibility = 'visible';
    districtTbody.style.visibility = 'visible';
  }

  function hard_off () {
    save_button.style.visibility = 'hidden';
    addr.style.visibility = 'hidden';
    search_button.style.visibility = 'hidden';
    districtTbody.style.visibility = 'hidden';
    next_button.style.visibility = 'hidden';
    pre_button.style.visibility = 'hidden';
  }

  function load_js () {
    if (loadingBlock) {
      return;
    }
    loadingBlock = true;
    const hash_orig = window.location.hash.slice(1).split('?')[0];
    const hash2_orig = decodeURIComponent(window.location.toString()).split('?')[1]; // undefined
    hash = hash_orig;
    hash2 = hash2_orig;
    if (window.location.toString().indexOf('$') > -1) {
      hash = hash.split('$')[0];
    }
    autoSavePNG = (window.location.toString().indexOf('=') > -1);
    if (autoSavePNG) {
      hash = hash.split('=')[0];
      _check = window.location.toString().split('=')[1];
    }
    let hash_ = parseInt(hash);
    if (hash.length !== 4 || hash_ > j_data_init) {
      hash = '0' + j_data_init;
      hash_ = j_data_init;
    } else if (hash_ < 307) {
      hash = '0307';
      hash_ = 307;
    }
    if (hash2) {
      window.location.replace(baseURL + '#' + hash + '?' + hash2);
    } else {
      window.location.replace(baseURL + '#' + hash);
    }
    const k_src = "shanghaifabu/full" + hash + '.json';
    if (_J && _J[hash] && _J[hash].tag === hash) {
      j = _J[hash];
      next_pre_vis(hash_);
      load();
    } else {
      datestr.textContent = '';
      fetching.style.visibility = 'visible';
      fetching2.style.visibility = 'visible';
      console.log('Start downloading', hash + '.json');
      // let k = document.createElement('script');
      // k.src = k_src;
      // document.head.append(k);
      // k.onload = function () {
      // };
      // k.onerror = function () {
      // };
      const req = new XMLHttpRequest();
      req.addEventListener("loadstart", event => {
        const ld = document.getElementsByClassName('loading_pr');
        Array.from(ld).forEach((d) => {
          d.textContent = '0%';
        });
      }, false);
      req.addEventListener("progress", event => {
        const ld = document.getElementsByClassName('loading_pr');
        let ldint;
        Array.from(ld).forEach((d) => {
          if (event.lengthComputable) {
            ldint = parseInt(100 * event.loaded/event.total);
          } else {
            ldint = parseInt(100 * event.loaded/3600000);
          }
          if (ldint > 99) { ldint = 99; }
          d.textContent = ldint + '%';
        });
      }, false);
      req.addEventListener("load", event => {
        const e = event.target;
        const k = document.createElement('script');
        try {
          k.textContent = e.responseText;
          document.body.appendChild(k);
          j = JSON.parse(data);
        } catch (err) {
          hard_off();
          window.alert('数据无法下载 请访问 https://sh.teach.bio/');
          return false;
        }
        data = '';
        _J[hash] = j;
        if (parseInt(j.tag) > j_data_init) {
          hard_off();
          window.alert('所得数据有错 请刷新页面\n' + window.location.toString() );
          return false;
        }
        if (j.address.shanghaifabu && hash !== j.address.shanghaifabu.slice(-1)[0]) {
          console.log('Last four shanghaifabu in data', j.tag, j.address.shanghaifabu.slice(-4) );
        }
        next_pre_vis(hash_);
        load();
        loadingBlock = false;
      }, false);
      req.addEventListener("error", event => {
        if (baseURL.substr(0,4) !== 'http' || JSON.stringify(_J) === '{}') {
          hard_off();
          window.alert('数据无法下载 请访问 https://sh.teach.bio/');
        } else {
          const ld = document.getElementsByClassName('loading_pr');
          Array.from(ld).forEach((d) => {
            d.textContent = '暂存数据' + Object.keys(_J);
          });
          window.alert('数据无法下载 请稍后刷新页面\n当前可使用以下数据\n' +
                       Object.keys(_J)); // window.location.toString()
          loadingBlock = false;
        }
      }, false);
      req.addEventListener("abort", event => {
        console.log(event);
        if (hash2_orig) {
          window.location.replace(baseURL + '#' + hash_orig + '?' + hash2_orig);
        } else {
          window.location.replace(baseURL + '#' + hash_orig);
        }
      }, false);
      req.open('GET', k_src );
      req.send();
      // https://stackoverflow.com/questions/18126406/
    }
    // SukkaW/DisqusJS
    const dsqjs = new DisqusJS({
        shortname: 'sh-teach-cn',
        siteName: 'Feedback 反馈',
        identifier: 'https://sh.teach.bio/',
        url: 'https://sh.teach.bio/',
        api: 'https://disqus.skk.moe/disqus/',
        apikey: 'ucxDfSYIhlMQoMDauN5hqII0o8CFtk2JSGoX7zBLP1L2UK1jsUplM3dTsI0nW5Li',
        nocomment: '对本工具的建议或意见，可评论反馈',
        admin: 'thepaperlink',
        adminLabel: 'Mod'
    });
  }

  function digi2date (_int) {
    return Math.floor(_int/100) + '/' + (_int%100);
  }

  function hash2date (_s) {
    try {
      const _m = parseInt(_s.substr(0,2) );
      const _d = parseInt(_s.substr(2,2) );
      if (_s.length === 4 && [3,4,5].indexOf(_m) > -1 && _d > 0 && _d < 32) {
        return _m + '/' + _d;
      } else {
        return tag_m.textContent + '/' + tag_d.textContent;
      }
    } catch (err) {
        return 'm/d';
    }
  }

  function resetDay (dldi) {
    if (loadingBlock) {
      return;
    }
    search_button.textContent = '搜索';
    addr.value = '';
    app.style.display = 'none';
    window.location.replace('#' + dldi);
    load_js();
  }

  function tagsHTML (dl_, noClick) {
    if (!dl_ || dl_.length === 0) { return ''; }
    const dl = [];
    let di;
    for (di = 0; di < dl_.length; di += 1) {
      if (dl_[di].length === 4) {
        dl.push( dl_[di] );
      }
    }
    if (!dl || dl.length === 0) { return ''; }
    let ds = '<span'; let inwhile;
    if (dl[0] === '0307') {
      ds += ' style="background-color:yellow;"';
    }
    if (noClick) {
      ds += '>' + hash2date(dl[0]) + '</span>';
    } else {
      ds += ' class="click" onclick="resetDay(\'' +
            dl[0] + '\');">' + hash2date(dl[0]) + '</span>';
    }
    for (di = 1; di < dl.length; di += 1) {
      inwhile = false;
      while (dl[di] &&
             (parseInt(dl[di]) - parseInt(dl[di-1])) === 1 ) {
        ds += '.';
        di += 1;
        inwhile = true;
      }
      if (inwhile) {
        di -= 1;
        if ((di+1) === dl.length && dl[di] === j.tag) {
          ds += '<span style="background-color:yellow;"';
        } else {
          ds += '<span';
        }
        if (noClick) {
          ds += '>' + parseInt(dl[di].substr(2,2)) + '</span>';
        } else {
          ds += ' class="click" onclick="resetDay(\'' +
                dl[di] + '\');">' + parseInt(dl[di].substr(2,2)) + '</span>';
        }
      } else {
        if (di < dl.length) { //  && ds.slice(-1)[0] !== '.'
          ds += ', ';
        }
        if ((di+1) === dl.length && dl[di] === j.tag) {
          ds += '<span style="background-color:yellow;"';
        } else {
          ds += '<span';
        }
        if (noClick) {
          ds += '>' + hash2date(dl[di]) + '</span>';
        } else {
          ds += ' class="click" onclick="resetDay(\'' +
                dl[di] + '\');">' + hash2date(dl[di]) + '</span>';
        }
      }
    }
    return ds;
  }

  async function load () {
    Ml = JSON.parse(csv);
    Ms = Object.keys(Ml.locations);
    datestr.textContent = j.date;
    fetching.style.visibility = 'hidden';
    fetching2.style.visibility = 'hidden';
    end_pre.textContent = '\n\n数据更新时间 ' + j.date +
                          '\n源代码 github.com/coronin/shanghai-2022Mar' +
                          '\n作者 @the_paper_link';
    tag_m.textContent = parseInt(j.tag.substr(0,2) );
    tag_m2.textContent = tag_m.textContent;
    tag_d.textContent = parseInt(j.tag.substr(2,2) );
    tag_d2.textContent = tag_d.textContent;
    for (i = 3; i < 6; i += 1) {
      document.getElementById(ms[i]).value = '';
    }
    _today = hash2date(j.tag);
    const tags = document.getElementsByClassName('_tag');
    // for (k = 0; k < tags.length; k += 1) {
    //   tags[k].textContent = _today;
    // }
    Array.from(tags).forEach((d) => {
      d.textContent = _today;
    });
    auto_save_status.onclick = function () {
      if (autoSavePNG) {
        auto_save_off();
      } else {
        autoSavePNG = true;
        auto_save_status.style.boxShadow = 'inset 0 -.5em cyan';
        pre_button.style.border = '.25em solid cyan';
        next_button.style.border = '.25em solid cyan';
        auto_save_.style.visibility = 'visible';
        pngGif.style.visibility = 'visible';
        exportCanvasAsPNG();
      }
    };
    check_row.onclick = function () {
      auto_save_off();
    };
    if (autoSavePNG) {
      auto_save_status.style.boxShadow = 'inset 0 -.5em cyan';
      pre_button.style.border = '.25em solid cyan';
      next_button.style.border = '.25em solid cyan';
      auto_save_.style.visibility = 'visible';
      pngGif.style.visibility = 'visible';
    }
    Ds = Object.keys(j.districts);
    As = Object.keys(j.address);
    th_k.textContent = '';
    districtTbody.textContent = '';
    latest_added.textContent = '';
    latest_released.textContent = '';
    released.textContent = '';
    let k;
    for (i = 0; i < Ds.length; i += 1) {
      k = document.createElement('tr');
      // if (Ds[i] === '普陀区') {
      //   console.log( j.inB[ Ds[i] ] );
      //   console.log( j.today[ Ds[i] ] );
      // }
      k.innerHTML = '<td class="click" onclick="_check=\'today\';search(this.textContent);">' +
                    Ds[i] + '</td><td class="click" onclick="_check=\'districts\';search(\''+Ds[i]+'\');">' +
                    j.districts[ Ds[i] ].length + '</td><td id="' +
                    Ds[i] + 'line" style="text-align:left;"></td><td class="click" onclick="_check=\'inB\';search(\''+Ds[i]+'\');">' +
                    (j.inB[ Ds[i] ] || []).length +
                    '</td><td style="color:red;" class="click" onclick="_check=\'latest_added\';search(\''+Ds[i]+'\');">' +
                    (j.today[ Ds[i] ] || []).length +
                    '</td><td style="color:green;" class="click" onclick="_check=\'released\';search(\''+Ds[i]+'\');">' +
                    (j.released[ Ds[i] ] || []).length + '</td>';
      if (j.released_today[ Ds[i] ] ) {
        k.innerHTML += '<td style="color:green;" class="click" onclick="_check=\'released_today\';search(\''+Ds[i]+'\');">' +
                    (j.released_today[ Ds[i] ] || []).length + '</td>';
      } else {
        k.innerHTML += '<td style="color:green;">&ndash;</td>';
      }
      k.id = Ds[i];
      districtTbody.appendChild(k);
      k = document.createElement('p');
      if (j.latest_added && j.latest_added[ Ds[i] ] ) {
        k.innerHTML = '<span style="color:black;"><strong onclick="_check=\'latest_added\';search(this.textContent);"' +
                      ' class="click _L">' + Ds[i] + '</strong> 2022/' + _today + '涉及' +
                      (j.today[ Ds[i] ] || []).length +
                      '个地址，下列' + j.latest_added[ Ds[i] ].length +
                      '个地址不同于之前一日</span><br/>' + j.latest_added[ Ds[i] ];
      } else {
        k.innerHTML = '<span style="color:black;"><strong onclick="_check=\'today\';search(this.textContent);"' +
                      ' class="click _L">' + Ds[i] + '</strong> 2022/' + _today + '涉及' +
                      (j.today[ Ds[i] ] || []).length +
                      '个地址</span>';
      }
      latest_added.appendChild(k);
      k = document.createElement('p');
      if (j.released_today && j.released_today[ Ds[i] ] ) {
        k.innerHTML = '<span style="color:black;" onclick="_check=\'released_today\';search(this.textContent);"' +
                      ' class="click _L">' + Ds[i] + '</span>: ' + j.released_today[ Ds[i] ];
      } else {
        k.innerHTML = '<span style="color:black;">' + Ds[i] + ':</span> 无';
      }
      latest_released.appendChild(k);
      k = document.createElement('p');
      if (j.released && j.released[ Ds[i] ] ) {
        k.innerHTML = '<span style="color:black;" onclick="_check=\'released\';search(this.textContent);"' +
                      ' class="click _L">' + Ds[i] + '</span>: ' + j.released[ Ds[i] ];
      } else {
        k.innerHTML = '<span style="color:black;">' + Ds[i] + ':</span> 无';
      }
      released.appendChild(k);
    }
    map = document.getElementById('app').getContext('2d');
    if (window.location.toString().indexOf('=') === -1 && !autoSavePNG) {
      auto_save_.style.visibility = 'hidden';
      pngGif.style.visibility = 'hidden';
    }
    if (parseInt(j.tag) > 308) { // 三阴阳
      check6.style.display = 'inline-block';
    } else {
      check6.style.display = 'none';
    }
    if (parseInt(j.tag) > 312) { // 七阴阳
      check7.style.display = 'inline-block';
    } else {
      check7.style.display = 'none';
    }
    onList.textContent = '';
    if (window.location.toString().indexOf('?') > -1) {
      if (hash2.indexOf('$') > -1) {
        scaleChange = false;
        const scc = hash2.split('$')[1].split('=')[0].split('_');
        d3scale = parseInt(scc[0]);
        d3center = [parseFloat(scc[1]), parseFloat(scc[2])];
        k = hash2.split('$')[0];
      } else {
        k = hash2;
      }
      search(k);
    }
  }

  function draw_sh () { // map-address.html
    app.width = svgWidth;
    app.height = svgHeight;
    app.style.display = 'block';
    app.style.padding = '5px 0 2px 0';
    const jj = JSON.parse(sh);
    const dt = topojson.feature(jj, jj.objects.collection);
    //const dn = topojson.neighbors(jj.objects.collection.geometries);
    const pj = d3.geo.mercator(
                ).scale(d3scale).center(d3center
                ).translate([svgWidth/2, svgHeight/2]);
    const pg = d3.geo.path().projection(pj).context(map);
    map.strokeStyle = 'grey';
    map.font = fontSize + 'px Microsoft YaHei';
    dt.features.forEach((d) => {
      // let xx = new Array(), yy = new Array();
      // let xx_raw = new Array(), yy_raw = new Array();
      // let xx_max, yy_max, xxx, yyy;
      // if (d.properties.name === addr.value) {
      //   //console.log(d);
      //   console.log(d.properties.name, svgWidth, 'x', svgHeight,
      //              'current scale', d3scale );
      //   let dd
      //   if (d.geometry.type === 'MultiPolygon') {
      //     dd = d.geometry.coordinates[0][0];
      //     for (i = 1; i < d.geometry.coordinates[0].length; i++) {
      //       dd = [...dd, ...d.geometry.coordinates[0][i] ];
      //     }
      //   } else {
      //     dd = d.geometry.coordinates[0];
      //   }
      //   //console.log(dd);
      //   for (i = 0; i < dd.length; i++) {
      //     xxx = parseFloat(dd[i][0]);
      //     yyy = parseFloat(dd[i][1]);
      //     //console.log(xxx, yyy);
      //     if (inChina(xxx, yyy)) {
      //       xx_raw.push(xxx);
      //       yy_raw.push(yyy);
      //       xx.push(mapX(xxx ));
      //       yy.push(mapY(yyy ));
      //     }
      //   }
      //   // 黄浦区 0.05311649064906021 ~ 72000 ~ 67
      //   xx_max = Math.max.apply(null, xx) - Math.min.apply(null, xx);
      //   // 黄浦区 0.05627040804080252 ~ 72000 ~ 82
      //   yy_max = Math.max.apply(null, yy) - Math.min.apply(null, yy);
      //   console.log('    suggested centers', mapX(average(xx_raw)), mapY(average(yy_raw)),
      //     average(xx_raw), average(yy_raw),
      //     Math.min.apply(null, [
      //       Math.floor(d3scale * svgWidth/xx_max),
      //       Math.floor(d3scale * svgHeight/yy_max) ]) );
      // }
      map.beginPath();
      pg(d);
      if (sh_district7.indexOf(d.properties.name) > -1) {
        map.fillStyle = 'rgba(200,200,200,0.2)'; // d.properties.subFeatureIndex
        map.fill(); // 'nonzero', 'evenodd'
      }
      map.stroke();
      map.textBaseline = 'top';
      map.textAlign = 'start';
      map.fillStyle = 'grey';
      map.fillText(d.properties.name,
                   mapX0(d.properties.center[0]),
                   mapY0(d.properties.center[1]));
    });
    const cafe0 = JSON.parse(cafe);
    const cafe1 = topojson.feature(cafe0, cafe0.objects.collection);
    map.fillStyle = 'blue';
    cafe1.features.forEach((d) => {
      map.beginPath();
      map.fillRect(mapX0( d.geometry.coordinates[0] ),
                   mapY0( d.geometry.coordinates[1] ),
                   3, 3 );
    });
    map.fillText('已标记精致咖啡馆', 0,2);
    map.fillStyle = 'silver';
    map.fillText('制图 https://teach.bio @the_paper_link', svgWidth - fontSize * 18.6,2);
    let dots;
    const river0 = JSON.parse(river);
    const river1 = topojson.feature(river0, river0.objects.collection);
    map.strokeStyle = 'rgba(0,0,255,0.2)';
    map.lineWidth = 6;
    river1.features.forEach((d) => {
      dots = d.geometry.coordinates;
      map.beginPath();
      map.moveTo(mapX0(dots[0][0]), mapY0(dots[0][1]));
      for (i = 1; i < dots.length; i += 1) {
        map.lineTo(mapX0(dots[i][0]), mapY0(dots[i][1]));
      }
      map.stroke();
    });
    let line_dot_must_shown1 = false;
    const line0 = JSON.parse(lines);
    const line1 = topojson.feature(line0, line0.objects.collection);
    map.strokeStyle = 'rgba(0,0,255,0.3)';
    map.lineWidth = 1.0;
    line1.features.forEach((d) => {
      dots = d.geometry.coordinates;
      map.beginPath();
      map.moveTo(mapX0(dots[0][0]), mapY0(dots[0][1]));
      if (!line_dot_must_shown1 &&
          mapX0(dots[0][0]) > 0 && mapX0(dots[0][0]) < svgWidth &&
          mapY0(dots[0][1]) > 0 && mapY0(dots[0][1]) < svgHeight) {
        line_dot_must_shown1 = true;
      }
      for (i = 1; i < dots.length; i += 1) {
        map.lineTo(mapX0(dots[i][0]), mapY0(dots[i][1]));
        if (!line_dot_must_shown1 &&
            mapX0(dots[i][0]) > 0 && mapX0(dots[i][0]) < svgWidth &&
            mapY0(dots[i][1]) > 0 && mapY0(dots[i][1]) < svgHeight) {
          line_dot_must_shown1 = true;
        }
      }
      map.stroke();
    });
    if (!line_dot_must_shown1) {
      d3scale = Math.floor(d3scale/2);
      draw_sh();
    }
  }

  // let _addr_manual = 0;
  function draw_addr (s, mustRed) {
    let _R = 'rgba(255,0,0,';
    if (!mustRed && _check && _check.substr(0,8) === 'released') {
      _R = 'rgba(17,131,1,';
    }
    if (typeof s !== 'string') {
      s = addr.value + s[0];
    } else if (s.indexOf(',') > 0) {
      s = s.substr(0, s.indexOf(','));
    }
    if (Ms.indexOf(s) > -1) {
      map.beginPath();
      map.arc(mapX( Ml.locations[s][0] ),
              mapY( Ml.locations[s][1] ),
              3, 0 * Math.PI, 2 * Math.PI);
      if (Ml.locations[s][2]) {
        map.strokeStyle = _R + '1)';
      } else {
        map.strokeStyle = _R + '.75)';
      }
      map.stroke();
    } else if (s !== 'undefinedshanghaifabu') {
      console.log('市 区 未显示', s);
      dotNotDraw += 1; // 市 区
    }
    // save to _addr_manual.txt
    // if (!(_addr_manual%3)) {
    //   map.fillStyle = 'black';
    //   map.fillText(_addr_manual,
    //     mapX( Ml.locations[s][0] ),
    //     mapY( Ml.locations[s][1] ) );
    //   console.log(_addr_manual, s);
    // }
    // _addr_manual += 1;
  }

  function draw_addr_withLabel(s, t) {
    map.fillStyle = 'black';
    map.beginPath();
    map.fillRect(mapX( Ml.locations[s][0] )-1.5,
                 mapY( Ml.locations[s][1] )-1.5,
                 3, 3 );
    if (t) {
      map.fillText(s+t, 1.5+mapX( Ml.locations[s][0] ),
                        1.5+mapY( Ml.locations[s][1] ));
    } else {
      map.fillText(s, 1.5+mapX( Ml.locations[s][0] ),
                      1.5+mapY( Ml.locations[s][1] ));
    }
  }

  function draw_sh_addr (jcDi, tt) {
    let ii;
    let map_i = 0;
    draw_sh();
    let ttf;
    if (tt && tt.substr(0,3) !== '上海市') {
      ttf = tt.substr(0,3);
    }
    if (jcDi) {
      for (ii = 0; ii < jcDi.length; ii += 1) {
        if (!ttf || jcDi[ii].substr(0,3) === ttf) {
          draw_addr(jcDi[ii]);
          map_i += 1;
        }
      }
    } else {
      for (i = 0; i < Ds.length; i += 1) {
        if (!j[_check][Ds[i] ]) {
          continue;
        }
        if (ttf && Ds[i].substr(0,3) !== ttf) {
          continue;
        }
        for (ii = 0; ii < j[_check][ Ds[i] ].length; ii += 1) {
          draw_addr(Ds[i] + j[_check][ Ds[i] ][ii]);
          map_i += 1;
        }
      }
    }
    map.fillStyle = 'black';
    if (map_i && dotNotDraw) {
      map.fillText((tt || '上海市' + check_choices[_check]) + map_i +
                   '个地址 未显示其中' + dotNotDraw + '个 2022/' + _today,
                   0,svgHeight-1-fontSize);
      dotNotDraw = 0;
    } else if (map_i) {
      map.fillText((tt || '上海市' + check_choices[_check]) + ' ' + map_i +
                   '个地址 2022/' + _today,
                   0,svgHeight-1-fontSize);
    } else if (tt) {
      onListAppend(0, null, null, '无' + tt );
    } else {
      onListAppend(0, null, null, '上海市无' + check_choices[_check] );
    }
  }

  function dldl (k_, d_) {
    const dl = j.address[d_];
    const s1 = (dl || []).join(',').split(k_);
    let kii; let il = 0;
    for (kii = 0; kii < Ds.length; kii += 1) {
      if (j.districts[ Ds[kii] ].indexOf(d_) > -1) {
        il += 1;
      }
      if (Ds[kii] === k_) { break; }
    }
    let s2; const dldl = [];
    //console.log(k_, d_, il, s1);
    if (il !== 1) { // 地址同名, 团结村 国权北路555 邯郸路20 星火村 五四村
      while (s1.length > 1) {
        s2 = s1.shift();
        if (s2) {
          dldl.push( s2.substr(s2.lastIndexOf(',') + 1) );
        }
      }
    } else {
      for (s2 = 0; s2 < dl.length; s2 += 1) {
        if (dl[s2].length === 4) {
          dldl.push( dl[s2] );
        }
      }
    }
    return dldl;
  }

  function search (kt, pngNot) {
    let k = trim(kt);
    if (!k) {
      addr.value = '';
      addr.focus();
      app.style.display = 'none';
      check_row.style.display = 'none';
      clear_button.style.visibility = 'hidden';
      window.location.replace(baseURL + '#' + j.tag); // #hash
      return;
    }
    if (addr.value !== k) {
      addr.value = k;
    }
    window.location.replace(baseURL + '#' + j.tag + '?' + k);
    //document.title = 'sh.teach.bio/2 ? ' + k + '  2022/' + _today;
    onList.textContent = '';
    map.clearRect(0, 0, svgWidth, svgHeight);
    scale2x_button.style.visibility = 'hidden';
    svgWidth = 640;
    svgHeight = 480;
    fontSize = 10; // 10px Microsoft YaHei
    if (scaleChange) { d3scale = 72000; }
    let ii;
    if (nextSpecial && nextSpecial.endsWith(addr.value)) {
      k = nextSpecial.substr(0, nextSpecial.indexOf('区')+1);
      //_check = 'today';
      // released_today, released,
      // districts, inB, today, latest_added, latest_added2, latest_added7
    } else {
      nextSpecial = '';
    }
    if (Ds.indexOf(k) > -1) { //各区
      // if (!j.today[k]) { // .latest_added [_check]
      //   addr.value = '';
      //   addr.focus();
      //   app.style.display = 'none';
      //   check_row.style.display = 'none';
      //   return;
      // }
      // if (k === '崇明区') {
      //   if (scaleChange && d3scale < 32000) {
      //     d3scale = 32000; }
      // } else if (k === '黄浦区') {
      //   if (scaleChange && d3scale < 192000) {
      //     d3scale = 192000; }
      // } else if (sh_district7.indexOf(k) > -1) {
      //   if (scaleChange && d3scale < 128000) {
      //     d3scale = 128000; }
      // }
      if (!nextSpecial &&
          (scaleChange || (hash2 && hash2.indexOf(k) !== 0))) {
        d3scale = centers[k][2];
      }
      if (!nextSpecial) {
        d3center = [centers[k][0], centers[k][1] ];
      }
      draw_sh();
      if (nextSpecial) {
        draw_addr_withLabel(nextSpecial);
      }
      if (j[_check] && j[_check][k]) {
        for (ii = 0; ii < j[_check][k].length; ii += 1) { // .today
          draw_addr(k + j[_check][k][ii]);
          if (['latest_added2', 'latest_added7', 'latest_added'
              ].indexOf(_check) > -1) {
            if (_check === 'latest_added' && j.latest_added2 &&
                       j.latest_added2[k] &&
                       j.latest_added2[k].indexOf( j[_check][k][ii] ) === -1) {
              onListAppend(ii+1, k, j[_check][k][ii],
                           '在“一阴阳”<span>不在“三阴阳”</span>');
            } else if (_check === 'latest_added2' && j.latest_added7 &&
                       j.latest_added7[k] &&
                       j.latest_added7[k].indexOf( j[_check][k][ii] ) === -1) {
              onListAppend(ii+1, k, j[_check][k][ii],
                           '在“三阴阳”<span>不在“七阴阳”</span>');
            } else {
              onListAppend(ii+1, k, j[_check][k][ii]);
            }
          }
        }
      } else if (_check !== 'still_in') {
        onListAppend(0, null, null, k + '无' + check_choices[_check] );
      }
      map.fillStyle = 'black';
      if (dotNotDraw) {
        map.fillText(k + check_choices[_check] + j[_check][k].length +
                     '个地址 其中' + dotNotDraw + '个无法显示 2022/' + _today,
                     0,svgHeight-1-fontSize);
        dotNotDraw = 0;
      } else if (j[_check] && j[_check][k]) {
        map.fillText(k + check_choices[_check] + ' ' + j[_check][k].length +
                     '个地址 2022/' + _today,
                     0,svgHeight-1-fontSize);
      }
      if (_check === 'today') {
        asyncNewAddr();
      } else if (_check === 'inB') {
        async14days(k);
      } else if (_check === 'districts') {
        list30days(k);
      } else if (_check === 'still_in') {
        asyncStill(k);
      }
      check_row.style.display = 'block';
      updateCheckStatus();
      addr.scrollIntoView(); //save_button
      clear_button.style.visibility = 'visible';
      if (autoSavePNG && !pngNot) {
        exportCanvasAsPNG();
      }
      return;
    } else if (k === '上海市') {
      svgWidth = 1250;
      svgHeight = 1000;
      fontSize = 14;
      d3center = [centers['徐汇区'][0], centers['徐汇区'][1] ]; // 黄浦
      if (d3scale < 48000) {
        d3scale = 48000; }
      if (!scaleChange && (hash2 && hash2.indexOf(k) !== 0) ) {
        reload_button.textContent = '重置可以查看全市';
        reload_button.style.fontWeight = 'bold';
        setTimeout(
          function () {
            reload_button.textContent = '重置';
            reload_button.style.fontWeight = 'normal';
          },
          1000 * 5
        );
      }
      draw_sh_addr();
      if (_check === 'today') {
        asyncNewAddr();
      } else if (_check === 'inB') {
        async14days();
      } else if (_check === 'districts') {
        list30days();
      } else if (['latest_added2', 'latest_added7', 'latest_added', 'still_in'
                 ].indexOf(_check) > -1) {
        generalAppend();
      }
      check_row.style.display = 'block';
      updateCheckStatus();
      addr.scrollIntoView(); //save_button
      clear_button.style.visibility = 'visible';
      if (autoSavePNG && !pngNot) {
        exportCanvasAsPNG();
      }
      return;
    }
    // 搜索地址
    //auto_save_off();
    if (!lastSearch || lastSearch !== k) {
      console.log('Input', k);
    }
    if (k.substr(0,4) === '浦东新区') {
      k = k.substr(4);
      addr.value = k;
    } else if (['上海市', '黄浦区', '静安区', '徐汇区', '长宁区',
                '普陀区', '虹口区', '杨浦区', '宝山区', '闵行区',
                '嘉定区', '金山区', '松江区', '青浦区', '奉贤区', '崇明区'].indexOf(
               k.substr(0,3) ) > -1) {
      k = k.substr(3);
      addr.value = k;
    }
    if (k.indexOf('=') > -1) {
      k = k.split('=')[0];
      addr.value = k;
      _check = check_choices['0'];
    }
    scale2x_button.style.visibility = 'visible';
    check_row.style.display = 'none';
    // for (ii = 0; ii < Ds.length; ii += 1) {
    //   document.getElementById(Ds[ii]).style.background = 'white';
    //   document.getElementById(Ds[ii] + 'line').textContent = '';
    //   th_k.textContent = '';
    // }
    th_k.textContent = '';
    Ds.forEach((d) => {
      document.getElementById(d).style.background = 'white';
      document.getElementById(d + 'line').textContent = '';
    });
    let kk; let ks; let sb = 0;
    let map_i = 0;
    let map_mustLabel = '';
    const map_x = [];
    const map_y = [];
    const map_addr = [];
    let release;
    for (i = 0; i < As.length; i += 1) {
      if (As[i].indexOf(k) > -1) {
        for (ii = 0; ii < Ds.length; ii += 1) {
          release = 0;
          if (j.districts[ Ds[ii] ].indexOf(As[i]) > -1) {
            //console.log(Ds[ii]);
            document.getElementById(Ds[ii]).style.background = 'yellow';
            document.getElementById(Ds[ii] + 'line').textContent += '|';
            sb += 1;

//onList.textContent += Ds[ii] + ',' + As[i] + ': ' + dl;
const dl = dldl(Ds[ii], As[i]);
if (j.listed_30days && j.listed_30days.indexOf(As[i]) > -1 && dl.length >= 30) {
  ks = '<span style="color:red;">' + sb + '.<sup>上榜' +
       dl.length + '次</sup></span> ';
} else {
  ks = '<span class="em">' + sb + '.</span> ';
}
if (map_i > 1) {
  ks += '<span class="click" onclick="search(this.textContent);">' + Ds[ii] + '</span>';
  ks += '<span class="click _L" onclick="lastSearch=\''+k+'\';search(\'';
} else {
  ks += '<span class="click _L" onclick="search(this.textContent);">' + Ds[ii] + '</span>';
  ks += '<span data-click="lastSearch=\''+k+'\';search(\'';
}
// scaleChange=true;
if (lastSearch && lastSearch !== As[i] && As[i].indexOf(lastSearch) > -1) {
  ks += lastSearch;
} else {
  ks += As[i];
}
ks += '\');">' + As[i] + '</span> ';
if (Ms.indexOf(Ds[ii] + As[i]) > -1) {
  map_i += 1;
} else {
  console.log('搜索地址 未显示', Ds[ii] + As[i]);
  dotNotDraw += 1; // 搜索地址
}
if (dl.length) {
  if (dl.join(',').indexOf(j.tag) > -1) {
    map_mustLabel += ',' + Ds[ii] + As[i];
    ks += '<span style="color:red">' + tagsHTML(dl) + '</span>';
  } else {
    ks += tagsHTML(dl);
  }
  release = parseInt( dl.slice(-1)[0] );
}
if (release) {
  release += (14 - 300);
  if (release < 32) {
    //onList.textContent += ' --> 4/' + release + '\n';
    ks += ' &rarr; 3/' + release +
          ' <span style="color:green">已满14天</span>';
  } else if (release < 131) { // release 4月30+1
    if (release > 100) {
      release -= 100;
    } else {
      release -= 31;
    }
    ks += ' &rarr; 4/' + release +
          ' <span style="color:green">已满14天</span>';
  } else if (release < 232) { // release 5月31+1
    if (release > 200) {
      release -= 200;
    } else {
      release -= 130;
    }
    ks += ' &rarr; 5/' + release;
    if (release < today.getDate() ) {
      ks += ' <span style="color:green">已满14天</span>';
    } else if (release === today.getDate() ) {
      ks += '<span style="color:green">是第14天</span>';
    }
  } else {
    ks += ' &rarr; 6/' + (release-231);
  }
}
if (_ww && _ww.indexOf(Ds[ii] + As[i]) > -1) {
  const wdl = W.pairs[ Ds[ii] + As[i] ];
  let dli; let dl0; let dl1; let dlt = true;
  //if (dl.length > 4) {
  //  console.log(_ww.length, '超过4个临近地址', Ds[ii] + As[i]);
  //  console.log(dl.join('\n'));
  //}
  for (dli = 0; dli < wdl.length; dli += 1) {
    if (wdl[dli].substr(0,4) === '浦东新区') {
      dl0 = wdl[dli].substr(0, 4);
      dl1 = wdl[dli].substr(4);
    } else {
      dl0 = wdl[dli].substr(0, 3);
      dl1 = wdl[dli].substr(3);
    }
    if (dl1 !== As[i]) {
      if (dlt) {
        dlt = false;
        ks += '<br/><span class="inAB_close" style="padding-left:1.6em">临近地址 '; // W.within
      } else {
        ks += '<br/><span class="inAB_close">'; // W.within
      }
      if (dl0 !== Ds[ii]) {
        ks += '<span class="click" onclick="search(this.textContent);">' +
            dl0 + '</span> ';
      }
      if (tagsHTML(dldl(dl0, dl1), 1) !== '') {
        ks += '<span class="click" onclick="search(this.textContent);">' +
            dl1 + '</span> 上榜于' +
            tagsHTML(dldl(dl0, dl1), 1) +
            '</span>';
      } else {
        ks += '<span class="click" onclick="updateLocation(j_data_init, this.textContent);">' +
            dl1 + '</span><!-- 上榜 --></span>';
      }
    }
  }
}
kk = document.createElement('p');
//kk.id = As[i];
kk.style.padding = '0';
kk.style.margin = '0';
kk.innerHTML = ks;
onList.appendChild(kk);
map_x.push(parseFloat( Ml.locations[Ds[ii] + As[i]][0] ));
map_y.push(parseFloat( Ml.locations[Ds[ii] + As[i]][1] ));
map_addr.push( Ds[ii] + As[i] );

          //if
          }
        }
      }
    }
    if (map_i === 0) {
      app.style.display = 'none';
      next_button.setAttribute('data-value', '');
      next_button.style.border = '';
      onListAppend(0, k.substr(0, k.length - 1), null, '&larr;可尝试');
    } else {
      if (map_i === 1) {
        next_button.setAttribute('data-value', map_addr[0]);
        next_button.style.border = '.25em solid red';
      }
      addr.scrollIntoView();
      th_k.textContent = k;
      if (!d3center || scaleChange) {
        d3center = [average(map_x), average(map_y) ];
      }
      let d3scale_;
      const map_XYlarge = Math.max.apply(null, [
        Math.max.apply(null, map_x) - Math.min.apply(null, map_x),
        Math.max.apply(null, map_y) - Math.min.apply(null, map_y) ]);
      // 黄浦区 0.0531 ~ 192000
      d3scale_ = parseInt(0.0531/map_XYlarge * 200000);
      //console.log('scale max', d3scale_);
      let map_XYtest = svgWidth;
      let map_XYzero;
      const localMinimal = [];
      if (mapX(map_x[0]) > 0 && mapX(map_x[0]) < svgWidth &&
          mapY(map_y[0]) > 0 && mapY(map_y[0]) < svgHeight &&
          j.address[map_addr[0].substr(map_addr[0].indexOf('区')+1)] ) {
        localMinimal.push([map_addr[0], map_y[0], map_x[0], 999-parseInt(
          j.address[map_addr[0].substr(map_addr[0].indexOf('区')+1)][0].substr(0,4) )]);
      }
      for (ii = 1; ii < map_i; ii += 1) {
        for (i = ii; i < map_i; i += 1) {
          map_XYzero = Math.sqrt(
            Math.pow((mapX(map_x[i])-mapX(map_x[i-ii])), 2) +
            Math.pow((mapY(map_y[i])-mapY(map_y[i-ii])), 2) );
          if (map_XYzero) {
            map_XYtest = Math.min.apply(null, [map_XYtest, map_XYzero]);
          }
        }
        if (mapX(map_x[ii]) > 0 && mapX(map_x[ii]) < svgWidth &&
            mapY(map_y[ii]) > 0 && mapY(map_y[ii]) < svgHeight &&
            j.address[map_addr[ii].substr(map_addr[ii].indexOf('区')+1)] ) {
          localMinimal.push([map_addr[ii], map_y[ii], map_x[ii], 999-parseInt(
            j.address[map_addr[ii].substr(map_addr[ii].indexOf('区')+1)][0].substr(0,4) )]);
        }
      }
      // .arc(3) 0.0004325 ~ 589319
      d3scale_ = Math.max.apply(null, [36000, d3scale_, Math.floor(d3scale_ * 3/map_XYtest )]);
      //console.log('scale min',
      //            Math.floor(d3scale_ * 3/map_XYtest ), ', used', d3scale_);
      //while (d3scale_ > 72000 * 16) { // line_dot_must_shown1
      //  d3scale_ = Math.floor(d3scale_/2);
      //}
      console.log('地址', k,
                  scaleChange, '更新前'+d3scale, '计算值'+d3scale_);
      if (d3scale_ && scaleChange && map_i < 100 && map_i > 1) {
        d3scale = d3scale_;
      }
      if (!scaleChange && d3scale > d3scale_) {
        reload_button.textContent = '重置'; // 重置可以展示所有地点
        // reload_button.style.fontWeight = 'bold';
        // setTimeout(
        //   function () {
        //     reload_button.textContent='重置';
        //     reload_button.style.fontWeight = 'normal';
        //   },
        //   1000*5
        // );
      }
      draw_sh();
      // for (i = 0; i < map_i; i += 1) {
      //   draw_addr(map_addr[i]);
      // }
      map_addr.forEach((d) => {
        draw_addr(d, true);
      });
      map.fillStyle = 'rgba(255,0,0,0.4)';
      (map_mustLabel !== '') && console.log('当日阳', map_mustLabel.substr(1));
      if (map_i > 1) {
        let labelNotDraw;
        let _Y; const gray_Y = [];
        for (i = 0; i < map_i; i += 1) {
          if (map_mustLabel.indexOf(map_addr[i]) > 0) {
            _Y = mapY(map_y[i]);
            gray_Y.push(_Y);
            map.fillText(map_addr[i],
                         mapX(map_x[i]) + 3, _Y);
          }
        }
        if (localMinimal.length > 1) {
          gray_Y.push(mapY( localMinimal[0][1] ));
          Array.from(localMinimal.slice(1)).forEach((d) => {
            if (!map_mustLabel || map_mustLabel.indexOf(d[0]) === -1) {
              labelNotDraw = false;
              _Y = mapY(d[1]);
              for (i = 0; i < gray_Y.length; i += 1) {
                if (Math.abs(_Y - gray_Y[i]) < fontSize+2) {
                  labelNotDraw = true;
                  break;
                }
              }
              if (!labelNotDraw) {
                gray_Y.push(_Y);
                map.fillText(d[0].substr(d[0].indexOf('区')+1),
                             mapX(d[2]) + 3, _Y);
              }
            }
          });
        }
      }
      if (localMinimal.length) {
        bubble2(localMinimal, 3);
        draw_addr_withLabel(localMinimal[0][0],
                            '上榜于' + digi2date(999-localMinimal[0][3]) );
      }
      map.fillStyle = 'red';
      if (dotNotDraw) {
        map.fillText('【' + k + '】' + (map_i + dotNotDraw) +
                     '个地址 显示了其中' + map_i + '个 2022/' + _today,
                     0,svgHeight-1-fontSize);
        dotNotDraw = 0;
      } else {
        map.fillText('【' + k + '】' + map_i + '个地址 2022/' + _today,
                     0,svgHeight-1-fontSize);
      }
    }
    if (sb === 0) {
      addr.focus();
      search_button.textContent = '无结果，可输入再搜';
      setTimeout(
        function () {
          search_button.textContent = '搜索';
        },
        1000 * 5
      );
    } else {
      search_button.textContent = '查到' + sb + '个地址，可输入再搜';
      setTimeout(
        function () {
          search_button.textContent = '搜索';
        },
        1000 * 5
      );
      clear_button.style.visibility = 'visible';
    }
    if (autoSavePNG && !pngNot) {
      exportCanvasAsPNG();
    }
  }

  function show_full (item) {
    const t = document.getElementById(item).getAttribute('data-value');
    if (t === "1") {
      document.getElementById(item).style.display = 'block';
      if (document.getElementById(item + '_once')) {
        document.getElementById(item + '_once').style.visibility = 'hidden';
      }
      document.getElementById(item).setAttribute('data-value', '0');
    } else {
      document.getElementById(item).style.display = 'none';
      document.getElementById(item).setAttribute('data-value', '1');
    }
  }

  function auto_save_off () {
    autoSavePNG = false;
    auto_save_status.style.boxShadow = '';
    pre_button.style.border = '';
    next_button.style.border = '';
    auto_save_.style.visibility = 'hidden';
    pngGif.style.visibility = 'hidden';
    const url = window.location.toString().split('=')[0];
    window.location = url;
  }

  function updateCheckStatus () {
    const checkboxes = document.getElementsByName('check');
    Array.from(checkboxes).forEach((d) => {
      if (_check === check_choices[d.getAttribute('data-value')] ) {
        d.checked = true;
      } else {
        d.checked = false;
      }
    });
  }

  function scale2x () {
    if (['市', '区'].indexOf(
        addr.value.slice(-1)[0] ) > -1 ) {
      window.alert('搜索地址时，可放大一倍。刷新页面，可重置');
      return false;
    }
    lastSearch = addr.value;
    d3scale = d3scale * 2;
    scale2x_button.style.visibility = 'hidden';
    setTimeout(
      function () {
        scale2x_button.style.visibility = 'visible';
      },
      1000 * 5
    );
    updateLocation(parseInt(j.tag), addr.value);
  }

  // https://stackoverflow.com/questions/9709209/
  function onlyOne (I) {
    const checkboxes = document.getElementsByName('check');
    Array.from(checkboxes).forEach((d) => {
      if (d !== I) d.checked = false;
    });
    _check = check_choices[I.getAttribute('data-value')];
    //console.log('data-value >', _check, j[_check]);
    search(addr.value, true);
  }
  </script>
  <!-- SukkaW/DisqusJS -->
  <link rel="stylesheet" href="https://unpkg.com/disqusjs@1.3/dist/disqusjs.css" />
  <script src="shanghaifabu/disqus130.js"></script>
  <!-- script src="https://unpkg.com/disqusjs@1.3/dist/disqus.js"></script -->
  <script src="shanghaifabu/html2canvas.min.141.js"></script>
  <script src="shanghaifabu/FileSaver.min.205.js"></script><!-- https://cdnjs.com/ -->
  <script src="shanghaifabu/jszip.min.391.js"></script>
  <style>
    body { background-color: white; }
    p { line-height: 1.5em; }
    .click,
    button,
    label> input[type=checkbox],
    #auto_save_status {
      cursor: pointer;
    }
    button { padding-top: .2em; }
    table> thead,
    #districtTbody {
      color: blue;
      font-size: 75%;
      text-align: center;
    }
    table {
      border-top: 1px solid blue;
      border-bottom: 1px solid blue;
      border-collapse: collapse;
    }
    tbody> tr {
      border-top: 1px solid blue;
    }
    #latest_added,
    #latest_released,
    #released {
      list-style-type: none;
      font-size: 75%;
    }
    ._L {
      padding: 0 .2em;
      box-shadow: inset 0 -.5em #d0d0d0;
      border: 0;}
    #th_k {
      text-align: left;
      color: blue;
      font-weight: normal;
    }
    #april, #may, #march {
      border: 0;
    }
    #april, #may, #march {
      box-shadow: inset 0 -7px #d0d0d0;
    }
    .april_button {
      box-shadow: inset 0 -8px #d0d0d0;
    }
    #check_row { font-size: 75%; }
    #check_row label {
      display: inline-block;
      padding-right: 10px;
      padding-left: 22px;
      text-indent: -22px;
    }
    #check_row input,
    #check_row label>span,
    p> #addr,
    p> button,
    p> label> span {
      vertical-align: middle;
    }
    #addr { color: red; }
    #search_button {
      font-weight: bold;
    }
    #pngGif {
      border: .25em solid cyan;
      background-color: rgba(44,255,255, 0.5);
      opacity: 0.5;
      padding: 0 1em;
      position: fixed;
      top: 14px;
      right: 0px;
    }
    #auto_save_status {
      width: 36px;
      display: inline-block;
      text-align: center;
    }
    .inAB_close {
      color: grey;
      padding-left: 6em;
      font-size: 75%;
    }
    em,
    span.em,
    #end_pre {
      color: grey;
    }
    em> span {
      color: white;
      background-color: grey;
      font-size: 90%;
      margin-left: .5em;
    }
  </style>
</head>
<body onload="load_js();">
  <p>
    数据来源 <a href="https://wsjkw.sh.gov.cn/xwfb/index.html" target="_blank">公众号 shanghaifabu</a>
      <span id="datestr" style="color:blue;"></span>
      <span id="fetching" style="color:blue;"> <span class="loading_pr">not ready,</span> loaded</span>
    <br/>本页为<span style="background-color:yellow;">2022年<span id="tag_m"></span>月<span id="tag_d"></span>日</span>的数据
    <br/> &nbsp;&nbsp;&nbsp;&nbsp;
      <span class="click" class="april_button" onclick="jumpApr(addr.value,3);"><span class="em">跳至</span>3/</span><input type="text" id="march" name="march" size=2 onkeydown="aprilEnter(3);" />
      &nbsp; <span class="click" class="april_button" onclick="jumpApr(addr.value);"><span class="em">跳至</span>4/</span><input type="text" id="april" name="april" size=2 onkeydown="aprilEnter();" />
      &nbsp; <span class="click" class="april_button" onclick="jumpApr(addr.value,5);"><span class="em">跳至</span>5/</span><input type="text" id="may" name="may" size=2 onkeydown="aprilEnter(5);" />
    <br/>搜索<span onclick="search(this.textContent);" class="click _L">上海市</span> 可以在地图中定位上榜地址

  </p>
  <p>
    <label for="addr"><span style="color:red;font-weight:bold;">上榜地址</span>
      <input type="text" id="addr" name="addr" onkeydown="lastSearch=null;addrEnter();" /></label>
    <button id="search_button" onclick="scaleChange=true;lastSearch=null;search(addr.value);">搜索</button>
    &nbsp;&nbsp; <span style="vertical-align:middle;color:grey;">以下基于2022/<span class="_tag"></span>的数据</span>
  </p>

  <div id="pngGif"></div>
  <button id="save_button" onclick="exportCanvasAsPNG(1);">存图</button>
  <button onclick="preReload(addr.value,1);">&lt;&lt;</button>
  <button id="pre_button" onclick="preReload(addr.value);">&lt;</button>
  <span id="auto_save_status" class="_tag">/</span>
  <button id="next_button" data-value="" style="visibility:hidden;" onclick="nextReload(addr.value);">&gt;</button>
  <button onclick="nextReload(addr.value,1);">&gt;&gt;</button>
  <button id="clear_button" style="visibility:hidden;" onclick="search();">隐藏</button>
  <button id="reload_button" onclick="window.location.reload();">重置</button>
  <button id="scale2x_button" style="visibility:hidden;" onclick="scale2x();">放大</button>
  <span id="fetching2" style="color:blue;">Loading<span id="loading_span"></span>
    <span class="loading_pr"></span></span>
  <span id="auto_save_" style="color:cyan;">自动缓存&rarr;</span><br/>

  <canvas id="app" style="display:none;"></canvas>
  <!-- 3.district 2.inB 0.today 4.released 5.released_today 1.latest_added -->
  <div id="check_row" style="display:none;">
    <label><span>2022年 3月6日 至
             <span id="tag_m2"></span>月<span id="tag_d2"></span>日
           </span></label>
    <label id="check7" style="display:none;"><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="7" /><span style="color:red">七阴阳</span></label>
    <label id="check6" style="display:none;"><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="6" /><span style="color:red">三阴阳</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="1" /><span style="color:red">比昨日多</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="0" /><span style="color:red">当日阳</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="8" /><span style="color:red">计算阳</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="2" /><span style="color:red">两周阳</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="3" /><span style="color:red">累计阳</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="4" /><span style="color:green">累计下榜</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="5" /><span style="color:green">当日下榜</span></label>
  </div>

  <div style="width:100%;color:blue;" id="onList"></div>

  <h2 id="h2dist"><span onclick="search(this.textContent);" class="click">上海市</span>各区统计（地址数）</h2>
  <table>
    <thead><tr style="color:black;"><th>&nbsp;行政单位&nbsp;</th><th>&nbsp;累计上榜&nbsp;</th>
      <th id="th_k"></th><th>&nbsp;两周内&nbsp;</th><th>&nbsp;<span class="_tag"></span>涉及&nbsp;</th>
      <th>&nbsp;累计下榜&nbsp;</th><th>&nbsp;<span class="_tag"></span>下榜&nbsp;</th></tr></thead>
    <tbody id="districtTbody"></tbody>
  </table>

  <h2 onclick="show_full('latest_added');" style="color:red;" class="click _L">值得关注的地址</h2>
  <div style="color:red;" id="latest_added"></div>

  <h2 onclick="show_full('latest_released');" class="click _L"><span class="_tag"></span>下榜的地址<em id="latest_released_once">点击显示</em></h2>
  <div style="color:green;display:none;" id="latest_released" data-value="1"></div>

  <h2 onclick="show_full('released');" class="click _L">累计下榜的地址<em id="released_once">点击显示</em></h2>
  <div style="color:green;display:none;" id="released" data-value="1"></div>

  <pre id="end_pre">EOF</pre>
  <div id="disqus_thread"></div>
  <!-- script>
  (function() { // 官网 通用代码
    var d = document, s = d.createElement('script');
    s.src = 'https://sh-teach-cn.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
  </script -->
</body>
</html>
