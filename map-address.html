<!DOCTYPE html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>d3js listed address</title>
  <script src="d3.min.v3.js"></script>
  <script src="topojson.min.180.js"></script>
  <script src="sh.topojson?v=0430"></script>
  <script>
  const svgWidth = 500;
  const svgHeight = 500;
  const svg = d3.select('#app'
               ).append('svg'
               ).attr('height', svgHeight
               ).attr('width', svgWidth);
  let pj, pg, zoom;

  function load () {
    const tj = JSON.parse(data);
    pj = d3.geo.mercator(
          ).scale((1 << 22)/2/Math.PI
          ).translate([svgWidth/2, svgHeight/2]);
    const ct = pj([-1.79636106388265,46.7740619963089]); // 徐汇区
    pg = d3.geo.path().projection(pj);
    zoom = d3.behavior.zoom(
            ).scale(pj.scale() * 2 * Math.PI
            ).scaleExtent([1 << 22, 1 << 28]
            ).translate([svgWidth - ct[0], svgHeight - ct[1]]
            ).on('zoom', zoomed);
    svg.call(zoom);
    const dt = topojson.feature(tj, tj.objects.collection);
    pj.scale(1).translate([0, 0]);
    const b = pg.bounds(dt);
    console.log(b);
    const s = 0.9/Math.max((b[1][0] - b[0][0])/svgWidth, (b[1][1] - b[0][1])/svgHeight);
    const t = [(svgWidth - s * (b[1][0] + b[0][0]))/2,
               (svgHeight - s * (b[1][1] + b[0][1]))/2];
    pj.scale(s).translate(t);
    svg.selectAll('path'
      ).data(dt.features
      ).enter(
      ).append('path'
      ).attr('d', pg);
    zoomed();
  }

  function zoomed () {
    pj.scale(zoom.scale()/2/Math.PI
     ).translate(zoom.translate());
    svg.attr('d', pg);
  }
  </script>
  <style type="text/css">
    body {background-color:white;}
  </style>
</head>
<body onload="load();">
  <p>
    数据来源 <a href="https://wsjkw.sh.gov.cn/xwfb/index.html" target="_blank">公众号 shanghaifabu</a>
    </p>
  <div id="app"></div>
</body>
