<!DOCTYPE html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>listed address, since 2022 March 18th</title>
  <script src="full.json?v=0430"></script>
  <script src="d3.min.v3.js"></script>
  <script src="topojson.min.180.js"></script>
  <script src="sh.json"></script>
  <script src="map-location.json"></script>
  <script>
  let i; let j; let As; let Ds;
  const today = new Date();
  let Ml; let Ms; let map;
  let d3scale = 32000;
  let d3center = [121.43752, 31.179973]; // 徐汇区
  const svgWidth = 600;
  const svgHeight = 400;

  function mapX(z) {
    return Math.round((z - d3center[0]) * d3scale/57 + svgWidth/2);
  }

  function mapY(z) {
    return Math.round((d3center[1] - z) * d3scale/49 + svgHeight/2);
  }

  function load () {
    j = JSON.parse(data);
    Ml = JSON.parse(csv);
    Ms = Object.keys(Ml.locations);
    datestr.textContent = j.date;
    end_pre.textContent = j.date;
    let k;
    Ds = Object.keys(j.districts);
    As = Object.keys(j.address);
    console.log( j.address['shanghaifabu'] );
    for (i = 0; i < Ds.length; i += 1) {
      k = document.createElement('tr');
      // if (Ds[i] === '普陀区') {
      //   console.log( j.inB[ Ds[i] ] );
      //   console.log( j.today[ Ds[i] ] );
      // }
      if (j.released_today[ Ds[i] ] ) {
        k.innerHTML = '<td>' + Ds[i] + '</td><td>' +
                      j.districts[ Ds[i] ].length + '</td><td id="' +
                      Ds[i] + 'dot" style="text-align:left;"></td><td>' +
                      (j.inB[ Ds[i] ] || []).length + '</td><td style="color:red;">' +
                      (j.today[ Ds[i] ] || []).length + '</td><td style="color:green;">' +
                      (j.released[ Ds[i] ] || []).length + '</td><td style="color:green;">' +
                      (j.released_today[ Ds[i] ] || []).length + '</td>';
      } else {
        k.innerHTML = '<td>' + Ds[i] + '</td><td>' +
                      j.districts[ Ds[i] ].length + '</td><td id="' +
                      Ds[i] + 'dot" style="text-align:left;"></td><td>' +
                      (j.inB[ Ds[i] ] || []).length + '</td><td style="color:red;">' +
                      (j.today[ Ds[i] ] || []).length + '</td><td style="color:green;">' +
                      (j.released[ Ds[i] ] || []).length + '</td><td style="color:green;">' +
                      '&ndash;</td>';
      }
      k.id = Ds[i];
      districtTable.appendChild(k);
      k = document.createElement('p');
      if (j.latest_added && j.latest_added[ Ds[i] ] ) {
        k.innerHTML = '<span style="color:black;">' + Ds[i] + '：下列' +
                      j.latest_added[ Ds[i] ].length + '个地址不同于昨日，今日涉及' + (j.today[ Ds[i] ] || []).length +
                      '个地址</span><br/>' + j.latest_added[ Ds[i] ];
      } else {
        k.innerHTML = '<span style="color:black;">' + Ds[i] + '：今日涉及' +
                      (j.today[ Ds[i] ] || []).length +
                      '个地址</span>';
      }
      latest_added.appendChild(k);
      k = document.createElement('p');
      if (j.released_today && j.released_today[ Ds[i] ] ) {
        k.innerHTML = '<span style="color:black;">' + Ds[i] + ':</span> ' + j.released_today[ Ds[i] ];
      } else {
        k.innerHTML = '<span style="color:black;">' + Ds[i] + ':</span> 无';
      }
      latest_released.appendChild(k);
      k = document.createElement('p');
      k.innerHTML = '<span style="color:black;">' + Ds[i] + ':</span> ' + j.released[ Ds[i] ];
      released.appendChild(k);
    }
    map = document.getElementById('app').getContext('2d');
  }

  function draw () { // map-address.html
    app.width = svgWidth;
    app.height = svgHeight;
    app.style.display = 'block';
    app.style.padding = '10px 0 0 0';
    const jj = JSON.parse(sh);
    const dt = topojson.feature(jj, jj.objects.collection);
    const dn = topojson.neighbors(jj.objects.collection.geometries);
    const pj = d3.geo.mercator(
                ).scale(d3scale).center(d3center
                ).translate([svgWidth/2, svgHeight/2]);
    const pg = d3.geo.path().projection(pj).context(map);
    map.strokeStyle = 'grey';
    dt.features.forEach(d => {
      map.beginPath();
      pg(d);
      map.stroke();
      //map.fillStyle = 'rgba(255,20,20,'+ 1/(d.properties.subFeatureIndex+2) + ')';
      //map.fill();
      map.fillStyle = 'grey';
      map.fillText(d.properties.name,
                   mapX(d.properties.center[0]),
                   mapY(d.properties.center[1]));
    });
  }

  function search () {
    let k = addr.value;
    search_button.textContent = '搜索';
    if (k === '') {
      addr.focus();
      app.style.display = 'none';
      return;
    }
    map.clearRect(0, 0, svgWidth, svgHeight);
    draw();
    let map_i = 0;
    console.log(k);
    onList.textContent = '';
    let ii;
    for (ii = 0; ii < Ds.length; ii += 1) {
      document.getElementById(Ds[ii]).style.background = 'white';
      document.getElementById(Ds[ii] + 'dot').textContent = '';
    }
    let dl; let kk; let ks; let sb = 0;
    for (i = 0; i < As.length; i += 1) {
      if (As[i].indexOf(k) > -1) {
        dl = j.address[ As[i] ];
        let ij; let ik; let il = 0; let release;
        for (ii = 0; ii < Ds.length; ii += 1) {
          ij = j.districts[ Ds[ii] ];
          for (ik = 0; ik < ij.length; ik += 1) {
            if (ij[ik] === As[i]) {
              document.getElementById(Ds[ii]).style.background = 'yellow';
              document.getElementById(Ds[ii] + 'dot').textContent += '|';
              //console.log(Ds[ii]);
              il += 1;
              sb += 1;

        //onList.textContent += Ds[ii] + ',' + As[i] + ': ' + dl;
        if (sb < 10) {
          ks = '<span style="color:grey;"><span style="color:white;">0</span>' + sb + '.</span> <span>';
        } else {
          ks = '<span style="color:grey;">' + sb + '.</span> <span>';
        }
        if (Ms.indexOf(Ds[ii] + As[i]) > -1) {
          map.beginPath();
          map.arc(mapX( Ml.locations[Ds[ii] + As[i]][0] ),
                  mapY( Ml.locations[Ds[ii] + As[i]][1] ),
                  3, 0 * Math.PI, 2 * Math.PI);
          map.strokeStyle = 'red';
          map.stroke();
          map_i += 1;
        } else {
          console.log('missing', Ds[ii] + As[i]);
        }
        ks += Ds[ii] +
              '<a href="https://maps.baidu.com/search/?querytype=s&wd=' +
              As[i] + '" target="_blank">' + As[i] + '</a> ';
        if (il === 1) { // 地址同名 有待优化, 团结村
          if (('' + dl).indexOf('0430') > 0) {
            ks += '<span style="color:red">' + dl + '</span>';
          } else {
            ks += dl;
          }
          release = parseInt(dl[dl.length - 1]);
        } else {
          const s1 = ('' + dl).split(Ds[ii]);
          const s2 = s1[s1.length - 2];
          ks += s2.substr(s2.lastIndexOf(',') + 1);
          release = parseInt( s2.substr(s2.lastIndexOf(',') + 1) );
        }
        ks = ks.replace(/030/g, '3/').replace(/040/g, '4/'
              ).replace(/03/g, '3/').replace(/04/g, '4/');
        release += (14 - 400);
        if (release < today.getDate()-1 ) {
          ks += ' <span style="color:green">已满14天</span></span>';
        } else if (release === today.getDate()-1 ) {
          ks += ' <span style="color:green">第14天</span></span>';
        } else if (release < 31) {
          //onList.textContent += ' --> 4/' + release + '\n';
          ks += ' &rarr; <em>4/' + release + '</em></span>';
        } else {
          //onList.textContent += ' --> 5/' + (release-30) + '\n';
          ks += ' &rarr; <em>5/' + (release-30) + '</em></span>';
        }
        let kk = document.createElement('p');
        //kk.id = As[i];
        kk.style.padding = '0';
        kk.style.margin = '0';
        kk.innerHTML = ks;
        onList.appendChild(kk);

            }
          }
        }
      }
    }
    if (map_i === 0) {
      app.style.display = 'none';
    }
    if (sb === 0) {
      addr.focus();
      search_button.textContent = '无结果，可输入再搜';
    } else {
      search_button.textContent = '查到' + sb + '个地址，可输入再搜';
    }
  }

  function show_full (item) {
    const t = document.getElementById(item).getAttribute('data-value');
    if (t === "1") {
      document.getElementById(item).style.display = 'block';
      if (document.getElementById(item + '_once')) {
        document.getElementById(item + '_once').style.visibility = 'hidden';
      }
      document.getElementById(item).setAttribute('data-value', "0");
    } else {
      document.getElementById(item).style.display = 'none';
      document.getElementById(item).setAttribute('data-value', "1");
    }
  }
  </script>
  <style type="text/css">
    body {background-color:white;}
    p {line-height:1.5em;}
  </style>
</head>
<body onload="load();">
  <p>
    数据来源 <a href="https://wsjkw.sh.gov.cn/xwfb/index.html" target="_blank">公众号 shanghaifabu</a> &nbsp;&nbsp;
    更新时间 <span id="datestr" style="color:blue;">fetching... not ready</span><br/>
    本页的<span style="background-color:yellow;">今日</span>为2022年4月30日 <!-- 0430 -->
  </p>
  <p>
    <label for="addr">上榜地址</label>
    <input type="text" id="addr" name="addr" />
    <button id="search_button" onclick="search();">搜索</button>
  </p>
  <div style="width:100%;color:blue;" id="onList"></div>
  <h2>各区统计（地址数）</h2>
  <table id="districtTable" style="border:1px solid blue;color:blue;font-size:75%;text-align:center;">
    <tr style="color:black;"><th>行政单位</th><th>累计上榜</th><th></th><th>两周内</th><th>今日涉及</th>
      <th>累计下榜</th><th>今日下榜</th></tr>
  </table>

  <canvas id="app" style="display:none;"></canvas>

  <h2 onclick="show_full('latest_added');" style="cursor:pointer;">值得关注的地址</h2>
  <div style="color:red;list-style-type:none;font-size:75%;" id="latest_added"></div>
  <h2 onclick="show_full('latest_released');" style="cursor:pointer;">今日下榜的地址<i id="latest_released_once" style="color:grey;">点击显示</i></h2>
  <div style="color:green;list-style-type:none;font-size:75%;display:none;" id="latest_released" data-value="1"></div>
  <h2 onclick="show_full('released');" style="cursor:pointer;">累计下榜的地址<i id="released_once" style="color:grey;">点击显示</i></h2>
  <div style="color:green;list-style-type:none;font-size:75%;display:none;" id="released" data-value="1"></div>
  <pre id="end_pre" style="color:grey">EOF</pre>
</body>
</html>
