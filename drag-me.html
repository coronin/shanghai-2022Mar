<!DOCTYPE html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>shanghaifabu listed address, since 2022 March 18th</title>
  <script src="full.json?v=0428"></script>
  <script>
  let i; let j; let As; let Ds;
  const today = new Date();

  function load () {
    j = JSON.parse(data);
    datestr.textContent = j.date;
    let k;
    Ds = Object.keys(j.districts);
    As = Object.keys(j.address);
    console.log( j.address['shanghaifabu'] );
    for (i = 0; i < Ds.length; i += 1) {
      k = document.createElement('tr');
      k.id = Ds[i];
      // if (Ds[i] === '普陀区') {
      //   console.log( j.inB[ Ds[i] ] );
      //   console.log( j.today[ Ds[i] ] );
      // }
      if (j.released_today[ Ds[i] ] ) {
        k.innerHTML = '<tr><td>' + Ds[i] + '</td><td>' +
                      j.districts[ Ds[i] ].length + '</td><td>' +
                      (j.inB[ Ds[i] ] || []).length + '</td><td style="color:red;">' +
                      (j.today[ Ds[i] ] || []).length + '</td><td style="color:green;">' +
                      (j.released[ Ds[i] ] || []).length + '</td><td style="color:green;">' +
                      (j.released_today[ Ds[i] ] || []).length + '</td></tr>';
      } else {
        k.innerHTML = '<tr><td>' + Ds[i] + '</td><td>' +
                      j.districts[ Ds[i] ].length + '</td><td>' +
                      (j.inB[ Ds[i] ] || []).length + '</td><td style="color:red;">' +
                      (j.today[ Ds[i] ] || []).length + '</td><td style="color:green;">' +
                      (j.released[ Ds[i] ] || []).length + '</td><td style="color:green;">' +
                      '&ndash;</td></tr>';
      }
      districtTable.appendChild(k);
      if (j.latest_added && j.latest_added[ Ds[i] ] ) {
        k = document.createElement('p');
        k.innerHTML = '<span style="color:black;">' + Ds[i] + ':</span> ' + j.latest_added[ Ds[i] ];
        latest_added.appendChild(k);
      }
      if (j.released_today && j.released_today[ Ds[i] ] ) {
        k = document.createElement('p');
        k.innerHTML = '<span style="color:black;">' + Ds[i] + ':</span> ' + j.released_today[ Ds[i] ];
        latest_released.appendChild(k);
      }
      k = document.createElement('p');
      k.innerHTML = '<span style="color:black;">' + Ds[i] + ':</span> ' + j.released[ Ds[i] ];
      released.appendChild(k);
    }
  }

  function search () {
    let k = addr.value;
    if (k === '') {
      addr.focus();
      return;
    }
    console.log(k);
    onList.textContent = '';
    for (ii = 0; ii < Ds.length; ii += 1) {
      document.getElementById(Ds[ii]).style.background = 'white';
    }
    let dl; let kk; let ks;
    for (i = 0; i < As.length; i += 1) {
      if (As[i].indexOf(k) > -1) {
        dl = j.address[ As[i] ];
        let ii; let ij; let ik; let il = 0; let release;
        for (ii = 0; ii < Ds.length; ii += 1) {
          ij = j.districts[ Ds[ii] ];
          for (ik = 0; ik < ij.length; ik += 1) {
            if (ij[ik] === As[i]) {
              document.getElementById(Ds[ii]).style.background = 'yellow';
              //console.log(Ds[ii]);
              il += 1;

        //onList.textContent += Ds[ii] + ',' + As[i] + ': ' + dl;
        ks = '<span>' + Ds[ii] +
             ' [<a href="https://maps.baidu.com/search/?querytype=s&wd=' +
                        As[i] + '" target="_blank">' +
                        As[i] + '</a>] ';
        if (il === 1) { // 地址同名 有待优化, 团结村
          if (('' + dl).indexOf('0428') > 0) {
            ks += '<span style="color:red">' + dl + '</span>';
          } else {
            ks += dl;
          }
          release = parseInt(dl[dl.length - 1]);
        } else {
          const s1 = ('' + dl).split(Ds[ii]);
          const s2 = s1[s1.length - 2];
          ks += s2.substr(s2.lastIndexOf(',') + 1);
          release = parseInt( s2.substr(s2.lastIndexOf(',') + 1) );
        }
        release += (14 - 400);
        if (release < today.getDate()-1 ) {
          ks += ' <span style="color:green">已满14天</span></span>';
        } else if (release === today.getDate()-1 ) {
          ks += ' <span style="color:green">第14天</span></span>';
        } else if (release < 31) {
          //onList.textContent += ' --> 4/' + release + '\n';
          ks += ' &rarr; <em>4/' + release + '</em></span>';
        } else {
          //onList.textContent += ' --> 5/' + (release-30) + '\n';
          ks += ' &rarr; <em>5/' + (release-30) + '</em></span>';
        }
        let kk = document.createElement('p');
        //kk.id = As[i];
        kk.style.padding = '0';
        kk.style.margin = '0';
        kk.innerHTML = ks;
        onList.appendChild(kk);

            }
          }
        }
      }
    }
  }

  function show_full (t) {
    if (t === 1) {
      released.style.display = 'block';
    } else if (t === 2) {
      latest_released.style.display = 'block';
    }
  }
  </script>
</head>
<body onload="load();">
  <p>
    数据来源 公众号 shanghaifabu，更新时间 <span id="datestr" style="color:blue;">fetching... not ready</span>
  </p>
  <p>
    <label for="addr">上榜地址</label>
    <input type="text" id="addr" name="addr" />
    <button onclick="search();">搜索</button>
  </p>
  <div style="width:100%;color:blue;" id="onList"></div>
  <h2>各区统计（地址数）</h2>
  <table id="districtTable" style="border:1px solid blue;color:blue;font-size:75%;text-align:center;">
    <tr style="color:black;"><th>行政单位</th><th>累计上榜</th><th>两周内</th><th>0428涉及</th>
      <th>累计下榜</th><th>0428下榜</th></tr>
  </table>
  <h2>值得关注的地址</h2>
  <div style="list-style-type:none;font-size:75%;" id="latest_added"></div>
  <h2 onclick="show_full(2);" style="cursor:pointer;">点击显示0428下榜的地址</h2>
  <div style="color:green;list-style-type:none;font-size:75%;display:none;" id="latest_released"></div>
  <h2 onclick="show_full(1);" style="cursor:pointer;">点击显示累计下榜的地址</h2>
  <div style="color:green;list-style-type:none;font-size:75%;display:none;" id="released"></div>
</body>
