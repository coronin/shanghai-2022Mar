<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>listed address, in map, since 2022 March 18th</title>
  <!-- script src="full.json"></script -->
  <script src="shanghaifabu/map-location.json?v=0504"></script><!-- @ -->
  <script src="d3.min.v3.js"></script>
  <script src="topojson.min.180.js"></script><!-- http://geojson.io -->
  <script src="shanghaifabu/sh.json"></script><!-- http://datav.aliyun.com/portal/school/atlas/area_generator -->
  <script src="shanghaifabu/sh-awesome-cn-cafe.json"></script>
  <script src="shanghaifabu/sh-river.json"></script>
  <script src="shanghaifabu/sh-lines.json"></script>
  <script src="html2canvas.min.141.js"></script>
  <script>
  let i; let j; let j_data_init; let As; let Ds;
  const today = new Date();
  let _today; // j.tag
  let Ml; let Ms; let map;
  let d3scale; let d3center; let svgWidth; let svgHeight;
  const centers = {
    '黄浦区':[121.480694,31.219042,415000],
    '徐汇区':[121.437778,31.160901,196000],
    '长宁区':[121.378590,31.215582,300000],
    '静安区':[121.448927,31.268736,219500],
    '普陀区':[121.381162,31.264039,250000],
    '虹口区':[121.486229,31.275661,280000],
    '杨浦区':[121.523566,31.294815,220000],
    '闵行区':[121.427945,31.107098,77000],
    '宝山区':[121.381889,31.372927,90000],
    '嘉定区':[121.248203,31.355204,87200],
    '浦东新区':[121.612666, 31.12, 42000], // 浦东新区 121.61266647653576 31.08079112113293
    '金山区':[121.24, 30.81, 70000], // 金山区 121.17171114485453 30.857028553162657
    '松江区':[121.203370,31.013900,80000],
    '青浦区':[121.096709,31.120809,66500],
    '奉贤区':[121.529829,30.926042,82400],
    '崇明区':[121.548589, 31.62, 32000]}; // 崇明区 121.54858925095525 31.669887634215034
  const sh_district7 = ['黄浦区','徐汇区','长宁区','静安区','普陀区','虹口区','杨浦区'];
  const check_choices = {
    '5':'released_today', '4':'released',
    '3':'districts', '2':'inB', '1':'latest_added', '0':'today',
    'released_today':'当日下榜', 'released':'累计下榜',
    'districts':'累计阳', 'inB':'两周阳', 'latest_added':'比昨日多', 'today':'当日阳' }
  let _check = check_choices['0'];
  let dotNotDraw = 0;
  const baseURL = window.location.toString().split('#')[0].split('?')[0];
  let hash = window.location.hash.slice(1).split('?')[0];
  const hash2 = decodeURIComponent(window.location.toString()).split('?')[1]; // undefined
  let autoSavePNG = (window.location.toString().indexOf('=') > -1);
  if (autoSavePNG) {
    hash = hash.split('=')[0];
    _check = window.location.toString().split('=')[1];
  }
  let scaleChange = true;
  let lastSearch;
  let fontSize;

  function mapX (z) {
    return zz = Math.round((z - d3center[0]) * d3scale/57 + svgWidth/2);
  }

  function mapY (z) {
    return zz = Math.round((d3center[1] - z) * d3scale/49 + svgHeight/2);
  }

  function inChina(lng, lat) {
    if (lng && lng > 73.66 && lng < 135.05) {
      if (lat && lat > 3.86 && lat < 53.55) {
        return true;
    } }
    return false;
  }

  // https://stackoverflow.com/questions/10359907
  var average = arr => arr.reduce((prev, curr) => prev + curr) / arr.length;

  function pngDown (fileH, imgURL) {
    const dlLink = document.createElement('a');
    dlLink.download = fileH + '2022' + j.tag + (Math.random() + '').substr(1,5) + '.png';
    dlLink.href = imgURL;
    dlLink.dataset.downloadurl = ['image/png', dlLink.download, dlLink.href].join(':');
    document.body.appendChild(dlLink);
    dlLink.click();
    document.body.removeChild(dlLink);
  }

  function exportCanvasAsPNG () {
    // https://stackoverflow.com/questions/923885/
    // https://stackoverflow.com/questions/53757970/
    let fileH = addr.value || '表格';
    if (app.style.display !== 'none') {
      fileH += check_choices[_check];
      const canvasElement = document.getElementById('app');
      pngDown(fileH, canvasElement.toDataURL('image/png') );
    } else {
      html2canvas(document.querySelector("#districtTable")).then(canvasElement => {
        pngDown(fileH, canvasElement.toDataURL('image/png') );
      });
    }
  }

  function preReload (q, oldest) {
    let url;
    if (j && j.address['shanghaifabu'].length > 2) {
      url = baseURL + '#';
      url += j.address['shanghaifabu'].slice(-3)[0];
    }
    if (oldest) {
      url = baseURL + '#0319';
    }
    if (url) {
      if (q) {
        url += '?' + q;
      }
      if (d3scale) {
        url += '$' + d3scale;
        if (d3center && d3center.length === 2) {
          url += '_' + d3center[0] + '_' + d3center[1];
        }
      }
      if (autoSavePNG) {
        url += '=' + _check;
      }
      window.location = url;
      window.location.reload();
    } else {
      window.alert('没有前一日的数据\n可刷新本页再试');
    }
  }

  function nextReload (q, lastest) {
    let hash_;
    try {
      if (hash) {
        hash_ = parseInt(hash) + 1;
      } else {
        hash_ = parseInt(j.tag) + 1;
      }
    } catch (err) {
      window.alert('没有后一日的数据');
      return;
    }
    if (hash_ > 430 && hash_ < 501) {
      hash_ += 70; // -30 +100
    } else if (hash_ > 331 && hash_ < 401) {
      hash_ += 69; // -31 +100
    }
    if (lastest) {
      hash_ = j_data_init;
    }
    let url = baseURL + '#0' + hash_;
    if (q) {
      url += '?' + q;
    }
    if (d3scale) {
      url += '$' + d3scale;
      if (d3center && d3center.length === 2) {
        url += '_' + d3center[0] + '_' + d3center[1];
      }
    }
    if (autoSavePNG) {
      url += '=' + _check;
    }
    window.location = url;
    window.location.reload();
  }

  function jumpApr (q) {
    const hash_ = parseInt(april.value);
    if (!april.value || !hash_ || hash_ > 30 || hash_ < 1) {
      april.value = '';
      return;
    }
    let url = baseURL + '#04';
    if (hash_ < 10) { url += '0'; }
    url += hash_;
    if (q) {
      url += '?' + q;
    }
    if (d3scale) {
      url += '$' + d3scale;
      if (d3center && d3center.length === 2) {
        url += '_' + d3center[0] + '_' + d3center[1];
      }
    }
    if (autoSavePNG) {
      url += '=' + _check;
    }
    window.location = url;
    window.location.reload();
  }

  function aprilEnter () {
    const keyCode = ('which' in event) ? event.which : event.keyCode;
    if (keyCode === 13) {
      jumpApr(addr.value);
    }
  }

  function addrEnter () {
    const keyCode = ('which' in event) ? event.which : event.keyCode;
    if (keyCode === 13) {
      //scaleChange = true;
      search(addr.value);
    }
  }

  const loading = ['.', '..', '...', '']; // ['\\', '/', '-']
  let loading_i = -1;
  (function f () {
    loading_i = (loading_i + 1) % loading.length;
    if (document.getElementById('loading_span')) {
      loading_span.textContent = loading[ loading_i ];
    }
    setTimeout(f, 250);
  })();

  function load_js () {
    let k = document.createElement('script');
    const hash_ = parseInt(hash);
    if (hash.length !== 4 || hash_ < 319 || hash_ > j_data_init) {
      hash = '0' + j_data_init;
      if (window.location.hash.slice(1).indexOf('?') > -1) {
        window.location = baseURL + '#' + hash + '?' + hash2;
      } else {
        window.location = baseURL + '#' + hash;
      }
    } else {
      if (hash_ < j_data_init) {
        next_button.style.visibility = 'visible'; }
      if (hash_ === 319) {
        pre_button.style.visibility = 'hidden'; }
    }
    k.src = "shanghaifabu/full" + hash + '.json';
    console.log('Load json files for', hash);
    document.head.append(k);
    k.onload = function () { load(); };
    k.onerror = function () {
      window.alert('无法下载 full.json\n' + baseURL);
      pre_button.style.visibility = 'hidden';
      save_button.style.visibility = 'hidden';
      addr.style.visibility = 'hidden';
      search_button.style.visibility = 'hidden';
      districtTable.style.visibility = 'hidden';
    };
  }

  function hash2date (_s) {
    const _m = parseInt(_s.substr(0,2) );
    const _d = parseInt(_s.substr(2,2) );
    if (_s.length === 4 && [3,4,5].indexOf(_m) > -1 && _d > 0 && _d < 32) {
      return _m + '/' + _d;
    } else {
      return tag_m.textContent + '/' + tag_d.textContent;
    }
  }

  function tagsHTML (dl) {
    let di, ds = '';
    for (di = 0; di < dl.length; di += 1) {
      ds += '<span class="click" onclick="window.location=\'#' + dl[di] +
            '\';window.location.reload();">' + hash2date(dl[di]) + '</span>';
      if (di < dl.length-1) {
        ds += ', ';
      }
    }
    return ds;
  }

  function load () {
    j = JSON.parse(data);
    j_data_init = parseInt(j.tag);
    Ml = JSON.parse(csv);
    Ms = Object.keys(Ml.locations);
    datestr.textContent = j.date;
    end_pre.textContent = '更新时间 ' + j.date + '\n源代码 github.com/coronin/shanghai-2022Mar';
    tag_m.textContent = parseInt(j.tag.substr(0,2) );
    tag_m2.textContent = tag_m.textContent;
    tag_d.textContent = parseInt(j.tag.substr(2,2) );
    tag_d2.textContent = tag_d.textContent;
    _today = hash2date(j.tag);
    const tags = document.getElementsByClassName('_tag');
    let k;
    for (k = 0; k < tags.length; k += 1) {
      tags[k].textContent = _today;
    }
    auto_save_status.onclick = function () {
      if (autoSavePNG) {
        auto_save_off();
      } else {
        autoSavePNG = true;
        auto_save_status.style.boxShadow = 'inset 0 -.5em cyan';
        pre_button.style.border = '.25em solid cyan';
        next_button.style.border = '.25em solid cyan';
        exportCanvasAsPNG();
      }
    }
    check_row.onclick = function () {
      auto_save_off();
    }
    if (autoSavePNG) {
      auto_save_status.style.boxShadow = 'inset 0 -.5em cyan';
      pre_button.style.border = '.25em solid cyan';
      next_button.style.border = '.25em solid cyan';
    }
    Ds = Object.keys(j.districts);
    As = Object.keys(j.address);
    console.log( j.address['shanghaifabu'] );
    for (i = 0; i < Ds.length; i += 1) {
      k = document.createElement('tr');
      // if (Ds[i] === '普陀区') {
      //   console.log( j.inB[ Ds[i] ] );
      //   console.log( j.today[ Ds[i] ] );
      // }
        k.innerHTML = '<td class="click" onclick="_check=\'today\';search(this.textContent);">' +
                      Ds[i] + '</td><td class="click" onclick="_check=\'districts\';search(\''+Ds[i]+'\');">' +
                      j.districts[ Ds[i] ].length + '</td><td id="' +
                      Ds[i] + 'line" style="text-align:left;"></td><td class="click" onclick="_check=\'inB\';search(\''+Ds[i]+'\');">' +
                      (j.inB[ Ds[i] ] || []).length +
                      '</td><td style="color:red;" class="click" onclick="_check=\'latest_added\';search(\''+Ds[i]+'\');">' +
                      (j.today[ Ds[i] ] || []).length +
                      '</td><td style="color:green;" class="click" onclick="_check=\'released\';search(\''+Ds[i]+'\');">' +
                      (j.released[ Ds[i] ] || []).length + '</td>';
      if (j.released_today[ Ds[i] ] ) {
        k.innerHTML += '<td style="color:green;" class="click" onclick="_check=\'released_today\';search(\''+Ds[i]+'\');">' +
                       (j.released_today[ Ds[i] ] || []).length + '</td>';
      } else {
        k.innerHTML += '<td style="color:green;">&ndash;</td>';
      }
      k.id = Ds[i];
      districtTable.appendChild(k);
      k = document.createElement('p');
      if (j.latest_added && j.latest_added[ Ds[i] ] ) {
        k.innerHTML = '<span style="color:black;"><strong onclick="_check=\'latest_added\';search(this.textContent);"' +
                      ' class="click _L">' + Ds[i] + '</strong> ' + _today + '涉及' +
                      (j.today[ Ds[i] ] || []).length +
                      '个地址，下列' + j.latest_added[ Ds[i] ].length +
                      '个地址不同于之前一日</span><br/>' + j.latest_added[ Ds[i] ];
      } else {
        k.innerHTML = '<span style="color:black;"><strong onclick="_check=\'today\';search(this.textContent);"' +
                      ' class="click _L">' + Ds[i] + '</strong> ' + _today + '涉及' +
                      (j.today[ Ds[i] ] || []).length +
                      '个地址</span>';
      }
      latest_added.appendChild(k);
      k = document.createElement('p');
      if (j.released_today && j.released_today[ Ds[i] ] ) {
        k.innerHTML = '<span style="color:black;" onclick="_check=\'released_today\';search(this.textContent);"' +
                      ' class="click _L">' + Ds[i] + '</span>: ' + j.released_today[ Ds[i] ];
      } else {
        k.innerHTML = '<span style="color:black;">' + Ds[i] + ':</span> 无';
      }
      latest_released.appendChild(k);
      k = document.createElement('p');
      k.innerHTML = '<span style="color:black;" onclick="_check=\'released\';search(this.textContent);"' +
                    ' class="click _L">' + Ds[i] + '</span>: ' + j.released[ Ds[i] ];
      released.appendChild(k);
    }
    map = document.getElementById('app').getContext('2d');
    if (window.location.toString().indexOf('?') > -1) {
      if (hash2.indexOf('$') > -1) {
        scaleChange = false;
        const scc = hash2.split('$')[1].split('=')[0].split('_');
        d3scale = parseInt(scc[0]);
        d3center = [parseFloat(scc[1]), parseFloat(scc[2])];
        k = hash2.split('$')[0];
      } else {
        k = hash2;
      }
      search(k);
    } else if (autoSavePNG) {
      exportCanvasAsPNG();
    }
  }

  function draw_sh () { // map-address.html
    app.width = svgWidth;
    app.height = svgHeight;
    app.style.display = 'block';
    app.style.padding = '5px 0 2px 0';
    const jj = JSON.parse(sh);
    const dt = topojson.feature(jj, jj.objects.collection);
    const dn = topojson.neighbors(jj.objects.collection.geometries);
    const pj = d3.geo.mercator(
                ).scale(d3scale).center(d3center
                ).translate([svgWidth/2, svgHeight/2]);
    const pg = d3.geo.path().projection(pj).context(map);
    map.strokeStyle = 'grey';
    map.font = fontSize + 'px Microsoft YaHei';
    dt.features.forEach(d => {
      // let xx = new Array(), yy = new Array();
      // let xx_raw = new Array(), yy_raw = new Array();
      // let xx_max, yy_max, xxx, yyy;
      // if (d.properties.name === addr.value) {
      //   //console.log(d);
      //   console.log(d.properties.name, svgWidth, 'x', svgHeight,
      //              'current scale', d3scale );
      //   let dd
      //   if (d.geometry.type === 'MultiPolygon') {
      //     dd = d.geometry.coordinates[0][0];
      //     for (i = 1; i < d.geometry.coordinates[0].length; i++) {
      //       dd = [...dd, ...d.geometry.coordinates[0][i] ];
      //     }
      //   } else {
      //     dd = d.geometry.coordinates[0];
      //   }
      //   //console.log(dd);
      //   for (i = 0; i < dd.length; i++) {
      //     xxx = parseFloat(dd[i][0]);
      //     yyy = parseFloat(dd[i][1]);
      //     //console.log(xxx, yyy);
      //     if (inChina(xxx, yyy)) {
      //       xx_raw.push(xxx);
      //       yy_raw.push(yyy);
      //       xx.push(mapX(xxx ));
      //       yy.push(mapY(yyy ));
      //     }
      //   }
      //   // 黄浦区 0.05311649064906021 ~ 72000 ~ 67
      //   xx_max = Math.max.apply(null, xx) - Math.min.apply(null, xx);
      //   // 黄浦区 0.05627040804080252 ~ 72000 ~ 82
      //   yy_max = Math.max.apply(null, yy) - Math.min.apply(null, yy);
      //   console.log('    suggested centers', mapX(average(xx_raw)), mapY(average(yy_raw)),
      //     average(xx_raw), average(yy_raw),
      //     Math.min.apply(null, [
      //       Math.floor(d3scale * svgWidth/xx_max),
      //       Math.floor(d3scale * svgHeight/yy_max) ]) );
      // }
      map.beginPath();
      pg(d);
      if (sh_district7.indexOf(d.properties.name) > -1) {
        map.fillStyle = 'rgba(200,200,200,0.2)'; // d.properties.subFeatureIndex
        map.fill(); // 'nonzero', 'evenodd'
      }
      map.stroke();
      map.textBaseline = 'top';
      map.textAlign = 'start';
      map.fillStyle = 'grey';
      map.fillText(d.properties.name,
                   mapX(d.properties.center[0]),
                   mapY(d.properties.center[1]));
    });
    map.fillStyle = 'blue';
    const cafe0 = JSON.parse(cafe);
    const cafe1 = topojson.feature(cafe0, cafe0.objects.collection);
    cafe1.features.forEach(d => {
      map.beginPath();
      map.fillRect(mapX( d.geometry.coordinates[0] ),
                   mapY( d.geometry.coordinates[1] ),
                   3, 3 );
    });
    map.fillText('已标记精致咖啡馆', 0,2);
    map.fillStyle = 'silver';
    map.fillText('制图 https://teach.bio @the_paper_link', svgWidth-fontSize*18.6,2);
    let dots;
    map.strokeStyle = 'rgba(0,0,255,0.2)';
    map.lineWidth = 6;
    const river0 = JSON.parse(river);
    const river1 = topojson.feature(river0, river0.objects.collection);
    river1.features.forEach(d => {
      dots = d.geometry.coordinates;
      map.beginPath();
      map.moveTo(mapX(dots[0][0]), mapY(dots[0][1]));
      for (i = 1; i < dots.length; i += 1) {
        map.lineTo(mapX(dots[i][0]), mapY(dots[i][1]));
      }
      map.stroke();
    });
    map.strokeStyle = 'rgba(0,0,255,0.3)';
    map.lineWidth = 1.0;
    const line0 = JSON.parse(lines);
    const line1 = topojson.feature(line0, line0.objects.collection);
    line1.features.forEach(d => {
      dots = d.geometry.coordinates;
      map.beginPath();
      map.moveTo(mapX(dots[0][0]), mapY(dots[0][1]));
      for (i = 1; i < dots.length; i += 1) {
        map.lineTo(mapX(dots[i][0]), mapY(dots[i][1]));
      }
      map.stroke();
    });
  }

  function draw_addr (s) {
    let _R = 'rgba(255,0,0,';
    if (_check && _check.substr(0,8) === 'released') {
      _R = 'rgba(17,131,1,';
    }
    if (Ms.indexOf(s) > -1) {
      map.beginPath();
      map.arc(mapX( Ml.locations[s][0] ),
              mapY( Ml.locations[s][1] ),
              3, 0 * Math.PI, 2 * Math.PI);
      if (Ml.locations[s][2]) {
        map.strokeStyle = _R + '1)';
      } else {
        map.strokeStyle = _R + '.75)';
      }
      map.stroke();
    } else {
      dotNotDraw += 1; // 市 区
    }
  }

  function search (k, pngNot) {
    if (!k) {
      addr.value = '';
      addr.focus();
      app.style.display = 'none';
      check_row.style.display = 'none';
      clear_button.style.visibility = 'hidden';
      window.location = baseURL + '#' + j.tag; // #hash
      return;
    }
    if (addr.value !== k) {
      addr.value = k;
    }
    window.location = baseURL + '#' + j.tag + '?' + k;
    document.title = 'sh.teach.bio/2 ? ' + k + '  2022/' + _today;
    map.clearRect(0, 0, svgWidth, svgHeight);
    svgWidth = 640;
    svgHeight = 480;
    fontSize = 10; // 10px Microsoft YaHei
    if (scaleChange) { d3scale = 72000; }
    let ii;
    let map_i = 0;
    if (Ds.indexOf(k) > -1) {
      if (!j.today[k]) { // .latest_added [_check]
        addr.value = '';
        addr.focus();
        app.style.display = 'none';
        check_row.style.display = 'none';
        return;
      }
      // if (k === '崇明区') {
      //   if (scaleChange && d3scale < 32000) {
      //     d3scale = 32000; }
      // } else if (k === '黄浦区') {
      //   if (scaleChange && d3scale < 192000) {
      //     d3scale = 192000; }
      // } else if (sh_district7.indexOf(k) > -1) {
      //   if (scaleChange && d3scale < 128000) {
      //     d3scale = 128000; }
      // }
      if (scaleChange || (hash2 && hash2.indexOf(k) !== 0) ) {
        d3scale = centers[k][2]; }
      d3center = [centers[k][0], centers[k][1] ];
      draw_sh();
      if (j[_check][k]) {
        for (ii = 0; ii < j[_check][k].length; ii += 1) { // .today
          draw_addr(k + j[_check][k][ii]);
        }
      }
      check_row.style.display = 'block';
      updateCheckStatus();
      map.fillStyle = 'black';
      if (dotNotDraw) {
        map.fillText(k + j[_check][k].length + '个地址 其中' + dotNotDraw + '个无法显示 2022/' + _today,
                     0,svgHeight-1-fontSize);
        dotNotDraw = 0;
      } else if (j[_check][k]) {
        map.fillText(k + ' ' + j[_check][k].length + '个地址 2022/' + _today,
                     0,svgHeight-1-fontSize);
      }
      save_button.scrollIntoView();
      clear_button.style.visibility = 'visible';
      if (autoSavePNG && !pngNot) {
        exportCanvasAsPNG();
      }
      return;
    } else if (k === '上海市') {
      svgWidth = 1250;
      svgHeight = 1000;
      fontSize = 14;
      d3center = [centers['黄浦区'][0], centers['黄浦区'][1] ];
      if (d3scale < 48000) {
        d3scale = 48000; }
      if (!scaleChange && (hash2 && hash2.indexOf(k) !== 0) ) {
        reload_button.textContent = '重置可以查看全市';
        reload_button.style.fontWeight = 'bold';
        setTimeout(
          function () {
            reload_button.textContent='重置';
            reload_button.style.fontWeight = 'normal';
          },
          1000*5
        );
      }
      draw_sh();
      for (i = 0; i < Ds.length; i += 1) {
        if (!j[_check][Ds[i] ]) {
          continue;
        }
        for (ii = 0; ii < j[_check][ Ds[i] ].length; ii += 1) {
          draw_addr(Ds[i] + j[_check][ Ds[i] ][ii]);
          map_i += 1;
        }
      }
      check_row.style.display = 'block';
      updateCheckStatus();
      map.fillStyle = 'black';
      if (dotNotDraw) {
        map.fillText('上海市' + map_i + '个地址 未显示其中' + dotNotDraw + '个 2022/' + _today,
                     0,svgHeight-1-fontSize);
        dotNotDraw = 0;
      } else {
        map.fillText('上海市 ' + map_i + '个地址 2022/' + _today,
                     0,svgHeight-1-fontSize);
      }
      save_button.scrollIntoView();
      clear_button.style.visibility = 'visible';
      if (autoSavePNG && !pngNot) {
        exportCanvasAsPNG();
      }
      return;
    }
    console.log('Input', k);
    auto_save_off();
    if (k.indexOf('=') > -1) {
      k = k.split('=')[0];
      addr.value = k;
      _check = check_choices['0'];
    }
    check_row.style.display = 'none';
    onList.textContent = '';
    for (ii = 0; ii < Ds.length; ii += 1) {
      document.getElementById(Ds[ii]).style.background = 'white';
      document.getElementById(Ds[ii] + 'line').textContent = '';
      th_k.textContent = '';
    }
    let dl; let kk; let ks; let sb = 0;
    let map_push;
    let map_x = new Array();
    let map_y = new Array();
    let map_addr = new Array();
    for (i = 0; i < As.length; i += 1) {
      if (As[i].indexOf(k) > -1) {
        dl = j.address[ As[i] ];
        let ij; let ik; let il = 0; let release;
        for (ii = 0; ii < Ds.length; ii += 1) {
          ij = j.districts[ Ds[ii] ];
          for (ik = 0; ik < ij.length; ik += 1) {
            if (ij[ik] === As[i]) {
              document.getElementById(Ds[ii]).style.background = 'yellow';
              document.getElementById(Ds[ii] + 'line').textContent += '|';
              //console.log(Ds[ii]);
              il += 1;
              sb += 1;

        //onList.textContent += Ds[ii] + ',' + As[i] + ': ' + dl;
        if (sb < 10) {
          ks = '<span style="color:grey;"><span style="color:white;">0</span>' + sb + '.</span> <span>';
        } else {
          ks = '<span style="color:grey;">' + sb + '.</span> <span>';
        }
        ks += '<span class="click" onclick="search(this.textContent);">' + Ds[ii] + '</span>';
        if (map_i > 1 || lastSearch) {
          ks += '<span class="click _L" onclick="lastSearch=\''+k+'\';search(\'';
        } else {
          ks += '<span onclick="lastSearch=\''+k+'\';search(\'';
        }
        if (lastSearch && lastSearch !== As[i] && As[i].indexOf(lastSearch) > -1) {
          ks += lastSearch;
        } else {
          ks += As[i];
        }
        ks += '\');">' + As[i] + '</span> ';
        if (Ms.indexOf(Ds[ii] + As[i]) > -1) {
          map_push = 1;
          map_i += 1;
        }  else {
          map_push = 0
          dotNotDraw += 1; // 地址
        }
        const s1 = ('' + dl).split(Ds[ii]);
        const s2 = s1[s1.length - 2];
        if (il === 1 || !s2) { // 地址同名, 团结村 国权北路555
          if (('' + dl).indexOf(j.tag) > 0) {
            if (map_push) { map_push = 2; }
            ks += '<span style="color:red">' + tagsHTML(dl) + '</span>';
          } else {
            ks += tagsHTML(dl);
          }
          release = parseInt(dl[dl.length - 1]);
        } else {
          ks += s2.substr(s2.lastIndexOf(',') + 1);
          release = parseInt( s2.substr(s2.lastIndexOf(',') + 1) );
        }
        if (map_push === 1) {
          map_x.push(parseFloat( Ml.locations[Ds[ii] + As[i]][0] ));
          map_y.push(parseFloat( Ml.locations[Ds[ii] + As[i]][1] ));
          map_addr.push( Ds[ii] + As[i] );
        } else if (map_push === 2) {
          map_x.unshift(parseFloat( Ml.locations[Ds[ii] + As[i]][0] ));
          map_y.unshift(parseFloat( Ml.locations[Ds[ii] + As[i]][1] ));
          map_addr.unshift( Ds[ii] + As[i] );
        }
        release += (14 - 300);
        if (release > 100) {
          release -= 100;
        } else if (release > 31) {
          release -= 31; // 单次3月18日的地址
        }
        if (release < 31) {
          //onList.textContent += ' --> 4/' + release + '\n';
          ks += ' &rarr; 4/' + release;
          ks += ' <span style="color:green">已满14天</span></span>';
        } else {
          if (release > 100) { // 最近一次在5月
            release -= 100;
          } else {
            release -= 30;
          }
          ks += ' &rarr; 5/' + release;
          if (release < today.getDate()-1 ) {
            ks += ' <span style="color:green">已满14天</span></span>';
          } else if (release === today.getDate()-1 ) {
            ks += '<span style="color:green">是第14天</span></span>';
          } else {
            ks += '</span>';
          }
        }
        let kk = document.createElement('p');
        //kk.id = As[i];
        kk.style.padding = '0';
        kk.style.margin = '0';
        kk.innerHTML = ks;
        onList.appendChild(kk);

            }
          }
        }
      }
    }
    if (map_i === 0) {
      app.style.display = 'none';
      check_row.style.display = 'none';
    } else {
      addr.scrollIntoView();
      th_k.textContent = k;
      if (!d3center || scaleChange) {
        d3center = [average(map_x), average(map_y) ];
      }
      let d3scale_;
      const map_XYlarge = Math.max.apply(null, [
        Math.max.apply(null, map_x) - Math.min.apply(null, map_x),
        Math.max.apply(null, map_y) - Math.min.apply(null, map_y) ]);
      // 黄浦区 0.0531 ~ 192000
      d3scale_ = parseInt(0.0531/map_XYlarge * 200000);
      //console.log('scale max', d3scale_);
      let map_XYtest = svgWidth;
      let map_XYzero;
      for (ii = 1; ii < map_i; ii += 1) {
        for (i = ii; i < map_i; i += 1) {
          map_XYzero = Math.sqrt(
            Math.pow((mapX(map_x[i])-mapX(map_x[i-ii])), 2) +
            Math.pow((mapY(map_y[i])-mapY(map_y[i-ii])), 2) );
          if (map_XYzero) {
            map_XYtest = Math.min.apply(null, [map_XYtest, map_XYzero]);
          }
        }
      }
      // .arc(3) 0.0004325 ~ 589318
      d3scale_ = Math.max.apply(null, [72000, d3scale_, Math.floor(d3scale_ * 3/map_XYtest )]);
      //console.log('scale min',
      //            Math.floor(d3scale_ * 3/map_XYtest ), ', used', d3scale_);
      console.log('Found',
                  k, scaleChange, '更新前', d3scale, '计算值', d3scale_);
      if (scaleChange && map_i < 100 && map_i > 1) {
        d3scale = d3scale_;
      }
      if (!scaleChange && d3scale > d3scale_) {
        reload_button.textContent = '重置可以展示所有地点';
        reload_button.style.fontWeight = 'bold';
        setTimeout(
          function () {
            reload_button.textContent='重置';
            reload_button.style.fontWeight = 'normal';
          },
          1000*10
        );
      }
      draw_sh();
      for (i = 0; i < map_i; i += 1) {
        draw_addr(map_addr[i]);
      }
      map.fillStyle = 'rgba(255,0,0,0.4)';
      let gray_Y = [mapY(map_y[0]), 0,2];
      let gray_dis = new Array();
      map.fillText(map_addr[0],
                   mapX(map_x[0]) + 3, gray_Y[0]);
      if (map_i > 1) {
        let labelNotDraw;
        let _Y;
        gray_dis = [ map_addr[0].substr(0,3) ];
        let _dis = '';
        for (i = 1; i < map_i; i += 1) {
          labelNotDraw = false;
          _Y = mapY(map_y[i]);
          for (ii = 0; ii < gray_Y.length; ii += 1) {
            if (Math.abs(_Y - gray_Y[ii]) < fontSize+2) {
              labelNotDraw = true;
              break;
            }
          }
          if (!labelNotDraw) {
            gray_Y.push(_Y);
            _dis = map_addr[i].substr(0,3);
            if (gray_dis.indexOf(_dis) > -1) {
              if (_dis === '浦东新') {
                map.fillText(map_addr[i].substr(4),
                           mapX(map_x[i]) + 3, _Y);
              } else {
                map.fillText(map_addr[i].substr(3),
                           mapX(map_x[i]) + 3, _Y);
              }
            } else {
              gray_dis.push(_dis);
              map.fillText(map_addr[i],
                           mapX(map_x[i]) + 3, _Y);
            }
          }
        }
      }
      map.fillStyle = 'red';
      if (dotNotDraw) {
        map.fillText('【' + k + '】' + (map_i + dotNotDraw) +
                     '个地址 显示了其中' + map_i + '个 2022/' + _today,
                     0,svgHeight-1-fontSize);
        dotNotDraw = 0;
      } else {
        map.fillText('【' + k + '】' + map_i + '个地址 2022/' + _today,
                     0,svgHeight-1-fontSize);
      }
    }
    if (sb === 0) {
      addr.focus();
      search_button.textContent = '无结果，可输入再搜';
      setTimeout(
        function () {
          search_button.textContent='搜索';
        },
        1000*5
      );
    } else {
      search_button.textContent = '查到' + sb + '个地址，可输入再搜';
      setTimeout(
        function () {
          search_button.textContent='搜索';
        },
        1000*5
      );
      clear_button.style.visibility = 'visible';
    }
  }

  function show_full (item) {
    const t = document.getElementById(item).getAttribute('data-value');
    if (t === "1") {
      document.getElementById(item).style.display = 'block';
      if (document.getElementById(item + '_once')) {
        document.getElementById(item + '_once').style.visibility = 'hidden';
      }
      document.getElementById(item).setAttribute('data-value', "0");
    } else {
      document.getElementById(item).style.display = 'none';
      document.getElementById(item).setAttribute('data-value', "1");
    }
  }

  function auto_save_off () {
    autoSavePNG = false;
    auto_save_status.style.boxShadow = '';
    pre_button.style.border = '';
    next_button.style.border = '';
  }

  function updateCheckStatus () {
    const checkboxes = document.getElementsByName('check');
    checkboxes.forEach((item) => {
      if (_check === check_choices[item.getAttribute('data-value')] ) {
        item.checked = true;
      } else {
        item.checked = false;
      }
    });
  }

  // https://stackoverflow.com/questions/9709209/
  function onlyOne (I) {
    const checkboxes = document.getElementsByName('check');
    checkboxes.forEach((item) => {
        if (item !== I) item.checked = false;
    });
    _check = check_choices[I.getAttribute('data-value')];
    //console.log('data-value >', _check, j[_check]);
    search(addr.value, true);
  }
  </script>
  <style>
    body {background-color: white;}
    p {line-height: 1.5em;}
    .click,
    button,
    label>input,
    #auto_save_status {
      cursor: pointer;
    }
    button {padding-top: .2em;}
    ._L {
      padding: 0 .2em;
      box-shadow: inset 0 -.5em #d0d0d0;
      border: 0;}
    #th_k {
      text-align: left;
      box-shadow: inset 0 .5em yellow;
    }
    #check_row {font-size: 75%}
    #check_row label {
      display: inline-block;
      padding-right: 10px;
      padding-left: 22px;
      text-indent: -22px;
    }
    #check_row input,
    #check_row label>span {
      vertical-align: middle;
    }
  </style>
</head>
<body onload="load_js();">
  <p>
    更新时间 <span id="datestr" style="color:blue;">fetching<span id="loading_span"></span> not ready</span><br/>
    数据来源 <a href="https://wsjkw.sh.gov.cn/xwfb/index.html" target="_blank">公众号 shanghaifabu</a> <span id="shanghaifabu"></span><br/>
    本页为<span style="background-color:yellow;">2022年<span id="tag_m"></span>月<span id="tag_d"></span>日</span>的数据
    &nbsp;(<span class="click" id="april_button" onclick="jumpApr(addr.value);">跳至 4/</span>
    <input class="_L" type="text" id="april" name="april" size=2 onkeydown="aprilEnter();" />
    )
    <br/>搜索<span onclick="search(this.textContent);" class="click _L">上海市</span> 可以在地图中展示全市上榜地址

  </p>
  <p>
    <label for="addr">上榜地址</label>
    <input type="text" id="addr" name="addr" onkeydown="last_search=false;addrEnter();" />
    <button id="search_button" onclick="scaleChange=true;last_search=false;search(addr.value);">搜索</button>
  </p>

  <button id="save_button" onclick="exportCanvasAsPNG();">存图</button>
  <button onclick="preReload(addr.value,1);">&lt;&lt;</button>
  <button id="pre_button" onclick="preReload(addr.value);">&lt;</button>
  <span id="auto_save_status" class="_tag">/</span>
  <button id="next_button" style="visibility:hidden;" onclick="nextReload(addr.value);">&gt;</button>
  <button onclick="nextReload(addr.value,1);">&gt;&gt;</button>
  <button id="clear_button" style="visibility:hidden;" onclick="search();">隐藏</button>
  <button id="reload_button" onclick="window.location.reload();">重置</button><br/>
  <canvas id="app" style="display:none;"></canvas>
  <!-- 3.district 2.inB 0.today 4.released 5.released_today 1.latest_added -->
  <div id="check_row" style="display:none;">
    <label><span>2022年 3月18日 至
             <span id="tag_m2"></span>月<span id="tag_d2"></span>日
           </span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="1" /><span style="color:red">比昨日多</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="0" /><span style="color:red">当日阳</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="2" /><span style="color:red">两周阳</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="3" /><span style="color:red">累计阳</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="4" /><span style="color:green">累计下榜</span></label>
    <label><input type="checkbox" name="check" onclick="onlyOne(this)"
      data-value="5" /><span style="color:green">当日下榜</span></label>
  </div>

  <div style="width:100%;color:blue;" id="onList"></div>

  <h2><span onclick="search(this.textContent);" class="click">上海市</span>各区统计（地址数）</h2>
  <table id="districtTable" style="border:1px solid blue;color:blue;font-size:75%;text-align:center;">
    <tr style="color:black;"><th>行政单位</th><th>累计上榜</th><th id="th_k"></th><th>两周内</th><th><span class="_tag"></span>涉及</th>
      <th>累计下榜</th><th><span class="_tag"></span>下榜</th></tr>
  </table>

  <h2 onclick="show_full('latest_added');" style="color:red;" class="click _L">值得关注的地址</h2>
  <div style="color:red;list-style-type:none;font-size:75%;" id="latest_added"></div>

  <h2 onclick="show_full('latest_released');" class="click _L"><span class="_tag"></span>下榜的地址<i id="latest_released_once" style="color:grey;">点击显示</i></h2>
  <div style="color:green;list-style-type:none;font-size:75%;display:none;" id="latest_released" data-value="1"></div>

  <h2 onclick="show_full('released');" class="click _L">累计下榜的地址<i id="released_once" style="color:grey;">点击显示</i></h2>
  <div style="color:green;list-style-type:none;font-size:75%;display:none;" id="released" data-value="1"></div>

  <pre id="end_pre" style="color:grey">EOF</pre>
</body>
</html>
